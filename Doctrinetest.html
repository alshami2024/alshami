
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿßŸÖÿ™ÿ≠ÿßŸÜ ÿßŸÑÿπŸÇŸäÿØÿ© (1)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0056b3; --secondary-color: #007bff; --light-gray: #f8f9fa; --dark-gray: #343a40; --success-color: #28a745; --danger-color: #dc3545; --background-color: #e9ecef; --text-color: #212529; --white: #fff; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--background-color); margin: 0; padding: 20px; color: var(--text-color); direction: rtl; }
        .container { background-color: var(--white); border-radius: 15px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); width: 95%; max-width: 900px; margin: 0 auto; padding: 30px; }
        h1, h2, h3 { color: var(--dark-gray); font-weight: 700; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input[type="text"], .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { background-color: var(--primary-color); color: var(--white); border: none; padding: 12px 25px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .btn:hover { background-color: #004a99; } .btn:disabled { background-color: #ccc; }
        .btn-danger { background-color: var(--danger-color); }
        .exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .timer { font-size: 1.2em; color: var(--danger-color); font-weight: bold; }
        .question-card { background: var(--light-gray); border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: right; }
        .question-card ul { list-style: none; padding: 0; }
        .choices li { padding: 10px; margin: 8px 0; background: var(--white); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .choices li:hover { background-color: #e3f2fd; }
        .choices li.correct { background-color: #d4edda !important; border-color: #c3e6cb; }
        .choices li.incorrect { background-color: #f8d7da !important; border-color: #f5c6cb; }
        .essay-answer { width: 100%; min-height: 120px; resize: vertical; margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #navigation-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        #progressBarContainer { width: 100%; background-color: #e9ecef; border-radius: 20px; margin-bottom: 25px; overflow: hidden; }
        #progressBar { width: 0%; height: 20px; background-color: var(--success-color); border-radius: 20px; transition: width 0.5s; text-align: center; color: white; line-height: 20px; }
        #certificate { display: none; border: 5px solid var(--primary-color); padding: 30px; margin-top: 30px; text-align: center; background: linear-gradient(135deg, #f9f9f9, #eef8ff); }
        #startScreen, #examArea, #resultContainer, #savingResultsScreen { display: none; }
        .saving-screen { text-align: center; padding: 50px; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
    </style>
</head>
<body>
<div class="container">
    <div id="studentExamView" style="display:block;">
        <div id="startScreen" style="display:block;">
            <h1 id="examTitleStudent"></h1>
            <p id="examDescriptionStudent" style="white-space: pre-wrap;"></p>
            
        <div class="form-group">
            <label for="studentName">ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÉÿßŸÖŸÑ</label>
            <input type="text" id="studentName" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
        </div>
        
    
            <button id="startExamBtn" class="btn">ÿ®ÿØÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</button>
        </div>
        <div id="examArea">
            <div class="exam-header"><h2 id="welcomeStudent"></h2><div id="timer" class="timer"></div></div>
            <div id="progressBarContainer"><div id="progressBar"></div></div>
            <div id="questionsContainer"></div>
            <div id="navigation-buttons"></div>
            <button id="finishExamBtn" class="btn btn-danger" style="margin-top: 20px; width:100%;">ÿ•ŸÜŸáÿßÿ° Ÿàÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</button>
        </div>
        <div id="savingResultsScreen" class="saving-screen">
            <div class="spinner"></div>
            <h3>ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ...</h3>
            <p>ÿßŸÑÿ±ÿ¨ÿßÿ° ÿπÿØŸÖ ÿ•ÿ∫ŸÑÿßŸÇ Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ©.</p>
        </div>
        <div id="resultContainer">
             <h2 id="resultTitle"></h2><p id="resultSummary"></p>
             <div id="reviewContainer"></div>
             <div id="certificate">
                <h2>ÿ¥ŸáÿßÿØÿ© ÿ•ÿ™ŸÖÿßŸÖ</h2><p>ÿ™ÿ¥ŸáÿØ Ÿáÿ∞Ÿá ÿßŸÑÿ¥ŸáÿßÿØÿ© ÿ®ÿ£ŸÜ ÿßŸÑÿ∑ÿßŸÑÿ®/ÿ©:</p><h3 id="certName"></h3>
                <p>ŸÇÿØ ÿ£ÿ™ŸÖ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠ Ÿàÿ≠ÿµŸÑ/ÿ™ ÿπŸÑŸâ ÿØÿ±ÿ¨ÿ©:</p><h3 id="certScore"></h3>
                <p>ÿ®ÿ™ÿßÿ±ŸäÿÆ: <span id="certDate"></span></p>
            </div>
        </div>
    </div>
</div>
<script>
    const encodedExamData = 'ZXlKamIyNW1hV2NpT25zaWRHbDBiR1VpT2lMWXA5bUYyS3JZcmRpbjJZWWcyS2ZaaE5pNTJZTFppdGl2MktrZ0tERXBJaXdpWkdWelkzSnBjSFJwYjI0aU9pTFlxdGlzMkxIWml0aW8yWW9pTENKemRHRnlkRlJwYldVaU9pSWlMQ0psYm1SVWFXMWxJam9pSWl3aWJHRjViM1YwSWpvaWIyNWxMV0o1TFc5dVpTSXNJblJwYldVaU9qRTFMQ0p6YUhWbVpteGxJanAwY25WbExDSnViMGR2YVc1blFtRmpheUk2ZEhKMVpTd2laR2x6WVdKc1pVTm9aV0YwYVc1bklqcDBjblZsTENKdGIyNXBkRzl5VkdGaWN5STZkSEoxWlN3aVptbHVhWE5vVDI1VGQybDBZMmdpT21aaGJITmxMQ0pzWldGeWJtbHVaMDF2WkdVaU9tWmhiSE5sTENKemFXNW5iR1ZWYzJWTmIyUmxJanBtWVd4elpTd2ljMmh2ZDFKbGMzVnNkSE1pT25SeWRXVXNJbVZ1WVdKc1pWSmxkbWxsZHlJNlptRnNjMlVzSW1WdVlXSnNaVU5sY25ScFptbGpZWFJsSWpwMGNuVmxMQ0owYUdWdFpTSTZJbVJsWm1GMWJIUWlMQ0p6ZFdOalpYTnpVR1Z5WTJWdWRHRm5aU0k2TlRBc0ltSnZkRlJ2YTJWdUlqb2lWVEpHYzJSSFZtdFlNUzl0WWtwWlF6aDJabWxaSzJSU1ZVVjBWVmxaVUVNclZIZGpaVVpETXpSNlpEZEJZbWN4VFhKU2VEVk5NemN2WlN0VWNYQlBaRTFLT1RGeGEwNDJjRUZSZGtRd1ZHOU9SaloxSzNjOVBTSXNJbU5vWVhSSlpDSTZJbFV5Um5Oa1IxWnJXREU0TWxVMU5HVTRVVlp0U21sTFpVcGhablZOVW1sUU5XRlRVM2h3VUhRd1pFazlJaXdpWjJsMGFIVmlWRzlyWlc0aU9pSlZNa1p6WkVkV2ExZ3hPR1ZuWkRjM1dVZFNiRU5qZFVJNFJtbENZVTQxTkVRMVJtazBRV0k0T0VGT056ZEpXVWc1YVVNM2IxVkpRVGh5WnpCVVIwcFRTMGRJTm5kNFlVWk9SbEF3YjJscmRXUkxhekZtUVQwOUlpd2ljbVZ6ZFd4MGMwWnBiR1Z1WVcxbElqb2lkR1Z6ZEd4aGR5NXFjMjl1SWl3aVlXTmpaWE56UTI5dWRISnZiQ0k2ZXlKbGJtRmliR1ZrSWpwbVlXeHpaU3dpYzNSMVpHVnVkSE1pT2x0ZGZYMHNJbkYxWlhOMGFXOXVjeUk2VzNzaWRHVjRkQ0k2SXRpajJZclprU0RZdWRpbzJLZllzZGlwSU5pcTJZL1poTml1MlpIWXRTRFl1ZG1FMktmWmd0aXBJTmluMllUWXVkbUMyWVFnMktqWXA5bUUyWWJaZ3RtRUlDallwOW1FMkxQWmhkaTVLU0RaZ2RtS0lOaW4yWVRaaGRpNTJMSFpnZGlwSU5pbjJZVFl1ZG1DMksvWml0aXAySjhpTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZcDltRTJMblpndG1FSU5pajJMWFpoQ0RaaE5pbklObUsyS3ZZcU5pcUlOaW8yWWNnMkxUWml0aWhJTm1GMllZZzJLZlpoTm1HMllMWmhDNGlMQ0xZcDltRTJMUFpoZGk1SU5tSzJZUFpnZG1LSU5tSTJLM1lyOW1ISU5tRTJZVFl1ZG1FMllVZzJLZlpoTm1HMkxqWXNkbUtJTmlsMkxEWXB5RFl0ZGl2MllJZzJLZlpoTm1HMktmWmd0bUVMaUlzSXRpbjJZVFl1ZG1DMllRZzJLUFl0ZG1FSU5tSTJLZlpoTml6MllYWXVTRFpoZG1EMllYWmtkbUVJTml0MllyWXF5RFpoTmluSU5tSzJMUFlxdG1DMllRZzJLZlpoTmk1MllMWmhDRFlxTmluMllUWXJkbUQyWVV1SWl3aTJLZlpoTml6MllYWXVTRFppdGl6MktqWmdpRFlwOW1FMkxuWmd0bUVJTm1CMllvZzJLZlpoTmlsMkt2WXFOaW4yS29nMllqWmhOaW5JTm1LMkszWXF0aW4yS3dnMktYWmhObUpJTml2MllUWml0bUVJTmk1MllMWmhObUtMaUpkTENKamIzSnlaV04wUVc1emQyVnlJam95ZlN4N0luUmxlSFFpT2lMWmdkbUsyWVhZcHlEWml0aXEyTG5aaE5tUjJZSWcyS2pZcU5peDJZZllwOW1HSU5pbjJZVFlyZGl2MllqWXF6b2cyS1BaaXRtUklObUcyS3JaaXRpczJLa2cyWVhaaHRpMzJZTFppdGlwSU5pcTJLcllzZGlxMktnZzJLWFlzTmluSU5tQzJZL1lxTm1FMktvZzJLZlpoTm1CMkxIWXR0bUsyS2tnWENMWXA5bUUyTG5ZcDltRTJZVWcySzNZcDlpdjJLdGNJdGlmSUNJc0luUjVjR1VpT2lKdFkzRWlMQ0pqYUc5cFkyVnpJanBiSXRpajJZWWcyS2ZaaE5pcTJMUFpoTml6MllRZzJZSFppaURZcDltRTJMblpoTm1FSU5tRjJZWFpnOW1HSU5tSTJZVFlweURaaXRtSTJLellxQ0RaaGRpbzJLL1lveURZbzltSTJZUXVJaXdpMktQWmhpRFlwOW1FMkxuWXA5bUUyWVVnMllMWXI5bUsyWVVnMllqWXFOaW4yWVRZcXRpbjJZVFppaURaaE5pbklObUsySzNZcXRpbjJLd2cyS1haaE5tSklObUYyWWpZck5pdkxpSXNJdGlqMllZZzJZallyTm1JMks4ZzJLZlpoTmk1MktmWmhObUZJTm1LMlliWXF0bUIyWW9nMktqWmhkaXMyTEhaa2RpdklOaWwyS3ZZcU5pbjJLb2cyS2ZaaE5pdzJMSFprZGluMktvdUlpd2kyS1BaaGlEWmhObUQyWVFnMkszWXA5aXYyS3NnMllYWXJkaXYyS3ZaaTlpbjJJd2cyWUhaaE5pbjJLallyeURaaGRtR0lObUYySzNZcjlpcklObUMySy9aaXRtRklObUUyWXJZc3lEWXFOaXQyS2ZZcjlpckxpSmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3pmU3g3SW5SbGVIUWlPaUxZbzltSzJaRWcyS2ZZczlpcTJZYllxdGluMkt3ZzJZcll1ZG1EMkxNZzJLZlpoTmluMkxQWXF0aXYyWVRZcDltRUlOaW8yS2ZaaE5paTJZcllxU0JjSXRpMDJZZllyeURZcDltRTJZVFpoeURZbzltRzJZY2cyWVRZcHlEWXBkbUUyWWNnMktYWmhOaW5JTm1IMllnZzJZalpndGluMktiWmhkbUwyS2NnMktqWXA5bUUyWUxZczlpM1hDTFlueUFpTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZcDltRTJMSFlxTmkzSU5tSzJLL1poQ0RZdWRtRTJZa2cyS1BaaGlEWXA5bUUyS1hZczltRTJLZlpoU0RZck5tRjJMa2cyS2paaXRtR0lOaW4yWVRZcXRtSTJLM1ppdGl2SU5tSTJLZlpoTmk1MksvWmhDRFppTmlqMllZZzJZUFpoTmluMllmWmhkaW5JTmlqMkxYWmhDRFlwOW1FMksvWml0bUdMaUlzSXRpbjJZVFlvdG1LMktrZzJLcllyOW1FSU5pNTJZVFppU0RZbzltR0lOaW4yWVRZdWRpdjJZUWcyWVhaaHRtQjJMWFpoQ0RZdWRtR0lOaW4yWVRZcXRtSTJLM1ppdGl2SU5tSTJMclppdGl4SU5pMjJMSFppTml4MllvZzJZVFpoTml2MllyWmhpNGlMQ0xZcDltRTJMbllyOW1FSU5tRjJZTFlyOW1GSU5pNTJZVFppU0RZcDltRTJLclppTml0MllyWXJ5RFpnZG1LSU5pcTJLM1lyOW1LMks4ZzJZWFl1ZG1HMllrZzJLZlpoTmlsMkxQWmhOaW4yWVV1SWl3aTJLZlpoTmlpMllyWXFTRFlxdG1FMllYWmtkaXRJTmlsMllUWmlTRFlvOW1HSU5pbjJZVFlxdG1JMkszWml0aXZJTm1FMllyWXN5RFl1ZG1FMllYWmk5aW5JTmlvMllRZzJZWFlyTml4Mks4ZzJZTFppTm1FSU5pMDJLZllwdGk1TGlKZExDSmpiM0p5WldOMFFXNXpkMlZ5SWpvd2ZTeDdJblJsZUhRaU9pTFlwZGl3MktjZzJMSFlvOW1KSU5tQjJMSFppdG1DSU5pajJZWWdYQ0xZcDltRTJMUFpoZGk1SU5tRTJLY2cyWXJZcTlpbzJLb2cyS1haaE5pbklOaW8yTG5ZcnlEWXA5bUUyTG5aZ3RtRVhDTFlqQ0RaZ2RpbzJLUFppaURaaGRtSTJZTFpnZG1OSU5pNTJZWFpoTm1LMlpIWmpTRFpoZG1HSU5pcTJLUFppTm1LMllRZzJZYll0ZG1JMkxVZzJZWFlxOW1FSUh2Wml0aXZJTmluMllUWmhObUhJTm1CMllqWmdpRFlvOW1LMksvWml0bUgyWVY5SU5pejJZclpodGlxMllmWml0aWZJQ0lzSW5SNWNHVWlPaUp0WTNFaUxDSmphRzlwWTJWeklqcGJJdG1LMllMWXNkaXhJTmlqMllZZzJLZlpoTmk1MllMWmhDRFlxTmluMkxmWmhDRFpoTmlqMllZZzJLZlpoTm1HMkxVZzJLUFpndGl2MllVZzJZWFpoaURZcDltRTJMblpndG1FTGlJc0l0bUsyS3ZZcU5pcUlOaW4yWVRaaXRpdklObUQyTG5ZdHRtSUlOaWwyWVRaaDltS0lObUUyS1BaaGlEWXA5bUUyWWJZdFNEWXRkaXgyWXJZclM0aUxDTFppdGlxMkt6WXA5bUgyWVFnMktmWmhObUcyTFVnMllqWml0bUMyTEhZcE5tSElOaXQyTEhaZ2RtSzJZdllweTRpTENMWml0aWsyWWpaaE5tSElOaW8ySzNaaXRpcklObUsyWS9ZcmRtRjJZN1poQ0RZdWRtRTJZa2cyWVhZdWRpbjJZYlpqU0RZdWRtQzJZVFppdGlwSUNqWXA5bUUyWXJZcnlBOUlOaW4yWVRaZ3RpdjJMSFlxU2tnMkszWmdkaW4yTGpaaTlpbklOaTUyWVRaaVNEWXRkaXQyS2tnMktmWmhOaTUyWUxaaEM0aVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk0zMHNleUowWlhoMElqb2kyWUhaaWlEWmd0aTIyWXJZcVNEWXA5bUUyTFhaZ2RpbjJLbzZJTmlsMkxEWXB5RFlwOWlxMlpIWmo5aXUyTEFnMllYWmlObUMyWUVnMktmWmhObUIyWVRZcDlpejJZSFlxU0RZcDltRTJZTFlwOWltMllRZ1hDTFlwOW1FMkxYWmdkaW4yS29nMllUWml0aXoyS29nMkt2WXFObUkyS3JaaXRpcFhDSWcyWUhZcGRtR0lOaWoyWUxaaU5tSklOaWoyS3ZZc2RtTklObUYyWWJZdDltQzJZb2cyWVRaaDlpdzJLY2cyS2ZaaE5tRjJZalpndG1CSU5tSDJZZzZJQ0lzSW5SNWNHVWlPaUp0WTNFaUxDSmphRzlwWTJWeklqcGJJdGlsMkt2WXFOaW4yS29nMktQWmhpRFlwOW1FMllUWmh5RFppdGkwMktqWmh5RFlwOW1FMllYWXJ0bUUyWWpaZ3RpbjJLb2cyWUhaaWlEWXA5bUUyTFhaZ2RpbjJLb3VJaXdpMktmWmhOaXEyWVhZcDlpeklObUUyS3JaaGRtSzJZcllzaURZcDltRTJMWFpnZGluMktvZzJZUFlyZGluMllUWXA5aXFJTm1GMkt6WXNkaXYyS2tnMllUWXB5RFlxdGl5MllyWXJ5RFl1ZG1FMllrZzJLZlpoTm1JMkt6WmlOaXYySXdnMllYWmhkaW5JTm1LMlkvWmdkbUMySzhnMktmWmhOaTEyWUhZcDlpcUlOaW4yTFBZcXRtQzJZVFlwOW1FMllmWXB5RFlwOW1FMktyWmdkaXoyWXJZc2RtS0xpSXNJdG1HMllIWmlpRFlwOW1FMllMWXI5aXgyS2tnMktyWmhkaW4yWVhaaTlpbklOaTUyWVlnMktmWmhOaXcyS2ZZcWlEWXA5bUUyS1haaE5tSDJZcllxUzRpTENMWXJkaXYyWWpZcXlEWXF0aTIySzdaa2RtRklObUIyWW9nMktmWmhOaXcyS2ZZcWlEWmhObUkyS3paaU5pdklOaTEyWUhZcDlpcUlObUYyS3JZdWRpdjJLL1lxU0RaZ3RpbjJLYlpoZGlwSU5pbzJMRFlwOWlxMllmWXB5NGlYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNWDBzZXlKMFpYaDBJam9pMktQWml0bVJJTm1GMkxmWmhOaW8yWTBnMllyWXVkaW4yTEhZdHRtSElOaW4yWVRaZ3RtSTJZUWcyS2paZ3RpdjJZVWcyWVBaaE5pbjJZVWcyS2ZaaE5tRTJZZllueUFpTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZbzltR0lObUMySy9aaXRtRjJZcllxU0RZcDltRTJZUFpoTmluMllVZzJLcllyTmk1MllRZzJMWFlyOW1DSU5pbjJZVFpoTm1ISU5tRTJLY2cyWXJZcXRpMzJZVFlxQ0RaaGRpMzJLZllxTm1DMktrZzJZVFpoTmlqMkszWXI5aW4yS3NnMktmWmhOaXQyS2ZZcjlpcjJLa3VJaXdpMktQWmhpRFpndGl2MllyWmhkbUsyS2tnMktmWmhObUQyWVRZcDltRklObUUyS2NnMktyWmhkaXpJTml0Mkt6Wml0aXBJTmluMllUWmlOaXQyWW91SWl3aTJLUFpoaURaZ3RpdjJZclpoZG1LMktrZzJLZlpoTml0MkxIWmlObUJJTmlxMktUWXI5bUtJTmlsMllUWmlTRFlwZGkwMllQWXA5bUVJTm1CMllvZzJZWFl0OWluMktqWmd0aXBJTmluMllUWmc5bUUyS2ZaaFNEWmhObUUyWWpaZ3RpbjJLYll1U0RZcDltRTJLellyOW1LMksvWXFTNGlMQ0xZbzltR0lObUQyWVRZcDltRklOaW4yWVRaaE5tSElObUYySzdaaE5tSTJZSWcyWWpaaE5tSElOaW8ySy9ZcDltSzJLa2cyWWpZc3RtRjJZWXVJbDBzSW1OdmNuSmxZM1JCYm5OM1pYSWlPakI5TEhzaWRHVjRkQ0k2SXRpajJZclprU0RaaGRtR0lOaW4yWVRZcnRtSzJLZllzZGluMktvZzJLZlpoTmlxMktmWmhObUsyS2tnMllmWmlDRFlwOW1HMkxuWmc5aW4yTE1nMllYWmh0aTMyWUxaaWlEWmhObUMyWWpaaENEWXA5bUUyTExaaXRpdjJZcllxU0RaaU5pbjJZVFpoZGk1MktyWXN0bUUyS2tnMkszWmlObUVJTmluMllUWXVkbUUyWVVnMllqWXA5bUUyTERZcDlpcTJKOGdJaXdpZEhsd1pTSTZJbTFqY1NJc0ltTm9iMmxqWlhNaU9sc2kyS2ZaaE5pNTJZVFpoU0RaaE5tSzJMTWcyTFhaZ2RpcElOaXkyS2ZZcHRpdjJZN1lxZGliSU5pbzJZUWcyWWZaaUNEWmhObUkyS2ZZc3RtRjJZd2cyWVRZcHlEWXF0aTIyS2ZaZ1NEWXBkbUUyWWtnMktmWmhOaXcyS2ZZcWk0aUxDTFlwOW1FMkxuWmhObUZJTm1IMllnZzJMblppdG1HMlk4ZzJLZlpoTml3MktmWXFpRFppTm1LMks3WXF0bUUyTGNnMktqWXA5bUUyWWpZck5tSTJLOGcyS2ZaaE5pbDJZVFpoOW1LTGlJc0l0aW4yWVRZdWRtRTJZVWcyWVhZck5peDJLOGcyWWpaaDltRklObUUyS2NnMllyWmhkaXFJTmlvMkxYWmhOaXBJTm1FMllUWXNOaW4yS291SWl3aTJLZlpoTmk1MllUWmhTRFl0ZG1CMktrZzJMTFlwOWltMksvWml0aXBJTmk1MllZZzJLZlpoTml3MktmWXFpRFlxdG1GMktmWmhkbUwyS2N1SWwwc0ltTnZjbkpsWTNSQmJuTjNaWElpT2pCOUxIc2lkR1Y0ZENJNkl0aWwyTERZcHlEWXA5aTUyS3JaaGRpdjJZYllweURZcDltRTJZTFlwOWk1MksvWXFUb2dYQ0xZcGRpdzJLY2cySzdZcDltRTJZRWcyTGpZcDltSDJMRWcyS2ZaaE5tRzJZTFpoQ0RZcjltRTJZclpoTmluMllzZzJMblpndG1FMllyWmk5aW5JTm1DMkxmWXVkbUsyWXZZcHlEWmdkbUkyS3pZcUNEWXF0aWoyWWpaaXRtRUlOaW4yWVRZdU5pbjJZZllzVndpMkl3ZzJZSFlvOW1LMlpFZzJLM1lwOW1FMktrZzJLcllyZGlxMkxIWmhTRFpoOWl3MlljZzJLZlpoTm1DMktmWXVkaXYyS25ZbnlBaUxDSjBlWEJsSWpvaWJXTnhJaXdpWTJodmFXTmxjeUk2V3lMWXF0bUIyTFBaaXRpeElIdlpnOW1QMllUWmtkbVBJTmkwMlk3Wml0bVMyS0haalNEWmg5bU8yS2ZaaE5tUTJZUFpqQ0RZcGRtUTJZVFprZG1PMktjZzJZalpqdGlzMlpMWmg5bU8yWWZaajMwZzJMblpoTm1KSU5pajJZYlpoeURZck5pejJZWFlwOW1HMllvZzJLM1lzZG1CMllvdUlpd2kyTEhZcU5pM0lOaW4yWVRaaHRpMUlOaW8yWVhZdWRpbjJZYlppaURZdXRtSzJMRWcyWVRZdXRtSTJZcllxU0RZcjltSTJZWWcyTFBaaHRpdklOaTUyWUxaaE5tS0xpSXNJdGlxMkt2WXFObUsyS29nMktmWmhObUsySzhnMllqWXA5bUUyTG5aaXRtR0lObUQyS1BZdWRpMjJLZllvU0RZcGRtRTJZZlppdGlwSU5tRTJLUFpoaURZcDltRTJZYll0U0RZdU5pbjJZZllzUzRpTENMWXF0aWoyWWpaaXRtRUlGd2kyS2ZaaE5tSTJLelpoMXdpSU5pbzJLZlpoTml3MktmWXFpRFlvOW1JSU5pbzJLZlpoTmlyMllqWXA5aW9JTmlxMkt6Wmh0bVIyS2paaTlpbklObUUyWVRZck5pejJZWFppdGlwTGlKZExDSmpiM0p5WldOMFFXNXpkMlZ5SWpvemZTeDdJblJsZUhRaU9pTFpnZG1LSU5tRjJMUFlvOW1FMktrZzJLZlpoTmlsMkxIWXA5aXYyS2tnMllqWXA5bUUyWVBZc2RpbjJZZllxVG9nMktYWXNOaW5JTm1DMktmWmhDRFlvOWl0MksvWmg5bUZJTmlsMllZZ1hDTFlwZGl4MktmWXI5aXBJTmluMllUWmhObUhJTm1FMllyWXM5aXFJTmlsMllUWXB5RFl1ZG1FMllYWXA5bUxJTmkwMktmWmhkbUUyWXZZcDF3aUlObUIyWVhZcHlEWXA5bUUyWWJZcXRtSzJLellxU0RZcDltRTJMblpndGl2MllyWXFTRFpoTml3MllUWmd5RFlwOW1FMllMWmlObUUySjhnSWl3aWRIbHdaU0k2SW0xamNTSXNJbU5vYjJsalpYTWlPbHNpMktQWmhpRFlzTm1FMllNZzJZcllyZG1CMkxnZzJZWFl1ZG1HMllrZzJLZlpoTm1GMksvWXJTRFppTmluMllUWXNObUZJTm1JMktmWmhOaXEyWVBaaE5tSzJZRXVJaXdpMktQWmhpRFpnZGkxMllRZzJLZlpoTmlsMkxIWXA5aXYyS2tnMkxuWmhpRFppTmlzMllqWXJ5RFl1ZGluMllYWmhDRFlwOWl1MktyWml0aW4yTEhaaWlEWml0bUMyWWpaa2RpMklObUYyTG5aaHRtSklOaW4yWVRZbzltRjJMRWcyWWpZcDltRTJZYlpoOW1LSU5tSTJLZlpoTmk1MllMWXA5aW9JTm1JMktmWmhOaXIyWWpZcDlpb0xpSXNJdGlqMllZZzJZZllzTmluSU5pbjJZVFpndG1JMllRZzJZcllyOW1FMlpFZzJMblpoTm1KSU5tQzJaRFlyOW1PMllVZzJLZlpoTm1EMllUWXA5bUZMaUlzSXRpajJZWWcyWWZZc05pbklOaW4yWVRaZ3RtSTJZUWcyWXJZcXRtQjJZSWcyS3JaaE5tQzJLZllwdG1LMll2WXB5RFpoZGk1SU5pbjJZVFpoZG1JMllMWmdTRFlwOW1FMllYWXJOaW8yTEV1SWwwc0ltTnZjbkpsWTNSQmJuTjNaWElpT2pGOUxIc2lkR1Y0ZENJNkl0aWoyWXJaa1NEWmlOaTIyTGtnMllyWmo5aTQyWWZZc1NEWXF0bUcyS2ZaZ3RpMjJZdllweURZdGRpbjJMSFlydG1MMktjZzJZVFppQ0RZcDlpcTJaSFpqOW1LMkszWXFpQmNJdGluMllUWXJObUgyS2xjSWlEWmhObUUyWWZZbnlBaUxDSjBlWEJsSWpvaWJXTnhJaXdpWTJodmFXTmxjeUk2V3lMWW85bUdJTmluMllUWXJObUgyS2tnMktyWXBObUQySzhnMktqWmd0aW4yS0VnMktmWmhObUUyWWNnMksvWmlObUdJTmlxMkxyWml0bUsyTEV1SWl3aTJLUFpoaURaaU5pczJZallyeURZcDltRTJLelpoOWlwSU5tRTJLY2cyWXJZc2RpcTJLall0eURZcU5pajJZb2cyS3JZcU5pNTJLZllxaURaaE5pNjJZalppdGlwTGlJc0l0aWoyWVlnMktmWmhOaXMyWWZZcVNEWXF0bVAyTG5ZdDltS0lObUUyWVRaaHlEWmhkbUQyS2ZaaHRtTDJLY2cyWUhaaU5tQ0lOaW4yWVRZdWRpeDJMUWcyS2paaGRpNTJZYlppU0RZc2RtRjJMTFppaURaZ2RtQzJMY3VJaXdpMktQWmhpRFlwZGlyMktqWXA5aXFJTmluMllUWXJObUgyS2tnMllyWXBOaXYyWW9nMktYWmhObUpJTmlxMkxUWXFObUsyWWNnMktmWmhObUUyWWNnMktqWXA5bUUyWVhaaU5pczJZallyOWluMktvZzJLZlpoTm1GMllQWXA5bUcyWXJZcVNEWW85bUtJTmluMllUWXJOaXoyWVhaaXRpcExpSmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3pmVjE5';
    
    // START: DECRYPTION LOGIC
    const SECRET_KEY = 'change-this-to-your-own-secret-phrase-12345';
    
    const examData = JSON.parse(decodeURIComponent(escape(atob(atob(encodedExamData)))));

    try {
        if (examData.config.botToken) {
            const decryptedBytes = CryptoJS.AES.decrypt(examData.config.botToken, SECRET_KEY);
            examData.config.botToken = decryptedBytes.toString(CryptoJS.enc.Utf8);
        }
        if (examData.config.chatId) {
            const decryptedBytes = CryptoJS.AES.decrypt(examData.config.chatId, SECRET_KEY);
            examData.config.chatId = decryptedBytes.toString(CryptoJS.enc.Utf8);
        }
        if (examData.config.githubToken) {
            const decryptedBytes = CryptoJS.AES.decrypt(examData.config.githubToken, SECRET_KEY);
            examData.config.githubToken = decryptedBytes.toString(CryptoJS.enc.Utf8);
        }
    } catch (e) {
        console.error("Decryption failed! The secret key might be wrong or data is corrupt.", e);
    }
    // END: DECRYPTION LOGIC

    const GITHUB_OWNER = 'alshami2024';
    const GITHUB_REPO = 'alshami';

    let studentName = '', studentAnswers = new Array(examData.questions.length).fill(null), timerInterval, currentQuestionIndex = 0, tabSwitchCount = 0, examFinished = false;
    const startScreen = document.getElementById('startScreen'), examArea = document.getElementById('examArea'), resultContainer = document.getElementById('resultContainer'), savingResultsScreen = document.getElementById('savingResultsScreen');
    const accessControl = examData.config.accessControl || { enabled: false, students: [] };
    
    window.onload = function() {
        const uniqueExamId = `examStarted_${btoa(unescape(encodeURIComponent(examData.config.title)))}`;
        if (examData.config.singleUseMode && localStorage.getItem(uniqueExamId)) {
            document.body.innerHTML = `<div class="container" style="text-align:center;"><h1>ÿ™ŸÖ ŸÇŸÅŸÑ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</h1><p>ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ®ÿØÿ° Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿßŸÑŸÅÿπŸÑ ŸÖŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠. ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ¨ÿ±ÿßÿ§Ÿá ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.</p></div>`;
            return;
        }

        const now = new Date();
        const startTime = examData.config.startTime ? new Date(examData.config.startTime) : null;
        const endTime = examData.config.endTime ? new Date(examData.config.endTime) : null;

        if (startTime && now < startTime) {
            document.getElementById('startScreen').innerHTML = `<h1>ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ ÿ®ÿπÿØ</h1><p>ÿ≥ŸäŸÉŸàŸÜ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿ™ÿßÿ≠Ÿãÿß ŸÅŸä: ${startTime.toLocaleString('ar-EG')}</p>`;
            return;
        }

        if (endTime && now > endTime) {
            document.getElementById('startScreen').innerHTML = `<h1>ÿßŸÜÿ™Ÿáÿ™ ŸÅÿ™ÿ±ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</h1><p>ŸÑŸÇÿØ ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÑÿ•ÿ¨ÿ±ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±.</p>`;
            return;
        }

        document.getElementById('examTitleStudent').textContent = examData.config.title;
        document.getElementById('examDescriptionStudent').textContent = examData.config.description;
        document.getElementById('startExamBtn').addEventListener('click', validateStudentAndStart);
    };
    
    async function validateStudentAndStart() {
        const nameInput = document.getElementById('studentName').value.trim();
        if (!nameInput) {
            alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ.');
            return;
        }
    
        if (accessControl.enabled) {
            const codeInput = document.getElementById('accessCode').value.trim();
            if (!codeInput) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿØÿÆŸàŸÑ.');
                return;
            }
            const isValidStudent = accessControl.students.some(student => 
                student.name.trim().toLowerCase() === nameInput.toLowerCase() && student.code === codeInput
            );
    
            if (!isValidStudent) {
                alert('ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÖÿ≤ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
                return;
            }
    
            // NEW: Check for existing results for one-time access
            if (examData.config.singleUseMode && examData.config.githubToken && examData.config.resultsFilename) {
                try {
                    const hasTakenExam = await checkIfStudentHasTakenExam(nameInput, examData.config.githubToken, examData.config.resultsFilename);
                    if (hasTakenExam) {
                        alert('ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ•ÿ¨ÿ±ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿ≥ÿ®ŸÇŸãÿß. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ¨ÿ±ÿßÿ§Ÿá ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
                        return;
                    }
                } catch (error) {
                    console.error("Error checking for existing results:", error);
                    alert("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.");
                    return;
                }
            }
    
            studentName = nameInput;
            startTheExam();
        } else {
            studentName = nameInput;
            startTheExam();
        }
    }
    
    // NEW: Function to check if a student has already submitted results
    async function checkIfStudentHasTakenExam(studentName, githubToken, filename) {
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filename}`;
        
        try {
            const response = await fetch(url, { headers: { 'Authorization': `token ${githubToken}` } });
            if (response.status === 404) {
                return false; // File doesn't exist, so no results yet.
            }
            if (!response.ok) {
                throw new Error(`GitHub API error: ${response.statusText}`);
            }
            
            const data = await response.json();
            const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            
            return content.some(result => result.studentName.trim().toLowerCase() === studentName.toLowerCase());
        } catch (error) {
            console.error("Error fetching results from GitHub:", error);
            return false; // Assume no existing results to allow the student to proceed in case of API error.
        }
    }
    
    function startTheExam() {
        if (examData.config.singleUseMode) {
             const uniqueExamId = `examStarted_${btoa(unescape(encodeURIComponent(examData.config.title)))}`;
             localStorage.setItem(uniqueExamId, 'true');
        }
        sendStartNotificationToTelegram();
        startScreen.style.display = 'none'; examArea.style.display = 'block';
        document.getElementById('welcomeStudent').textContent = `ÿ®ÿßŸÑÿ™ŸàŸÅŸäŸÇÿå ${studentName}!`;
        if (examData.config.time > 0) startTimer(examData.config.time * 60); else document.getElementById('timer').style.display = 'none';
        if (examData.config.shuffle) { examData.questions.sort(() => Math.random() - 0.5); }
        setupSmartFeatures(); renderQuestionsForStudent();
        document.getElementById('finishExamBtn').addEventListener('click', () => { if(confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿ∫ÿ®ÿ™ŸÉ ŸÅŸä ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±ÿü")) finishTheExam(); });
    }
    
    function renderQuestionsForStudent(){const container=document.getElementById("questionsContainer");container.innerHTML="",examData.config.layout==="one-by-one"?(renderSingleQuestion(currentQuestionIndex),updateNavigationButtons()):examData.questions.forEach((e,t)=>container.appendChild(createQuestionElement(e,t))),updateProgressBar()}function createQuestionElement(e,t){const n=document.createElement("div");n.className="question-card",n.id=`question-${t}`;let o=`<h3>ÿßŸÑÿ≥ÿ§ÿßŸÑ ${t+1}: ${e.text}</h3>`;if("mcq"===e.type){const i=e.choices.map((e,n)=>`<li onclick="handleChoiceClick(${t}, ${n}, this)"><input type="radio" name="q${t}" id="q${t}c${n}" value="${n}" ${studentAnswers[t]===n?"checked":""}><label for="q${t}c${n}">${e}</label></li>`).join("");o+=`<ul class="choices">${i}</ul>`}else{const s=studentAnswers[t]||"";o+=`<textarea class="essay-answer" oninput="handleEssayInput(${t}, this.value)" placeholder="ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ŸáŸÜÿß...">${s}</textarea>`}return n.innerHTML=o,n}function handleChoiceClick(e,t,n){studentAnswers[e]=t,n.querySelector("input").checked=!0,examData.config.layout==="one-by-one"&&examData.config.learningMode&&"mcq"===examData.questions[e].type&&((n.classList.add(t===examData.questions[e].correctAnswer?"correct":"incorrect"),n.parentElement.querySelectorAll("li").forEach(e=>{e.style.pointerEvents="none"}))),updateProgressBar()}function handleEssayInput(e,t){studentAnswers[e]=t.trim(),updateProgressBar()}function renderSingleQuestion(e){document.getElementById("questionsContainer").appendChild(createQuestionElement(examData.questions[e],e))}function updateNavigationButtons(){const e=document.getElementById("navigation-buttons");if("one-by-one"!==examData.config.layout)return void(e.style.display="none");let t="";examData.config.noGoingBack||(t='<button id="prevBtn" class="btn">ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>'),e.innerHTML=`${t}<button id="nextBtn" class="btn">ÿßŸÑÿ™ÿßŸÑŸä</button>`;const n=document.getElementById("nextBtn");n.disabled=currentQuestionIndex===examData.questions.length-1,n.addEventListener("click",()=>{currentQuestionIndex<examData.questions.length-1&&(currentQuestionIndex++,renderQuestionsForStudent())}),examData.config.noGoingBack||(document.getElementById("prevBtn").disabled=0===currentQuestionIndex,document.getElementById("prevBtn").addEventListener("click",()=>{currentQuestionIndex>0&&(currentQuestionIndex--,renderQuestionsForStudent())}))}function updateProgressBar(){const e=studentAnswers.filter(e=>null!==e&&""!==e).length,t=e/examData.questions.length*100,n=document.getElementById("progressBar");n.style.width=`${t}%`,n.textContent=`${Math.round(t)}%`}
    function setupSmartFeatures(){if(examData.config.disableCheating){["contextmenu","copy","paste"].forEach(evt=>document.body.addEventListener(evt,e=>e.preventDefault()))}if(examData.config.monitorTabs){document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden"&&!examFinished){tabSwitchCount++;if(examData.config.finishOnSwitch){alert("ŸÑŸÇÿØ ÿÆÿ±ÿ¨ÿ™ ŸÖŸÜ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±ÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ ÿßŸÑÿ≠ÿßŸÑŸäÿ©.");finishTheExam()}}})}}
    
    async function finishTheExam(){
        if(examFinished) return;
        examFinished = true;
        clearInterval(timerInterval);
        examArea.style.display = "none";
        
        // ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ≠ŸÅÿ∏ ŸÇÿ®ŸÑ ÿ£Ÿä ÿ¥Ÿäÿ° ÿ¢ÿÆÿ±
        if (examData.config.githubToken && examData.config.resultsFilename) {
            savingResultsScreen.style.display = 'block';
            await saveResultsToGithub();
            savingResultsScreen.style.display = 'none';
        }
    
        resultContainer.style.display = "block";
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
        let correctMcq = 0, totalMcq = 0;
        examData.questions.forEach((q, index) => {
            if ("mcq" === q.type) {
                totalMcq++;
                if (studentAnswers[index] === q.correctAnswer) {
                    correctMcq++;
                }
            }
        });
        
        document.getElementById("resultTitle").textContent = "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ!";
        if(examData.config.showResults){
            let summaryHtml = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${studentName}ÿå ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ ŸÅŸä ÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜ ŸÖÿ™ÿπÿØÿØ ŸáŸä: <strong>${correctMcq} / ${totalMcq}</strong>`;
            if (examData.questions.some(q => "essay" === q.type)) {
                summaryHtml += '<br><small>ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸÇÿßŸÑŸäÿ© ÿ™ÿ™ÿ∑ŸÑÿ® ÿ™ÿµÿ≠Ÿäÿ≠Ÿãÿß ŸäÿØŸàŸäŸãÿß Ÿàÿ≥ÿ™ÿ∏Ÿáÿ± ŸÜÿ™Ÿäÿ¨ÿ™Ÿáÿß ŸÑÿßÿ≠ŸÇÿßŸã.</small>';
            }
            if (examData.config.monitorTabs && tabSwitchCount > 0) {
                summaryHtml += `<br><small style="color:var(--danger-color);">ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ŸÉ ŸÖŸÜ ÿßŸÑÿµŸÅÿ≠ÿ© ${tabSwitchCount} ŸÖÿ±ÿßÿ™.</small>`;
            }
            document.getElementById("resultSummary").innerHTML = summaryHtml;
        } else {
            document.getElementById("resultSummary").textContent = "ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉÿå ÿ™ŸÖ ÿ™ÿ≥ŸÑŸäŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠.";
        }
    
        if (examData.config.showResults && examData.config.enableReview) {
            renderReview();
        }
        
        if (examData.config.enableCertificate && totalMcq > 0 && (correctMcq / totalMcq * 100) >= examData.config.successPercentage) {
            renderCertificate(correctMcq, totalMcq);
        }
        
        if (examData.config.botToken && examData.config.chatId) {
            await sendResultsToTelegram(correctMcq, totalMcq);
        }
    }

    function renderReview(){const e=document.getElementById("reviewContainer");e.innerHTML="<h3>ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™:</h3>",examData.questions.forEach((t,n)=>{let o="";o="mcq"===t.type?`<div class="question-card" style="background:${studentAnswers[n]===t.correctAnswer?"#d4edda":"#f8d7da"};"><p><strong>${t.text}</strong></p><p>ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ: ${null!==studentAnswers[n]?t.choices[studentAnswers[n]]:"ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©"} ${studentAnswers[n]===t.correctAnswer?"‚úîÔ∏è":"‚ùå"}</p>${studentAnswers[n]!==t.correctAnswer?`<p style="color:var(--primary-color);">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ${t.choices[t.correctAnswer]}</p>`:""}</div>`:`<div class="question-card" style="background: #e9ecef;"><p><strong>(ÿ≥ÿ§ÿßŸÑ ŸÖŸÇÿßŸÑŸä) ${t.text}</strong></p><p style="font-weight:bold;">ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ:</p><p style="white-space: pre-wrap; background: #fff; padding:10px; border-radius:5px;">${studentAnswers[n]?studentAnswers[n].replace(/</g,"&lt;").replace(/>/g,"&gt;"):"ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©"}</p></div>`,e.innerHTML+=o})}function renderCertificate(e,t){const n=document.getElementById("certificate");n.style.display="block",document.getElementById("certName").textContent=studentName,document.getElementById("certScore").textContent=`${e} / ${t}`,document.getElementById("certDate").textContent=(new Date).toLocaleDateString("ar-EG")}function startTimer(e){let t=e;const n=document.getElementById("timer");timerInterval=setInterval(()=>{let e=parseInt(t/60,10),o=parseInt(t%60,10);e=e<10?"0"+e:e,o=o<10?"0"+o:o,n.textContent=`${e}:${o}`,--t<0&&(clearInterval(timerInterval),alert("ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!"),finishTheExam())},1e3)}async function sendResultsToTelegram(e,t){const{botToken:n,chatId:o,title:s}=examData.config;if(!n||!o)return;function i(e){return"string"!=typeof e?"":e.replace(/([_*[\]()~>#+\-=|{}.!])/g,"\\$1")}let a=`*üìä ŸÜÿ™Ÿäÿ¨ÿ© ÿßÿÆÿ™ÿ®ÿßÿ± ÿ¨ÿØŸäÿØÿ©*\n\n*ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±:* ${i(s)}\n*ÿßŸÑÿ∑ÿßŸÑÿ®:* ${i(studentName)}\n*ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜ ŸÖÿ™ÿπÿØÿØ:* ${e} ŸÖŸÜ ${t}\n*ŸÖÿ±ÿßÿ™ ÿßŸÑÿÆÿ±Ÿàÿ¨:* ${tabSwitchCount}`;let d="\n\n*ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÖŸÇÿßŸÑŸäÿ©*",r=!1;examData.questions.forEach((e,t)=>{("essay"===e.type&&(r=!0,d+=`\n\n*‚ùì ÿßŸÑÿ≥ÿ§ÿßŸÑ: ${i(e.text)}*\n*üìù ÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®:*\n${i(studentAnswers[t]||"ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©")}`))}),r&&(a+=d);const c=`https://api.telegram.org/bot${n}/sendMessage`;try{a.length>4096&&(a=a.substring(0,4e3)+"\n\n... (ÿ™ŸÖ ÿßŸÇÿ™ÿ∑ÿßÿπ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÑÿ£ŸÜŸáÿß ÿ∑ŸàŸäŸÑÿ© ÿ¨ÿØÿßŸã)");const l=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:o,text:a,parse_mode:"MarkdownV2"})});l.ok||console.error("Telegram API Error:",await l.json())}catch(p){console.error("Fetch error or issue sending to Telegram:",p)}}async function sendStartNotificationToTelegram(){const{botToken:n,chatId:o,title:s}=examData.config;if(!n||!o)return;function i(e){return"string"!=typeof e?"":e.replace(/([_*[\]()~>#+\-=|{}.!])/g,"\\$1")}const a=`*üîî ÿ®ÿØÿ° ÿßÿÆÿ™ÿ®ÿßÿ± ÿ¨ÿØŸäÿØ*\n\n*ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±:* ${i(s)}\n*ÿßŸÑÿ∑ÿßŸÑÿ®:* ${i(studentName)}`,c=`https://api.telegram.org/bot${n}/sendMessage`;try{const l=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:o,text:a,parse_mode:"MarkdownV2"})});l.ok||console.error("Telegram API Error (Start Notification):",await l.json())}catch(p){console.error("Fetch error sending start notification:",p)}}
    
    async function saveResultsToGithub() {
        const token = examData.config.githubToken;
        const filename = examData.config.resultsFilename;
        if (!token || !filename) { return; } 
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filename}`;
        
        let correctMcq = 0, totalMcq = 0;
        examData.questions.forEach((q, index) => {
            if ("mcq" === q.type) {
                totalMcq++;
                if (studentAnswers[index] === q.correctAnswer) {
                    correctMcq++;
                }
            }
        });

        const resultData = {
            studentName: studentName,
            submissionDate: new Date().toISOString(),
            mcqScore: { correct: correctMcq, total: totalMcq },
            tabSwitchCount: tabSwitchCount,
            examTitle: examData.config.title,
            answers: examData.questions.map((q, index) => {
                const studentAnswerRaw = studentAnswers[index];
                let studentAnswerText = studentAnswerRaw;
                let isCorrect = null;
                let correctAnswerText = null;

                if (q.type === 'mcq') {
                    isCorrect = (studentAnswerRaw === q.correctAnswer);
                    studentAnswerText = (studentAnswerRaw !== null) ? q.choices[studentAnswerRaw] : "ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©";
                    if (!isCorrect) {
                        correctAnswerText = q.choices[q.correctAnswer];
                    }
                }

                return {
                    question: q.text,
                    answer: studentAnswerText,
                    isCorrect: isCorrect,
                    correctAnswer: correctAnswerText
                };
            })
        };

        try {
            let currentContent = [];
            let sha;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                    currentContent = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                } else if (res.status !== 404) {
                    throw new Error(`GitHub API error on fetch: ${res.statusText}`);
                }
            } catch (fetchError) {
                console.warn("Could not fetch existing results file. A new one will be created.", fetchError);
            }
            
            currentContent.push(resultData);
            const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®: ${studentName}`,
                    content: updatedContent,
                    sha: sha
                })
            });

            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(`Failed to save results: ${errorData.message}`);
            }
            console.log('Results saved to GitHub successfully.');

        } catch (error) {
            console.error("Error saving results to GitHub:", error);
            document.getElementById("resultSummary").innerHTML += '<br><small style="color:red;">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿ≠ÿßŸàŸÑÿ© ÿ≠ŸÅÿ∏ ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ.</small>';
        }
    }
</script>
</body>
</html>
