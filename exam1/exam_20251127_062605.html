
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ø¹ Ù…Ø·ÙˆØ± Ø±Ù‚Ù… (3) </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0056b3; --bg-color: #e9ecef; --white: #fff; --danger: #dc3545; --success: #28a745; --warning: #ffc107; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; direction: rtl; line-height: 1.6; }
        .container { background-color: var(--white); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 850px; margin: 0 auto; padding: 25px; min-height: 80vh; position: relative; }
        .btn { background: var(--primary-color); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-family: inherit; margin: 5px; font-weight: bold; transition: 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: #000; }
        
        .question-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .question-card:hover { box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .choices { list-style: none; padding: 0; }
        .choices li { background: #fff; border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .choices li:hover { background: #e9ecef; border-color: var(--primary-color); }
        .choices li.selected { border-color: var(--primary-color); background: #e7f1ff; font-weight: bold; }
        
        .voice-btn { position: absolute; top: 15px; left: 15px; background: #fff; border: 1px solid #ddd; width: 35px; height: 35px; border-radius: 50%; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .voice-btn:hover { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        
        .ai-explanation-box { background: #e3f2fd; border-right: 4px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 6px; display: none; font-size: 0.95em; line-height: 1.8; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .timer-badge { background: #ffeeee; color: var(--danger); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid #ffcccc; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .footer-copyright {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #888;
            font-size: 0.9rem;
            font-family: monospace, 'Tajawal';
        }

        @media (max-width: 600px) {
            .container { padding: 15px; }
            .question-card { padding: 15px; }
            .btn { width: 100%; margin: 5px 0; }
        }
        
.footer-copyright {
    margin-top: 30px;   /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø²Ø± ÙˆØ¨ÙŠÙ† Ø§Ù„Ù†Øµ */
    text-align: center; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Øµ */
    font-size: 0.8rem;  /* Ø®Ø· ØµØºÙŠØ± */
    color: #888;        /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ */
    width: 100%;        /* Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ³ÙŠØ· */
    display: block;     /* Ù„Ø¶Ù…Ø§Ù† Ù†Ø²ÙˆÙ„Ù‡ ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ */
}
    </style>
</head>
<body>
<div class="container">
    <div id="startScreen">
        <h1 style="color:var(--primary-color); margin-bottom:10px;">ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ø¹ Ù…Ø·ÙˆØ± Ø±Ù‚Ù… (3) </h1>
        <p style="color:#666; margin-bottom:20px;">Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø®ØµØµ: Ø§Ù„Ù†Ø­Ùˆ Ø³Ø§Ø¨Ø¹ Ù…Ø·ÙˆØ± | Ø¯. Ø¹Ø¨Ø¯Ø§Ù„Ø±Ù‚ÙŠØ¨ Ø§Ù„Ø´Ø§Ù…ÙŠ | Ø§Ù„Ø³Ø§Ø¨Ø¹ Ù…Ø·ÙˆØ±</p>
        <div style="background:#f1f3f5; padding:15px; border-radius:8px; margin-bottom:20px;">
            <i class="fa-regular fa-clock"></i> Ø§Ù„Ù…Ø¯Ø©: 60 Ø¯Ù‚ÙŠÙ‚Ø© <br>
            <i class="fa-solid fa-list-ol"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: 15
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        
        <div class="form-group">
            <label for="studentName">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="studentName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        
    
        
        <button onclick="validateAndStart()" class="btn">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸš€</button>

        <div class="footer-copyright" style="margin-top: 20px;">Jamal-Alshami Â© 2025</div>
        </div>

    <div id="examArea" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="font-weight:bold;"><i class="fa-regular fa-user"></i> <span id="studentNameDisplay"></span></div>
            <div id="timer" class="timer-badge">00:00</div>
        </div>
        
        <div style="height:8px; background:#eee; border-radius:10px; margin-bottom:25px; overflow:hidden;">
            <div id="progressBar" style="height:100%; width:0%; background:var(--success); transition:0.4s ease-out;"></div>
        </div>
        
        <div id="questionsContainer"></div>
        
        <div id="navButtons" style="margin-top:25px; display:flex; gap:10px; justify-content: flex-end; flex-wrap: wrap;"></div>
    </div>

    <div id="savingScreen" style="display:none; text-align:center; padding:40px;">
        <div class="spinner" style="width:50px; height:50px; border-width:5px;"></div>
        <h3>Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ...</h3>
        <p>ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©</p>
    </div>

    <div id="resultScreen" style="display:none; text-align:center;">
        <h2 style="color:var(--primary-color);">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h2>
        <div id="scoreDisplay" style="font-size: 2.5rem; font-weight:bold; margin: 20px 0; color:#333;"></div>
        <div id="resultSummary" style="margin-bottom:20px; color:#666;"></div>
        
        <div id="actionButtons" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"></div>
        
        <div id="certificateArea" style="display:none; border: 10px double var(--primary-color); padding: 30px; margin-top: 30px; background: #fff;">
            <h2 style="color:var(--primary-color);">Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù…</h2>
            <p>ØªØ´Ù‡Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©:</p>
            <h1 id="certName" style="margin: 15px 0;"></h1>
            <p>Ù‚Ø¯ Ø§Ø¬ØªØ§Ø² Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ù†ØªÙŠØ¬Ø©:</p>
            <h2 id="certScore" style="color:var(--success);"></h2>
            <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="certDate"></span></p>
        </div>

        <div id="reviewArea" style="text-align: right; margin-top: 40px;"></div>
    </div>

     
</div>

<script>
    const encodedData = 'ZXlKamIyNW1hV2NpT25zaWRHbDBiR1VpT2lMWXF0aXYyTEhaaXRpbzJLZllxaURZcDltRTJMUFlwOWlvMkxrZzJZWFl0OW1JMkxFZzJMSFpndG1GSUNnektTQWlMQ0prWlhOamNtbHdkR2x2YmlJNkl0aW4ySzdZcXRpbzJLZllzU0RaaGRpdTJMWFl0VG9nMktmWmhObUcySzNaaUNEWXM5aW4yS2pZdVNEWmhkaTMyWWpZc1NCOElOaXZMaURZdWRpbzJLL1lwOW1FMkxIWmd0bUsyS2dnMktmWmhOaTAyS2ZaaGRtS0lId2cyS2ZaaE5pejJLZllxTmk1SU5tRjJMZlppTml4SWl3aWMzUmhjblJVYVcxbElqb2lNakF5TlMweE1TMHlOMVF3TmpveU55SXNJbVZ1WkZScGJXVWlPaUl5TURJMUxURXhMVE13VkRJek9qVTVJaXdpYkdGNWIzVjBJam9pYjI1bExXSjVMVzl1WlNJc0luUnBiV1VpT2pZd0xDSnphSFZtWm14bElqcDBjblZsTENKdWIwZHZhVzVuUW1GamF5STZabUZzYzJVc0ltUnBjMkZpYkdWRGFHVmhkR2x1WnlJNlptRnNjMlVzSW0xdmJtbDBiM0pVWVdKeklqcDBjblZsTENKbWFXNXBjMmhQYmxOM2FYUmphQ0k2Wm1Gc2MyVXNJbXhsWVhKdWFXNW5UVzlrWlNJNlptRnNjMlVzSW5OcGJtZHNaVlZ6WlUxdlpHVWlPblJ5ZFdVc0luTm9iM2RTWlhOMWJIUnpJanAwY25WbExDSmxibUZpYkdWU1pYWnBaWGNpT21aaGJITmxMQ0psYm1GaWJHVkRaWEowYVdacFkyRjBaU0k2ZEhKMVpTd2laVzVoWW14bFZHVjRkRlJ2VTNCbFpXTm9JanAwY25WbExDSmxibUZpYkdWQlNWUjFkRzl5SWpwMGNuVmxMQ0psYm1GaWJHVlRiV0Z5ZEZKbGRISjVJanAwY25WbExDSjBhR1Z0WlNJNkltUmxabUYxYkhRaUxDSnpkV05qWlhOelVHVnlZMlZ1ZEdGblpTSTZOREFzSW1KdmRGUnZhMlZ1SWpvaVZUSkdjMlJIVm10WU1UbE5hbmhDZFVoUlpVNDNkWEI1V0U1dWJqRXlOVnA2WTFnd2NXSnNjakV3TjJvM2VuVlVkRWMwZEdZMllYWlNURlk1Y25BNWVEUkhTRlZGY2xJd1dtcGpabU4xWlUxWFkxQjRjMUU5UFNJc0ltTm9ZWFJKWkNJNklsVXlSbk5rUjFacldERXZNVkpxTVRaYU5rczVNalY1U25CREx6RnNjVXRvYm01UGVuSXdaSElyY1UwOUlpd2laMmwwYUhWaVZHOXJaVzRpT2lKVk1rWnpaRWRXYTFneE9XUjBVamd4TjAxdE5EbDBNbmR1WmxKWFoyZEZSVGhNTUZGWllrbzVaVXhuZEhFclduZFhSM2xpTmxoRVJHNW5jMmd3U25JM2FqRkdhSEZKUmpoT1lXMTNaR0VyVnpKQ1NqZDZVVDA5SWl3aWNtVnpkV3gwYzBacGJHVnVZVzFsSWpvaWRHVnpkR3hoZHk1cWMyOXVJaXdpWVdOalpYTnpRMjl1ZEhKdmJDSTZleUpsYm1GaWJHVmtJanBtWVd4elpTd2ljM1IxWkdWdWRITWlPbHRkZlgwc0luRjFaWE4wYVc5dWN5STZXM3NpZEdWNGRDSTZJdG1EMllRZzJZWFlweURaaXRpajJLclppaURaaGRtR0lOaWoySy9aaU5pbjJLb2cyS2ZaaE5pMDJMSFl0eURZbzlpejJZWFlwOWloSU5pNTJLL1lwem9pTENKd2IybHVkSE1pT2pBc0ltbHRZV2RsSWpvaUlpd2lhVzFoWjJWWGFXUjBhQ0k2SWlJc0ltbHRZV2RsU0dWcFoyaDBJam9pSWl3aWRIbHdaU0k2SW0xamNTSXNJbU5vYjJsalpYTWlPbHNpMllYWmg5bUYyS2NpTENMWXBkaXcyWVhZcHlJc0l0aXQyWXJZcTltRjJLY2lMQ0xaaGRpcTJZa2lYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNWDBzZXlKMFpYaDBJam9pMllQWmhDRFlvOWl6MllYWXA5aWhJTmluMllUWXROaXgyTGNnMllYWXFObUcyWXJZcVNEWXVkaXYyS2M2SWl3aWNHOXBiblJ6SWpvd0xDSnBiV0ZuWlNJNklpSXNJbWx0WVdkbFYybGtkR2dpT2lJaUxDSnBiV0ZuWlVobGFXZG9kQ0k2SWlJc0luUjVjR1VpT2lKdFkzRWlMQ0pqYUc5cFkyVnpJanBiSXRtRjJLclppU0lzSXRtRjJZWWlMQ0xZbzltS0lpd2kyWVhZcHlKZExDSmpiM0p5WldOMFFXNXpkMlZ5SWpveWZTeDdJblJsZUhRaU9pTFpoZG1IMllYWXB5WnVZbk53T3lEWXF0aTMyTGtnMllqWXA5bUUySy9aaXRtRElObUsyTEhZdGlEWXA5bUUyWVRaaHlEWXVkbUcyWU11SU5pbDJMbllzZGluMktnZzJLZllzOW1GSU5pbjJZVFl0Tml4MkxjZ0tEeHpjR0Z1SUhOMGVXeGxQVndpWm05dWRDMW1ZVzFwYkhrNklDWnhkVzkwTzIxdmFHRnRiV0ZrSUdKdmJHUWdZWEowSURFbWNYVnZkRHNzSUhOaGJuTXRjMlZ5YVdZN1hDSSsyWVhaaDltRjJLYzhMM053WVc0K0tUb2lMQ0p3YjJsdWRITWlPakFzSW1sdFlXZGxJam9pSWl3aWFXMWhaMlZYYVdSMGFDSTZJaUlzSW1sdFlXZGxTR1ZwWjJoMElqb2lJaXdpZEhsd1pTSTZJbTFqY1NJc0ltTm9iMmxqWlhNaU9sc2kyS2ZZczltRklOaTAyTEhZdHlEWmhkaW8yWWJaaWlEWmdkbUtJTm1GMkszWmhDRFlzZG1CMkxrZzJZWFlxTmlxMksvWW95SXNJdGluMkxQWmhTRFl0Tml4MkxjZzJZWFlxTm1HMllvZzJZSFppaURaaGRpdDJZUWcyWWJZdGRpb0lObUYyWUhZdWRtSTJZUWcyS2paaHlKZExDSmpiM0p5WldOMFFXNXpkMlZ5SWpvd2ZTeDdJblJsZUhRaU9pSThjM0JoYmlCemRIbHNaVDFjSW1admJuUXRabUZ0YVd4NU9pQkJWRkpCUkVKRVR5d2djMkZ1Y3kxelpYSnBaanRjSWo1N1BDOXpjR0Z1UHRpajJZN1ppdG1TMlliWmp0bUYyWTdZcHlEWXF0bU8yWVBaajltSTJZYlpqOW1JMktmWmtpRFppdG1QMksvWmt0aXgyWkRaZzltUjJZL1poZG1QSU5pbjJZVFprdG1GMlk3WmlObVMyS3Jaanp4emNHRnVJSE4wZVd4bFBWd2labTl1ZEMxbVlXMXBiSGs2SUVGVVVrRkVRa1JQTENCellXNXpMWE5sY21sbU8xd2lQbjA4TDNOd1lXNCtJQzRnMktYWXVkaXgyS2ZZcUNEWXA5aXoyWVVnMktmWmhOaTAyTEhZdHlBb1BITndZVzRnYzNSNWJHVTlYQ0ptYjI1MExXWmhiV2xzZVRvZ0puRjFiM1E3Ylc5b1lXMXRZV1FnWW05c1pDQmhjblFnTVNaeGRXOTBPeXdnYzJGdWN5MXpaWEpwWmp0Y0lqN1lvOW1LMlliWmhkaW5QQzl6Y0dGdVBpazZJaXdpY0c5cGJuUnpJam93TENKcGJXRm5aU0k2SWlJc0ltbHRZV2RsVjJsa2RHZ2lPaUlpTENKcGJXRm5aVWhsYVdkb2RDSTZJaUlzSW5SNWNHVWlPaUp0WTNFaUxDSmphRzlwWTJWeklqcGJJdGluMkxQWmhTRFl0Tml4MkxjZzJZWFlxTm1HMllvZzJZSFppaURaaGRpdDJZUWcyWWJZdGRpb0lOaTQyTEhaZ1NEWXN0bUYyS2ZaaGlJc0l0aW4yTFBaaFNEWXROaXgyTGNnMllYWXFObUcyWW9nMllIWmlpRFpoZGl0MllRZzJZYll0ZGlvSU5pNDJMSFpnU0RaaGRtRDJLZlpoaUlzSXRpbjJMUFpoU0RZdE5peDJMY2cyWVhZcU5tRzJZb2cyWUhaaWlEWmhkaXQyWVFnMlliWXRkaW9JTm1GMllIWXVkbUkyWVFnMktqWmh5SmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3hmU3g3SW5SbGVIUWlPaUxZcDltRTJLTFppdGlwSU5pbjJZVFlxdG1LSU5pbjJMVFlxdG1GMllUWXFpRFl1ZG1FMllrZzJLZllzOW1GSU5pMDJMSFl0eURaaGRpNTJMSFlxQ0RaaDltS09pSXNJbkJ2YVc1MGN5STZNQ3dpYVcxaFoyVWlPaUlpTENKcGJXRm5aVmRwWkhSb0lqb2lJaXdpYVcxaFoyVklaV2xuYUhRaU9pSWlMQ0owZVhCbElqb2liV054SWl3aVkyaHZhV05sY3lJNld5SjcyWWpaanRtRjJZN1lweURZcXRtTzJZSFprdGk1Mlk3WmhObVAyWWpZcDltU0lObUYyWkRaaHRtU0lOaXUyWTdaaXRtUzJMSFpqU0RaaXRtTzJMblprdG1FMlk3WmhkbVMyWWZaanlEWXA5bUUyWVRaa2RtTzJZZDlJaXdpZTltRjJZN1poaURaaXRtTzJMblprdG1GMlk3WmhObVNJTml6MlkvWmlOaWgyS2ZaaXlEWml0bVAyS3paa3RpeTJZNGcyS2paa05tSDJaQjlJaXdpZTlpajJZN1ppdG1SMlk3WmhkbU8yS2NnMktmWmhObVMyS1BaanRpczJZN1poTm1PMllyWmt0bUcyWkFnMllMWmp0aTIyWTdaaXRtUzJLclpqeURaZ2RtTzJZVFpqdGluSU5pNTJZL1lyOW1TMllqWmp0aW4yWWJaamlEWXVkbU8yWVRaanRtSzJaSFpqbjBpWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TW4wc2V5SjBaWGgwSWpvaTJZUFppdG1CMllYWXB5RFlxdGk1MktmWmhkbUVJTmluMllUWmh0aW4yTE1nMllyWXVkaW4yWVhaaE5tSTJZTXVJTmlsMkxuWXNkaW4yS2dnMktmWXM5bUZJTmluMllUWXROaXgyTGNnS0R4emNHRnVJSE4wZVd4bFBWd2labTl1ZEMxbVlXMXBiSGs2SUNaeGRXOTBPMjF2YUdGdGJXRmtJR0p2YkdRZ1lYSjBJREVtY1hWdmREc3NJSE5oYm5NdGMyVnlhV1k3WENJKzJZUFppdG1CMllYWXB6d3ZjM0JoYmo0cE9pSXNJbkJ2YVc1MGN5STZNQ3dpYVcxaFoyVWlPaUlpTENKcGJXRm5aVmRwWkhSb0lqb2lJaXdpYVcxaFoyVklaV2xuYUhRaU9pSWlMQ0owZVhCbElqb2liV054SWl3aVkyaHZhV05sY3lJNld5TFlwOWl6MllVZzJMVFlzZGkzSU5tRjJLalpodG1LSU5tQjJZb2cyWVhZcmRtRUlObUcyTFhZcUNEWmhkbUIyTG5aaU5tRUlOaW8yWWNpTENMWXA5aXoyWVVnMkxUWXNkaTNJTm1GMktqWmh0bUtJTm1CMllvZzJZWFlyZG1FSU5tRzJMWFlxQ0RaaGRtQjJMblppTm1FSU5tRjJMZlpoTm1DSWl3aTJLZllzOW1GSU5pMDJMSFl0eURaaGRpbzJZYlppaURaZ2RtS0lObUYySzNaaENEWmh0aTEyS2dnMkszWXA5bUVJaXdpMktmWXM5bUZJTmkwMkxIWXR5RFpoZGlvMlliWmlpRFpnZG1LSU5tRjJLM1poQ0RZc2RtQjJMa2cyWVhZcU5pcTJLL1lveUpkTENKamIzSnlaV04wUVc1emQyVnlJam95ZlN4N0luUmxlSFFpT2lJOGMzQmhiaUJ6ZEhsc1pUMWNJbVp2Ym5RdFptRnRhV3g1T2lCQlZGSkJSRUpFVHl3Z2MyRnVjeTF6WlhKcFpqdGNJajU3UEM5emNHRnVQdG1JMlk3WmhkbU8yWVlnMllyWmp0bUIyWkxZdWRtTzJZVFpraURZc05tTzJZVFprTm1EMlk0ZzJMblpqOWl2MlpMWmlObU8yS2ZaaHRpbjJZc2cyWWpaanRpNDJZL1poTm1TMllYWXA5bUxJTm1CMlk3WXM5bU8yWWpaa3RtQjJZNGcyWWJaajlpMTJaTFpoTm1RMllyWmg5bVFJTm1HMlk3WXA5aXgyS2ZaaXp4emNHRnVJSE4wZVd4bFBWd2labTl1ZEMxbVlXMXBiSGs2SUVGVVVrRkVRa1JQTENCellXNXpMWE5sY21sbU8xd2lQbjA4TDNOd1lXNCtJQzRnMkszWmc5bUZJTmluMllMWXF0aXgyS2ZaaGlEWXJObUkyS2ZZcUNEWXA5bUUyTFRZc2RpM0lOaW8yS2ZaaE5tQjJLZllvU0RaZ2RtS0lOaW4yWVRZb3RtSzJLa2cyS2ZaaE5pejJLZllxTm1DMktrdUlpd2ljRzlwYm5Seklqb3dMQ0pwYldGblpTSTZJaUlzSW1sdFlXZGxWMmxrZEdnaU9pSWlMQ0pwYldGblpVaGxhV2RvZENJNklpSXNJblI1Y0dVaU9pSnRZM0VpTENKamFHOXBZMlZ6SWpwYkl0aW4yWVRaaU5pczJZallxQ0lzSXRpbjJZVFlyTm1JMktmWXNpSmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3dmU3g3SW5SbGVIUWlPaUk4YzNCaGJpQnpkSGxzWlQxY0ltWnZiblF0Wm1GdGFXeDVPaUJCVkZKQlJFSkVUeXdnYzJGdWN5MXpaWEpwWmp0Y0lqNTdQQzl6Y0dGdVB0bUYyWTdaaGlEWml0bU8yWWZaa3RpdjJaQWcyS2ZaaE5tRTJaSFpqdG1IMlk4ZzJZSFpqdG1IMlkvWmlObU9JTmluMllUWmt0bUYyWS9aaDltUzJLclpqdGl2MlpEWmlqeHpjR0Z1SUhOMGVXeGxQVndpWm05dWRDMW1ZVzFwYkhrNklFRlVVa0ZFUWtSUExDQnpZVzV6TFhObGNtbG1PMXdpUG4wOEwzTndZVzQrSUM0ZzJMUFlxTmlvSU5pbjJZTFlxdGl4MktmWmhpRFlyTm1JMktmWXFDRFlwOW1FMkxUWXNkaTNJTmlvMktmWmhObUIyS2ZZb1NEWmdkbUtJTmluMllUWW90bUsyS2tnMktmWmhOaXoyS2ZZcU5tQzJLazZJaXdpY0c5cGJuUnpJam93TENKcGJXRm5aU0k2SWlJc0ltbHRZV2RsVjJsa2RHZ2lPaUlpTENKcGJXRm5aVWhsYVdkb2RDSTZJaUlzSW5SNWNHVWlPaUp0WTNFaUxDSmphRzlwWTJWeklqcGJJdGlzMllYWmhOaXBJTmluMllUWXROaXgyTGNnMkxmWmhOaW8yWXJZcVNJc0l0aXMyWVhaaE5pcElOaW4yWVRZdE5peDJMY2cyS2ZZczltRjJZcllxU0lzSXRpczJZWFpoTmlwSU5pbjJZVFl0Tml4MkxjZzJZWFl0ZGl2MlpIWXNkaXBJTmlvMllIWXVkbUVJTmlzMktmWmhkaXZJbDBzSW1OdmNuSmxZM1JCYm5OM1pYSWlPakY5TEhzaWRHVjRkQ0k2SXRpbjJZVFlyTm1GMllUWXFTRFlwOW1FMktyWmlpRFlwOWkwMktyWmhkbUUyS29nMkxuWmhObUpJTm1CMkxuWmhDRFpoZGkyMktmWXNkaTVJTm1GMkt6WXN0bUkyWVVnMktqWXJObUkyS2ZZcUNEWXA5bUUyTGZaaE5pbzJJd2cyWWZaaWpvaUxDSndiMmx1ZEhNaU9qQXNJbWx0WVdkbElqb2lJaXdpYVcxaFoyVlhhV1IwYUNJNklpSXNJbWx0WVdkbFNHVnBaMmgwSWpvaUlpd2lkSGx3WlNJNkltMWpjU0lzSW1Ob2IybGpaWE1pT2xzaTJZVFlweURZcXRpMTJLZllyZGlvSU5pbjJZVFlvOWkwMkxIWXA5aXhJTmlxMllIWXM5aXZJaXdpMks3WXNDRFpoZG1HSU5pajJLN1ppdG1ESU5tRjJLalpoTmk2MktmWml5RFlxdGl6MksvWXJ5RFlxTm1ISU5pdjJZclppTm1HMllNaUxDTFpoOW1FMktmWmtTRFlvOWkzMkxuWXFpRFppTmluMllUWXI5bUsyWU1nMktyWmdkbUUySzBpWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TW4wc2V5SjBaWGgwSWpvaTJZVFlweURZcXRtSDJZWFpoQ0RZcDltRTJMSFppdGluMkxiWXFTRFlxdG1GMkxIWXRpNGcyS2ZaaE5pMjJLall0eURZcDltRTJMWFlyZG1LMkswZzJZVFpnOW1FMllYWXFTQW9QSE53WVc0Z2MzUjViR1U5WENKbWIyNTBMV1poYldsc2VUb2dKbkYxYjNRN2JXOW9ZVzF0WVdRZ1ltOXNaQ0JoY25RZ01TWnhkVzkwT3l3Z2MyRnVjeTF6WlhKcFpqdGNJajdZcXRtRjJMSFl0and2YzNCaGJqNHBPaUlzSW5CdmFXNTBjeUk2TUN3aWFXMWhaMlVpT2lJaUxDSnBiV0ZuWlZkcFpIUm9Jam9pSWl3aWFXMWhaMlZJWldsbmFIUWlPaUlpTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZcXRtRjJMSFl0dG1TSWl3aTJLclpoZGl4MkxiWmp5SXNJdGlxMllYWXNkaTIyWTRpWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TVgwc2V5SjBaWGgwSWpvaUtOaWwyWVlnMllQWmh0aXFJTmlxMkszWXFDRFlwOW1FMks3Wml0aXhJTmluMllIWXVkbUUyWWNwTGlEWXA5bUUyS3paaGRtRTJLbllwOW1FMkxQWXA5aW8yWUxZcVNEWXRkaXQyWXJZcmRpcExpWnVZbk53T3lJc0ltbHRZV2RsSWpwdWRXeHNMQ0owZVhCbElqb2liV054SWl3aVkyaHZhV05sY3lJNld5TFl0ZGl0MllyWXJTSXNJdGl1MkxmWW95SmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3hmU3g3SW5SbGVIUWlPaUxZbzltS0lOaW8yWVRZcnlEWXF0aXoyS2ZaZ2RpeElOaWoyTFBZcDltQjJMRWcyWVhZdWRtRExpRFlwZGk1MkxIWXA5aW9JQ2pZbzltS0tUb2cyS2ZZczltRklOaTAyTEhZdHlEWmhkaW8yWWJaaWlEWmdkbUtJTm1GMkszWmhDRFpodGkxMktnZzJMallzZG1CSU5tRjJZUFlwOW1HTGladVluTndPeUlzSW5CdmFXNTBjeUk2TUN3aWFXMWhaMlVpT2lJaUxDSnBiV0ZuWlZkcFpIUm9Jam9pSWl3aWFXMWhaMlZJWldsbmFIUWlPaUlpTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZdGRpdDJZcllyU0lzSXRpdTJMZllveUpkTENKamIzSnlaV04wUVc1emQyVnlJam94ZlN4N0luUmxlSFFpT2lMWmhOaW5JTmlxMllMWXF0aXgyS2dnMllYWmhpRFlwOW1FMlliWXA5aXhJTmlxMkszWXNkbUMyWU11SU5pbjJZVFpnZGk1MllRZ0tOaXEySzNZc2RtQ0tTRFpoZGlzMkxMWmlObUZJTmlvMkt6WmlOaW4yS2dnMktmWmhOaTMyWVRZcUM0bWJtSnpjRHNpTENKd2IybHVkSE1pT2pBc0ltbHRZV2RsSWpvaUlpd2lhVzFoWjJWWGFXUjBhQ0k2SWlJc0ltbHRZV2RsU0dWcFoyaDBJam9pSWl3aWRIbHdaU0k2SW0xamNTSXNJbU5vYjJsalpYTWlPbHNpMkxYWXJkbUsySzBpTENMWXJ0aTMyS01pWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TVgwc2V5SjBaWGgwSWpvaTJZWFpoaURaaXRtSDJZWFpoQ0RZcjlpeDJZallzOW1ISU5tQjJZVFpoaURaaXRpcTJZSFppTm1DTGlEWml0aXMyS2dnMktmWmd0aXEyTEhZcDltR0lOaXMyWWpZcDlpb0lOaW4yWVRZdE5peDJMY2cyS2pZcDltRTJZSFlwOWloSU5tQjJZb2cyS2ZaaE5pczJZWFpoTmlwSU5pbjJZVFlzOWluMktqWmd0aXBMaVp1WW5Od095SXNJbkJ2YVc1MGN5STZNQ3dpYVcxaFoyVWlPaUlpTENKcGJXRm5aVmRwWkhSb0lqb2lJaXdpYVcxaFoyVklaV2xuYUhRaU9pSWlMQ0owZVhCbElqb2liV054SWl3aVkyaHZhV05sY3lJNld5TFl0ZGl0MllyWXJTSXNJdGl1MkxmWW95SmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3dmU3g3SW5SbGVIUWlPaUxaaE5tSTJZVFlweURZcXRpeTJZallzZG1HMktjZzJZYlpnOWl4MllYWmd5NGcyS2ZaaE5tQjJMblpoQ0FvMlliWmc5aXgyWVVwSU5tRjJLellzdG1JMllVZzJLallyTm1JMktmWXFDRFlwOW1FMkxmWmhOaW9MaVp1WW5Od095SXNJbkJ2YVc1MGN5STZNQ3dpYVcxaFoyVWlPaUlpTENKcGJXRm5aVmRwWkhSb0lqb2lJaXdpYVcxaFoyVklaV2xuYUhRaU9pSWlMQ0owZVhCbElqb2liV054SWl3aVkyaHZhV05sY3lJNld5TFl0ZGl0MllyWXJTSXNJdGl1MkxmWW95SmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3dmVjE5';
    const GEMINI_KEY = 'AIzaSyD7iNpwvjxQw3P2Ze72zRK-qr6-VvGkVVI';
    const SECRET_KEY = 'change-this-to-your-own-secret-phrase-12345';
    let fullExamData = JSON.parse(decodeURIComponent(escape(atob(atob(encodedData)))));

    try {
        if (fullExamData.config.botToken) fullExamData.config.botToken = CryptoJS.AES.decrypt(fullExamData.config.botToken, SECRET_KEY).toString(CryptoJS.enc.Utf8);
        if (fullExamData.config.chatId) fullExamData.config.chatId = CryptoJS.AES.decrypt(fullExamData.config.chatId, SECRET_KEY).toString(CryptoJS.enc.Utf8);
        if (fullExamData.config.githubToken) fullExamData.config.githubToken = CryptoJS.AES.decrypt(fullExamData.config.githubToken, SECRET_KEY).toString(CryptoJS.enc.Utf8);
    } catch (e) { console.error("Decryption Error"); }

    const CONFIG = {
        tts: fullExamData.config.enableTextToSpeech,
        ai: fullExamData.config.enableAITutor,
        retry: fullExamData.config.enableSmartRetry,
        layout: fullExamData.config.layout || 'one-by-one'
    };

    const GITHUB_OWNER = 'alshami2024';
    const GITHUB_REPO = 'alshami';

    let currentQuestions = [...fullExamData.questions];
    let studentAnswers = {};
    let currentIndex = 0;
    let studentName = "";
    let isRetryMode = false;
    let timerInterval;
    let tabSwitchCount = 0;
    let examFinished = false;

    function validateAndStart() {
        const nameInput = document.getElementById('studentName').value.trim();
        if(!nameInput) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
        
        if (fullExamData.config.accessControl && fullExamData.config.accessControl.enabled) {
            const codeInput = document.getElementById('accessCode').value.trim();
            const valid = fullExamData.config.accessControl.students.some(s => 
                s.name.trim().toLowerCase() === nameInput.toLowerCase() && s.code === codeInput
            );
            if (!valid) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        }

        studentName = nameInput;
        document.getElementById('studentNameDisplay').textContent = studentName;
        
        const uniqueId = `exam_${fullExamData.config.title}_${studentName}`;
        if(fullExamData.config.singleUseMode && localStorage.getItem(uniqueId)){
            return alert("Ù„Ù‚Ø¯ Ø£Ø¯ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
        }
        if(fullExamData.config.singleUseMode) localStorage.setItem(uniqueId, 'true');

        sendTelegramNotification(`ğŸ”” *Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø±*\nØ§Ù„Ø·Ø§Ù„Ø¨: ${studentName}\nØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${fullExamData.config.title}`);
        
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('examArea').style.display = 'block';

        if(fullExamData.config.shuffle && !isRetryMode) currentQuestions.sort(() => Math.random() - 0.5);
        if(fullExamData.config.time > 0) startTimer(fullExamData.config.time * 60);
        else document.getElementById('timer').style.display = 'none';

        setupSecurity();
        renderExam();
    }

    function renderExam() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        if(CONFIG.layout === 'one-by-one') {
            renderSingleQuestion(currentIndex, container);
        } else {
            currentQuestions.forEach((q, idx) => {
                const wrapper = document.createElement('div');
                renderSingleQuestion(idx, wrapper);
                container.appendChild(wrapper);
            });
        }
        updateNav();
        updateProgress();
    }

    function renderSingleQuestion(idx, container) {
        const q = currentQuestions[idx];
        const voiceBtn = CONFIG.tts ? `<button class="voice-btn" onclick="speak('${q.text.replace(/'/g, "\\'")}')" title="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¤Ø§Ù„"><i class="fa-solid fa-volume-high"></i></button>` : '';
        const imgHtml = q.image ? `<div style="text-align:center; margin-bottom:10px;"><img src="${q.image}" style="max-width:100%; border-radius:8px; max-height:200px;"></div>` : '';

        let html = `
            <div class="question-card" id="q-card-${idx}">
                ${voiceBtn}
                ${imgHtml}
                <h3 style="margin-top:0; padding-right: ${CONFIG.tts?40:0}px;">${idx + 1}. ${q.text}</h3>
        `;

        if(q.type === 'mcq' || q.type === 'tf') {
            const options = q.type === 'tf' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.choices;
            html += '<ul class="choices">';
            options.forEach((opt, optIdx) => {
                const isSelected = studentAnswers[idx] === optIdx ? 'selected' : '';
                html += `<li class="${isSelected}" onclick="selectOption(${idx}, ${optIdx}, this)">
                    <div style="width:20px; height:20px; border:2px solid #ccc; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-left:10px;">
                        ${isSelected ? '<div style="width:10px; height:10px; background:var(--primary-color); border-radius:50%;"></div>' : ''}
                    </div>
                    ${opt}
                </li>`;
            });
            html += '</ul>';
        } else {
            html += `<textarea style="width:100%; border:1px solid #ddd; padding:10px; border-radius:8px;" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." oninput="studentAnswers[${idx}]=this.value">${studentAnswers[idx]||''}</textarea>`;
        }
        
        html += '</div>';
        container.innerHTML += html;
    }

    function selectOption(qIdx, optIdx, el) {
        studentAnswers[qIdx] = optIdx;
        if(CONFIG.layout === 'one-by-one') {
            const parent = el.parentElement;
            parent.querySelectorAll('li').forEach(l => {
                l.classList.remove('selected');
                l.querySelector('div').innerHTML = '';
            });
            el.classList.add('selected');
            el.querySelector('div').innerHTML = '<div style="width:10px; height:10px; background:var(--primary-color); border-radius:50%;"></div>';
            
            if(fullExamData.config.learningMode && !isRetryMode) {
                 const isCorrect = optIdx === currentQuestions[qIdx].correctAnswer;
                 el.style.background = isCorrect ? '#d4edda' : '#f8d7da';
                 el.style.borderColor = isCorrect ? '#c3e6cb' : '#f5c6cb';
            }
        } else {
            renderExam(); 
        }
        updateProgress();
    }

    function updateNav() {
        const navDiv = document.getElementById('navButtons');
        navDiv.innerHTML = '';
        
        if(CONFIG.layout === 'one-by-one') {
            if(currentIndex > 0 && !fullExamData.config.noGoingBack) {
                navDiv.innerHTML += `<button class="btn" style="background:#6c757d" onclick="currentIndex--; renderExam()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>`;
            }
            if(currentIndex < currentQuestions.length - 1) {
                navDiv.innerHTML += `<button class="btn" onclick="currentIndex++; renderExam()">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
            } else {
                navDiv.innerHTML += `<button class="btn btn-danger" onclick="finishExamWrapper()">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ³Ù„ÙŠÙ… ğŸ</button>`;
            }
        } else {
            navDiv.innerHTML += `<button class="btn btn-danger" style="width:100%" onclick="finishExamWrapper()">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ğŸ</button>`;
        }
    }

    function updateProgress() {
        const answered = Object.keys(studentAnswers).length;
        const total = currentQuestions.length;
        const pct = (answered / total) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
    }

    async function finishExamWrapper() {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ")) return;
        finishExam();
    }

    async function finishExam() {
        if(examFinished) return;
        examFinished = true;
        clearInterval(timerInterval);
        
        document.getElementById('examArea').style.display = 'none';
        document.getElementById('savingScreen').style.display = 'block';

        let correct = 0;
        let total = 0;
        let wrongIndices = [];
        currentQuestions.forEach((q, i) => {
            if(q.type === 'mcq' || q.type === 'tf') {
                total++;
                if(studentAnswers[i] === q.correctAnswer) correct++;
                else wrongIndices.push(i);
            }
        });
        const percentage = total > 0 ? Math.round((correct/total)*100) : 0;

        if(fullExamData.config.githubToken && fullExamData.config.resultsFilename) {
            await saveToGithub(correct, total, wrongIndices);
        }

        await sendTelegramNotification(`ğŸ“Š *Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø±*\nØ§Ù„Ø·Ø§Ù„Ø¨: ${studentName}\nØ§Ù„Ù†ØªÙŠØ¬Ø©: ${correct} / ${total} (${percentage}%)\nØ®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙØ­Ø©: ${tabSwitchCount}`);

        document.getElementById('savingScreen').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'block';
        document.getElementById('scoreDisplay').innerHTML = `${correct} <span style="font-size:1rem; color:#888;">/ ${total}</span>`;
        
        let actionsHtml = '';
        if(CONFIG.retry && wrongIndices.length > 0) {
            actionsHtml += `<button class="btn btn-warning" onclick='startSmartRetry(${JSON.stringify(wrongIndices)})'><i class="fa-solid fa-rotate-left"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø®Ø·Ø§Ø¦ÙŠ ÙÙ‚Ø·</button>`;
        }
        if(fullExamData.config.enableReview) {
            actionsHtml += `<button class="btn btn-success" onclick='window.print()'><i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>`;
        }
        document.getElementById('actionButtons').innerHTML = actionsHtml;

        if(fullExamData.config.enableCertificate && percentage >= fullExamData.config.successPercentage) {
            document.getElementById('certificateArea').style.display = 'block';
            document.getElementById('certName').textContent = studentName;
            document.getElementById('certScore').textContent = percentage + "%";
            document.getElementById('certDate').textContent = new Date().toLocaleDateString('ar-EG');
        }

        if(fullExamData.config.showResults && fullExamData.config.enableReview) {
            renderDetailedReview(wrongIndices);
        }
    }

    function renderDetailedReview(wrongIndices) {
        const div = document.getElementById('reviewArea');
        div.innerHTML = '<h3 style="border-bottom:2px solid #eee; padding-bottom:10px;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3>';
        
        currentQuestions.forEach((q, i) => {
            const userAnsIdx = studentAnswers[i];
            const isCorrect = userAnsIdx === q.correctAnswer;
            
            let userAnsText = "Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©";
            let correctAnsText = "";
            
            if(q.type === 'mcq' || q.type === 'tf') {
                const opts = q.type === 'tf' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.choices;
                if(userAnsIdx !== undefined) userAnsText = opts[userAnsIdx];
                correctAnsText = opts[q.correctAnswer];
            } else {
                userAnsText = studentAnswers[i] || "";
                correctAnsText = "Ù…ØªØ±ÙˆÙƒ Ù„Ù„Ù…ØµØ­Ø­";
            }

            const bg = isCorrect ? '#d4edda' : '#f8d7da';
            const icon = isCorrect ? 'âœ”ï¸' : 'âŒ';

            let aiBtn = '';
            if(!isCorrect && CONFIG.ai && GEMINI_KEY && (q.type==='mcq'||q.type==='tf')) {
                aiBtn = `<button class="btn" style="font-size:0.8rem; background:#673ab7; margin-top:10px;" onclick="askAI(this, ${i})"><i class="fa-solid fa-robot"></i> Ù„Ù…Ø§Ø°Ø§ Ø¥Ø¬Ø§Ø¨ØªÙŠ Ø®Ø§Ø·Ø¦Ø©ØŸ</button>
                         <div id="ai-res-${i}" class="ai-explanation-box"></div>`;
            }

            div.innerHTML += `
                <div class="question-card" style="background:${bg}; border-color:${isCorrect?'#c3e6cb':'#f5c6cb'}">
                    <p><strong>${i+1}. ${q.text}</strong></p>
                    <p>Ø¥Ø¬Ø§Ø¨ØªÙƒ: <b>${userAnsText}</b> ${icon}</p>
                    ${!isCorrect ? `<p style="color:#155724;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <b>${correctAnsText}</b></p>` : ''}
                    ${aiBtn}
                </div>
            `;
        });
    }

    async function askAI(btn, idx) {
        const q = currentQuestions[idx];
        const opts = q.type === 'tf' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.choices;
        const userTxt = opts[studentAnswers[idx]] || "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
        const corrTxt = opts[q.correctAnswer];
        
        const resBox = document.getElementById(`ai-res-${idx}`);
        resBox.style.display = 'block';
        resBox.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ...';
        btn.disabled = true;

        const prompt = `Ø§Ø´Ø±Ø­ Ù„Ø·Ø§Ù„Ø¨ Ù„Ù…Ø§Ø°Ø§ Ø¥Ø¬Ø§Ø¨ØªÙ‡ Ø®Ø§Ø·Ø¦Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ø®ØªØµØ§Ø±. Ø§Ù„Ø³Ø¤Ø§Ù„: "${q.text}". Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: "${userTxt}". Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: "${corrTxt}".`;
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            resBox.innerHTML = `<strong>ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ:</strong><br>${data.candidates[0].content.parts[0].text}`;
        } catch(e) {
            resBox.innerHTML = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.';
            btn.disabled = false;
        }
    }

    function speak(text) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-SA';
            window.speechSynthesis.speak(u);
        }
    }

    function startSmartRetry(indices) {
        const wrongQs = indices.map(i => currentQuestions[i]);
        currentQuestions = wrongQs;
        studentAnswers = {};
        currentIndex = 0;
        isRetryMode = true;
        
        document.getElementById('resultScreen').style.display = 'none';
        document.getElementById('examArea').style.display = 'block';
        renderExam();
        alert("Ø¨Ø¯Ø£Øª Ø¬ÙˆÙ„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©! Ø±ÙƒØ² Ø¬ÙŠØ¯Ø§Ù‹ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø© ğŸ’ª");
    }

    async function saveToGithub(correct, total, wrongIndices) {
        const { githubToken, resultsFilename } = fullExamData.config;
        if(!githubToken || !resultsFilename) return;
        
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/exam1/${resultsFilename}`;
        
        const resultPayload = {
            studentName: studentName,
            submissionDate: new Date().toISOString(),
            score: { correct, total },
            wrongAnswers: wrongIndices, 
            tabSwitchCount: tabSwitchCount
        };

        try {
            let currentData = [];
            let sha = null;
            try {
                const getRes = await fetch(url, { headers: { 'Authorization': `token ${githubToken}` } });
                if(getRes.ok) {
                    const json = await getRes.json();
                    sha = json.sha;
                    currentData = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                }
            } catch(e){}

            currentData.push(resultPayload);
            const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2))));
            
            await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'New Result', content: contentEncoded, sha: sha })
            });
        } catch(e) { console.error("Github Save Failed", e); }
    }

    async function sendTelegramNotification(text) {
        const { botToken, chatId } = fullExamData.config;
        if(!botToken || !chatId) return;
        try {
            await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'Markdown' })
            });
        } catch(e){}
    }

    function startTimer(seconds) {
        const display = document.getElementById('timer');
        let remaining = seconds;
        timerInterval = setInterval(() => {
            remaining--;
            const m = Math.floor(remaining / 60).toString().padStart(2, '0');
            const s = (remaining % 60).toString().padStart(2, '0');
            display.textContent = `${m}:${s}`;
            if(remaining <= 0) {
                clearInterval(timerInterval);
                alert("Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!");
                finishExam();
            }
        }, 1000);
    }

    function setupSecurity() {
        if(fullExamData.config.disableCheating) {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('copy', e => e.preventDefault());
        }
        if(fullExamData.config.monitorTabs) {
            document.addEventListener('visibilitychange', () => {
                if(document.hidden && !examFinished) {
                    tabSwitchCount++;
                    if(fullExamData.config.finishOnSwitch) {
                        finishExam();
                        alert("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙØ­Ø©!");
                    }
                }
            });
        }
    }
</script>
</body>
</html>
    