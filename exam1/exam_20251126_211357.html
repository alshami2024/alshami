
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ™ÿØÿ±Ÿäÿ®ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ÿπ ŸÖÿ∑Ÿàÿ± ÿ±ŸÇŸÖ (3) </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© --- */
        :root { 
            --primary-color: #0056b3; --secondary-color: #007bff; 
            --light-gray: #f8f9fa; --dark-gray: #343a40; 
            --success-color: #28a745; --danger-color: #dc3545; 
            --background-color: #e9ecef; --text-color: #212529; --white: #fff; 
        }
        
        /* --- ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© (ŸÖŸàÿ®ÿßŸäŸÑ ÿ£ŸàŸÑÿßŸã) --- */
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--background-color); 
            margin: 0; 
            padding: 10px; 
            color: var(--text-color); 
            direction: rtl; 
            line-height: 1.6;
        }

        .container { 
            background-color: var(--white); 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-width: 100%; 
            margin: 0 auto; 
            padding: 20px; 
            box-sizing: border-box;
        }

        h1 { font-size: 1.5rem; margin-bottom: 10px; color: var(--dark-gray); }
        h2 { font-size: 1.2rem; color: var(--dark-gray); }

        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input[type="text"], .form-group textarea { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 16px; 
            box-sizing: border-box;
        }

        .btn { 
            background-color: var(--primary-color); color: var(--white); border: none; 
            padding: 14px 20px; font-size: 16px; font-weight: bold; border-radius: 10px; 
            cursor: pointer; transition: background-color 0.3s; 
            width: 100%; 
            display: block;
            margin-bottom: 10px;
        }
        .btn:hover { background-color: #004a99; } 
        .btn:disabled { background-color: #ccc; }
        .btn-danger { background-color: var(--danger-color); }

        .question-card { 
            background: var(--light-gray); border: 1px solid #dee2e6; 
            border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: right; 
        }
        
        .exam-header { 
            display: flex; flex-direction: column; 
            gap: 10px; align-items: center; margin-bottom: 20px; text-align: center;
        }
        
        .timer { 
            font-size: 1.2em; color: var(--danger-color); font-weight: bold; 
            background: #fff; padding: 5px 15px; border-radius: 20px; border: 1px solid #ddd;
        }

        .choices li { 
            padding: 12px; margin: 8px 0; background: var(--white); 
            border: 1px solid #ddd; border-radius: 8px; cursor: pointer; 
            transition: all 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .choices li:active { background-color: #e3f2fd; }
        .choices li label { cursor: pointer; flex: 1; }
        .choices li.correct { background-color: #d4edda !important; border-color: #c3e6cb; }
        .choices li.incorrect { background-color: #f8d7da !important; border-color: #f5c6cb; }

        /* ÿ™ŸÜÿ≥ŸäŸÇ ÿ≠ŸÇŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÖŸÇÿßŸÑŸä */
        .essay-answer { 
            width: 100%;             /* ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ */
            box-sizing: border-box;  /* ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿ≠ŸàÿßŸÅ ÿ∂ŸÖŸÜ ÿßŸÑÿπÿ±ÿ∂ ŸÑŸÖŸÜÿπ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿπŸÜ ÿßŸÑÿ¥ÿßÿ¥ÿ© */
            min-height: 150px;       /* ÿßÿ±ÿ™ŸÅÿßÿπ ÿ£ÿØŸÜŸâ ŸÖÿ±Ÿäÿ≠ ŸÑŸÑŸÉÿ™ÿßÿ®ÿ© */
            padding: 12px 15px;      /* ŸÖÿ≥ÿßŸÅÿßÿ™ ÿØÿßÿÆŸÑŸäÿ© ŸÖÿ±Ÿäÿ≠ÿ© */
            border: 1px solid #ccc;  /* ÿ•ÿ∑ÿßÿ± ŸÜÿßÿπŸÖ */
            border-radius: 8px;      /* ÿ≠ŸàÿßŸÅ ÿØÿßÿ¶ÿ±Ÿäÿ© */
            font-family: inherit;    /* ŸÜŸÅÿ≥ ÿÆÿ∑ ÿßŸÑÿµŸÅÿ≠ÿ© (ÿ™ÿ¨ŸàŸëÿßŸÑ) */
            font-size: 16px;         /* ÿ≠ÿ¨ŸÖ ÿÆÿ∑ ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑŸÇÿ±ÿßÿ°ÿ© */
            line-height: 1.6;        /* ÿ™ÿ®ÿßÿπÿØ ÿ£ÿ≥ÿ∑ÿ± ŸÖÿ±Ÿäÿ≠ */
            resize: vertical;        /* ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ÿπŸÖŸàÿØŸäÿßŸã ŸÅŸÇÿ∑ */
            margin-top: 10px;        /* ŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸàÿßŸÑÿ≠ŸÇŸÑ */
            background-color: #fff;  /* ŸÑŸàŸÜ ÿÆŸÑŸÅŸäÿ© ÿ£ÿ®Ÿäÿ∂ */
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÉÿ™ÿßÿ®ÿ© */
        .essay-answer:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }
        
        #navigation-buttons { display: flex; gap: 10px; margin-top: 20px; }
        #progressBarContainer { width: 100%; background-color: #e9ecef; border-radius: 20px; margin-bottom: 25px; height: 10px; }
        #progressBar { height: 100%; background-color: var(--success-color); border-radius: 20px; transition: width 0.5s; }

        .q-image-container { text-align: center; margin-bottom: 15px; width: 100%; }
        .q-image { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .saving-screen { text-align: center; padding: 30px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (min-width: 768px) {
            body { padding: 40px; background-color: #e0e5ec; }
            .container { width: 80%; max-width: 900px; padding: 40px; border-radius: 16px; }
            h1 { font-size: 2.2rem; }
            .btn { width: auto; display: inline-block; min-width: 150px; margin-left: 10px; }
            .exam-header { flex-direction: row; justify-content: space-between; }
            .question-card { padding: 30px; }
            .choices li:hover { transform: translateX(-5px); background-color: #f1f8ff; }
            #navigation-buttons { justify-content: flex-end; }
        }
        
    </style>
</head>
<body>
<div class="container">
    <div id="studentExamView" style="display:block;">
        <div id="startScreen" style="display:block;">
            <h1 id="examTitleStudent"></h1>
            <p id="examDescriptionStudent" style="white-space: pre-wrap; color:#666;"></p>
            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
            
            <div class="form-group">
                <label for="studentName">ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                <input type="text" id="studentName" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
            </div>
            
        
            <button id="startExamBtn" class="btn">ÿ®ÿØÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± üöÄ</button>
        </div>

        <div id="examArea" style="display:none;">
            <div class="exam-header">
                <h3 id="welcomeStudent" style="margin:0;"></h3>
                <div id="timer" class="timer">00:00</div>
            </div>
            <div id="progressBarContainer" title="ÿßŸÑÿ™ŸÇÿØŸÖ"><div id="progressBar"></div></div>
            <div id="questionsContainer"></div>
            <div id="navigation-buttons"></div>
            <button id="finishExamBtn" class="btn btn-danger" style="margin-top: 30px; width:100%;">ÿ•ŸÜŸáÿßÿ° Ÿàÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± üèÅ</button>
        </div>

        <div id="savingResultsScreen" class="saving-screen" style="display:none;">
            <div class="spinner"></div>
            <h3>ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ...</h3>
            <p>ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸàÿπÿØŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©.</p>
        </div>

        <div id="resultContainer" style="display:none;">
             <div style="text-align:center; margin-bottom:20px;">
                <h2 id="resultTitle"></h2>
                <p id="resultSummary" style="font-size:1.1em; margin-top:10px;"></p>
             </div>
             <div id="reviewContainer"></div>
             <div id="certificate" style="display:none; border: 5px double var(--primary-color); padding: 30px; margin-top: 30px; text-align: center; background: #fff;">
                <h2 style="color:var(--primary-color);">ÿ¥ŸáÿßÿØÿ© ÿ•ÿ™ŸÖÿßŸÖ</h2>
                <p>ÿ™ÿ¥ŸáÿØ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿ£ŸÜ ÿßŸÑÿ∑ÿßŸÑÿ®/ÿ©:</p>
                <h1 id="certName" style="color:#333;"></h1>
                <p>ŸÇÿØ ÿ£ÿ™ŸÖ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠ Ÿàÿ≠ÿµŸÑ ÿπŸÑŸâ ÿØÿ±ÿ¨ÿ©:</p>
                <h2 id="certScore" style="color:var(--success-color);"></h2>
                <p>ÿ®ÿ™ÿßÿ±ŸäÿÆ: <span id="certDate"></span></p>
            </div>
        </div>
    </div>
</div>
    <script>
        const encodedExamData = 'ZXlKamIyNW1hV2NpT25zaWRHbDBiR1VpT2lMWXF0aXYyTEhaaXRpbzJLZllxaURZcDltRTJMUFlwOWlvMkxrZzJZWFl0OW1JMkxFZzJMSFpndG1GSUNnektTQWlMQ0prWlhOamNtbHdkR2x2YmlJNkl0aW4ySzdZcXRpbzJLZllzU0RaaGRpdTJMWFl0VG9nMktmWmhObUcySzNaaUNEWXM5aW4yS2pZdVNEWmhkaTMyWWpZc1NCOElOaXZMaURZdWRpbzJLL1lwOW1FMkxIWmd0bUsyS2dnMktmWmhOaTAyS2ZaaGRtS0lId2cyS2ZaaE5pejJLZllxTmk1SU5tRjJMZlppTml4SWl3aWMzUmhjblJVYVcxbElqb2lNakF5TlMweE1TMHlObFF5TVRveE5DSXNJbVZ1WkZScGJXVWlPaUl5TURJMUxURXhMVE13VkRJek9qVTVJaXdpYkdGNWIzVjBJam9pYjI1bExXSjVMVzl1WlNJc0luUnBiV1VpT2pZd0xDSnphSFZtWm14bElqcDBjblZsTENKdWIwZHZhVzVuUW1GamF5STZabUZzYzJVc0ltUnBjMkZpYkdWRGFHVmhkR2x1WnlJNlptRnNjMlVzSW0xdmJtbDBiM0pVWVdKeklqcDBjblZsTENKbWFXNXBjMmhQYmxOM2FYUmphQ0k2Wm1Gc2MyVXNJbXhsWVhKdWFXNW5UVzlrWlNJNlptRnNjMlVzSW5OcGJtZHNaVlZ6WlUxdlpHVWlPblJ5ZFdVc0luTm9iM2RTWlhOMWJIUnpJanAwY25WbExDSmxibUZpYkdWU1pYWnBaWGNpT21aaGJITmxMQ0psYm1GaWJHVkRaWEowYVdacFkyRjBaU0k2ZEhKMVpTd2lkR2hsYldVaU9pSmtaV1poZFd4MElpd2ljM1ZqWTJWemMxQmxjbU5sYm5SaFoyVWlPalF3TENKaWIzUlViMnRsYmlJNklsVXlSbk5rUjFacldERTRWWGhFWkdOTmJtTkROSGxKUkRVMFpUVlpUVWxOU0ZWb1ltbDNORVZqS3k5T2EyZFVhekpZUldaS01XaE5VMmhOVWtSb1QwNVJObmhtVUdKTU5YRXlNVWhCVG0wM1NXNW9VSHBuUFQwaUxDSmphR0YwU1dRaU9pSlZNa1p6WkVkV2ExZ3hPVFkwTm10S1VDdExXblJ0WW5Ka1ZsSjFWa3RZTm5kMFZHNUpZMjFuVTBodlBTSXNJbWRwZEdoMVlsUnZhMlZ1SWpvaVZUSkdjMlJIVm10WU1TOUhXRlZGVUhWUlRWRmtSbEpNYURSbE16ZHNUa2h0VEUwNFZIRlBVMHhGY2k5eksxWjFWbG95TjFWNlFUZDRZVXB6VG1acU1EbHFNME54YzJwVVVYUlZNR0ZXWkRGV1FrRnNVMEU5UFNJc0luSmxjM1ZzZEhOR2FXeGxibUZ0WlNJNkluUmxjM1JzWVhjdWFuTnZiaUlzSW1GalkyVnpjME52Ym5SeWIyd2lPbnNpWlc1aFlteGxaQ0k2Wm1Gc2MyVXNJbk4wZFdSbGJuUnpJanBiWFgxOUxDSnhkV1Z6ZEdsdmJuTWlPbHQ3SW5SbGVIUWlPaUxaZzltRUlObUYyS2NnMllyWW85aXEyWW9nMllYWmhpRFlvOWl2MllqWXA5aXFJTmluMllUWXROaXgyTGNnMktQWXM5bUYyS2ZZb1NEWXVkaXYyS2M2SWl3aWNHOXBiblJ6SWpvd0xDSnBiV0ZuWlNJNklpSXNJbWx0WVdkbFYybGtkR2dpT2lJaUxDSnBiV0ZuWlVobGFXZG9kQ0k2SWlJc0luUjVjR1VpT2lKdFkzRWlMQ0pqYUc5cFkyVnpJanBiSXRtRjJZZlpoZGluSWl3aTJLWFlzTm1GMktjaUxDTFlyZG1LMkt2WmhkaW5JaXdpMllYWXF0bUpJbDBzSW1OdmNuSmxZM1JCYm5OM1pYSWlPakY5TEhzaWRHVjRkQ0k2SXRtRDJZUWcyS1BZczltRjJLZllvU0RZcDltRTJMVFlzZGkzSU5tRjJLalpodG1LMktrZzJMbllyOWluT2lJc0luQnZhVzUwY3lJNk1Dd2lhVzFoWjJVaU9pSWlMQ0pwYldGblpWZHBaSFJvSWpvaUlpd2lhVzFoWjJWSVpXbG5hSFFpT2lJaUxDSjBlWEJsSWpvaWJXTnhJaXdpWTJodmFXTmxjeUk2V3lMWmhkaXEyWWtpTENMWmhkbUdJaXdpMktQWmlpSXNJdG1GMktjaVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1uMHNleUowWlhoMElqb2kyWVhaaDltRjJLY21ibUp6Y0RzZzJLcll0OWk1SU5tSTJLZlpoTml2MllyWmd5RFppdGl4MkxZZzJLZlpoTm1FMlljZzJMblpodG1ETGlEWXBkaTUyTEhZcDlpb0lOaW4yTFBaaFNEWXA5bUUyTFRZc2RpM0lDZzhjM0JoYmlCemRIbHNaVDFjSW1admJuUXRabUZ0YVd4NU9pQW1jWFZ2ZER0dGIyaGhiVzFoWkNCaWIyeGtJR0Z5ZENBeEpuRjFiM1E3TENCellXNXpMWE5sY21sbU8xd2lQdG1GMllmWmhkaW5QQzl6Y0dGdVBpazZJaXdpY0c5cGJuUnpJam93TENKcGJXRm5aU0k2SWlJc0ltbHRZV2RsVjJsa2RHZ2lPaUlpTENKcGJXRm5aVWhsYVdkb2RDSTZJaUlzSW5SNWNHVWlPaUp0WTNFaUxDSmphRzlwWTJWeklqcGJJdGluMkxQWmhTRFl0Tml4MkxjZzJZWFlxTm1HMllvZzJZSFppaURaaGRpdDJZUWcyTEhaZ2RpNUlObUYyS2pZcXRpdjJLTWlMQ0xZcDlpejJZVWcyTFRZc2RpM0lObUYyS2paaHRtS0lObUIyWW9nMllYWXJkbUVJTm1HMkxYWXFDRFpoZG1CMkxuWmlObUVJTmlvMlljaVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1IMHNleUowWlhoMElqb2lQSE53WVc0Z2MzUjViR1U5WENKbWIyNTBMV1poYldsc2VUb2dRVlJTUVVSQ1JFOHNJSE5oYm5NdGMyVnlhV1k3WENJK2V6d3ZjM0JoYmo3WW85bU8yWXJaa3RtRzJZN1poZG1PMktjZzJLclpqdG1EMlkvWmlObUcyWS9aaU5pbjJaSWcyWXJaajlpdjJaTFlzZG1RMllQWmtkbVAyWVhaanlEWXA5bUUyWkxaaGRtTzJZalprdGlxMlk4OGMzQmhiaUJ6ZEhsc1pUMWNJbVp2Ym5RdFptRnRhV3g1T2lCQlZGSkJSRUpFVHl3Z2MyRnVjeTF6WlhKcFpqdGNJajU5UEM5emNHRnVQaUF1SU5pbDJMbllzZGluMktnZzJLZllzOW1GSU5pbjJZVFl0Tml4MkxjZ0tEeHpjR0Z1SUhOMGVXeGxQVndpWm05dWRDMW1ZVzFwYkhrNklDWnhkVzkwTzIxdmFHRnRiV0ZrSUdKdmJHUWdZWEowSURFbWNYVnZkRHNzSUhOaGJuTXRjMlZ5YVdZN1hDSSsyS1BaaXRtRzJZWFlwend2YzNCaGJqNHBPaUlzSW5CdmFXNTBjeUk2TUN3aWFXMWhaMlVpT2lJaUxDSnBiV0ZuWlZkcFpIUm9Jam9pSWl3aWFXMWhaMlZJWldsbmFIUWlPaUlpTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZcDlpejJZVWcyTFRZc2RpM0lObUYyS2paaHRtS0lObUIyWW9nMllYWXJkbUVJTm1HMkxYWXFDRFl1Tml4MllFZzJMTFpoZGluMllZaUxDTFlwOWl6MllVZzJMVFlzZGkzSU5tRjJLalpodG1LSU5tQjJZb2cyWVhZcmRtRUlObUcyTFhZcUNEWXVOaXgyWUVnMllYWmc5aW4yWVlpTENMWXA5aXoyWVVnMkxUWXNkaTNJTm1GMktqWmh0bUtJTm1CMllvZzJZWFlyZG1FSU5tRzJMWFlxQ0RaaGRtQjJMblppTm1FSU5pbzJZY2lYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNWDBzZXlKMFpYaDBJam9pMktmWmhOaWkyWXJZcVNEWXA5bUUyS3JaaWlEWXA5aTAyS3JaaGRtRTJLb2cyTG5aaE5tSklOaW4yTFBaaFNEWXROaXgyTGNnMllYWXVkaXgyS2dnMllmWmlqb2lMQ0p3YjJsdWRITWlPakFzSW1sdFlXZGxJam9pSWl3aWFXMWhaMlZYYVdSMGFDSTZJaUlzSW1sdFlXZGxTR1ZwWjJoMElqb2lJaXdpZEhsd1pTSTZJbTFqY1NJc0ltTm9iMmxqWlhNaU9sc2llOW1JMlk3WmhkbU8yS2NnMktyWmp0bUIyWkxZdWRtTzJZVFpqOW1JMktmWmtpRFpoZG1RMlliWmtpRFlydG1PMllyWmt0aXgyWTBnMllyWmp0aTUyWkxaaE5tTzJZWFprdG1IMlk4ZzJLZlpoTm1FMlpIWmp0bUhmU0lzSW52WmhkbU8yWVlnMllyWmp0aTUyWkxaaGRtTzJZVFpraURZczltUDJZallvZGluMllzZzJZclpqOWlzMlpMWXN0bU9JTmlvMlpEWmg5bVFmU0lzSW52WW85bU8yWXJaa2RtTzJZWFpqdGluSU5pbjJZVFprdGlqMlk3WXJObU8yWVRaanRtSzJaTFpodG1RSU5tQzJZN1l0dG1PMllyWmt0aXEyWThnMllIWmp0bUUyWTdZcHlEWXVkbVAySy9aa3RtSTJZN1lwOW1HMlk0ZzJMblpqdG1FMlk3Wml0bVIyWTU5SWwwc0ltTnZjbkpsWTNSQmJuTjNaWElpT2pKOUxIc2lkR1Y0ZENJNkl0bUQyWXJaZ2RtRjJLY2cyS3JZdWRpbjJZWFpoQ0RZcDltRTJZYllwOWl6SU5tSzJMbllwOW1GMllUWmlObURMaURZcGRpNTJMSFlwOWlvSU5pbjJMUFpoU0RZcDltRTJMVFlzZGkzSUNnOGMzQmhiaUJ6ZEhsc1pUMWNJbVp2Ym5RdFptRnRhV3g1T2lBbWNYVnZkRHR0YjJoaGJXMWhaQ0JpYjJ4a0lHRnlkQ0F4Sm5GMWIzUTdMQ0J6WVc1ekxYTmxjbWxtTzF3aVB0bUQyWXJaZ2RtRjJLYzhMM053WVc0K0tUb2lMQ0p3YjJsdWRITWlPakFzSW1sdFlXZGxJam9pSWl3aWFXMWhaMlZYYVdSMGFDSTZJaUlzSW1sdFlXZGxTR1ZwWjJoMElqb2lJaXdpZEhsd1pTSTZJbTFqY1NJc0ltTm9iMmxqWlhNaU9sc2kyS2ZZczltRklOaTAyTEhZdHlEWmhkaW8yWWJaaWlEWmdkbUtJTm1GMkszWmhDRFpodGkxMktnZzJZWFpnZGk1MllqWmhDRFlxTm1ISWl3aTJLZllzOW1GSU5pMDJMSFl0eURaaGRpbzJZYlppaURaZ2RtS0lObUYySzNaaENEWmh0aTEyS2dnMllYWmdkaTUyWWpaaENEWmhkaTMyWVRaZ2lJc0l0aW4yTFBaaFNEWXROaXgyTGNnMllYWXFObUcyWW9nMllIWmlpRFpoZGl0MllRZzJZYll0ZGlvSU5pdDJLZlpoQ0lzSXRpbjJMUFpoU0RZdE5peDJMY2cyWVhZcU5tRzJZb2cyWUhaaWlEWmhkaXQyWVFnMkxIWmdkaTVJTm1GMktqWXF0aXYyS01pWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TW4wc2V5SjBaWGgwSWpvaVBITndZVzRnYzNSNWJHVTlYQ0ptYjI1MExXWmhiV2xzZVRvZ1FWUlNRVVJDUkU4c0lITmhibk10YzJWeWFXWTdYQ0krZXp3dmMzQmhiajdaaU5tTzJZWFpqdG1HSU5tSzJZN1pnZG1TMkxuWmp0bUUyWklnMkxEWmp0bUUyWkRaZzltT0lOaTUyWS9ZcjltUzJZalpqdGluMlliWXA5bUxJTm1JMlk3WXVObVAyWVRaa3RtRjJLZlppeURaZ2RtTzJMUFpqdG1JMlpMWmdkbU9JTm1HMlkvWXRkbVMyWVRaa05tSzJZZlprQ0RaaHRtTzJLZllzZGluMllzOGMzQmhiaUJ6ZEhsc1pUMWNJbVp2Ym5RdFptRnRhV3g1T2lCQlZGSkJSRUpFVHl3Z2MyRnVjeTF6WlhKcFpqdGNJajU5UEM5emNHRnVQaUF1SU5pdDJZUFpoU0RZcDltQzJLcllzZGluMllZZzJLelppTmluMktnZzJLZlpoTmkwMkxIWXR5RFlxTmluMllUWmdkaW4yS0VnMllIWmlpRFlwOW1FMktMWml0aXBJTmluMllUWXM5aW4yS2paZ3RpcExpSXNJbkJ2YVc1MGN5STZNQ3dpYVcxaFoyVWlPaUlpTENKcGJXRm5aVmRwWkhSb0lqb2lJaXdpYVcxaFoyVklaV2xuYUhRaU9pSWlMQ0owZVhCbElqb2liV054SWl3aVkyaHZhV05sY3lJNld5TFlwOW1FMllqWXJObUkyS2dpTENMWXA5bUUyS3paaU5pbjJMSWlYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNSDBzZXlKMFpYaDBJam9pUEhOd1lXNGdjM1I1YkdVOVhDSm1iMjUwTFdaaGJXbHNlVG9nUVZSU1FVUkNSRThzSUhOaGJuTXRjMlZ5YVdZN1hDSStlend2YzNCaGJqN1poZG1PMllZZzJZclpqdG1IMlpMWXI5bVFJTmluMllUWmhObVIyWTdaaDltUElObUIyWTdaaDltUDJZalpqaURZcDltRTJaTFpoZG1QMllmWmt0aXEyWTdZcjltUTJZbzhjM0JoYmlCemRIbHNaVDFjSW1admJuUXRabUZ0YVd4NU9pQkJWRkpCUkVKRVR5d2djMkZ1Y3kxelpYSnBaanRjSWo1OVBDOXpjR0Z1UGlBdUlOaXoyS2pZcUNEWXA5bUMyS3JZc2RpbjJZWWcyS3paaU5pbjJLZ2cyS2ZaaE5pMDJMSFl0eURZcU5pbjJZVFpnZGluMktFZzJZSFppaURZcDltRTJLTFppdGlwSU5pbjJZVFlzOWluMktqWmd0aXBPaUlzSW5CdmFXNTBjeUk2TUN3aWFXMWhaMlVpT2lJaUxDSnBiV0ZuWlZkcFpIUm9Jam9pSWl3aWFXMWhaMlZJWldsbmFIUWlPaUlpTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZck5tRjJZVFlxU0RZcDltRTJMVFlzZGkzSU5pMzJZVFlxTm1LMktraUxDTFlyTm1GMllUWXFTRFlwOW1FMkxUWXNkaTNJTmluMkxQWmhkbUsyS2tpTENMWXJObUYyWVRZcVNEWXA5bUUyTFRZc2RpM0lObUYyTFhZcjltUjJMSFlxU0RZcU5tQjJMblpoQ0RZck5pbjJZWFlyeUpkTENKamIzSnlaV04wUVc1emQyVnlJam94ZlN4N0luUmxlSFFpT2lMWXA5bUUyS3paaGRtRTJLa2cyS2ZaaE5pcTJZb2cyS2ZZdE5pcTJZWFpoTmlxSU5pNTJZVFppU0RaZ2RpNTJZUWcyWVhZdHRpbjJMSFl1U0RaaGRpczJMTFppTm1GSU5pbzJLelppTmluMktnZzJLZlpoTmkzMllUWXFOaU1JTm1IMllvNklpd2ljRzlwYm5Seklqb3dMQ0pwYldGblpTSTZJaUlzSW1sdFlXZGxWMmxrZEdnaU9pSWlMQ0pwYldGblpVaGxhV2RvZENJNklpSXNJblI1Y0dVaU9pSnRZM0VpTENKamFHOXBZMlZ6SWpwYkl0bUUyS2NnMktyWXRkaW4ySzNZcUNEWXA5bUUyS1BZdE5peDJLZllzU0RZcXRtQjJMUFlyeUlzSXRpdTJMQWcyWVhaaGlEWW85aXUyWXJaZ3lEWmhkaW8yWVRZdXRpbjJZc2cyS3JZczlpdjJLOGcyS2paaHlEWXI5bUsyWWpaaHRtRElpd2kyWWZaaE5pbjJaRWcyS1BZdDlpNTJLb2cyWWpZcDltRTJLL1ppdG1ESU5pcTJZSFpoTml0SWwwc0ltTnZjbkpsWTNSQmJuTjNaWElpT2pKOUxIc2lkR1Y0ZENJNkl0bUUyS2NnMktyWmg5bUYyWVFnMktmWmhOaXgyWXJZcDlpMjJLa2cyS3JaaGRpeDJMWXVJTmluMllUWXR0aW8yTGNnMktmWmhOaTEySzNaaXRpdElObUUyWVBaaE5tRjJLa2dLRHh6Y0dGdUlITjBlV3hsUFZ3aVptOXVkQzFtWVcxcGJIazZJQ1p4ZFc5ME8yMXZhR0Z0YldGa0lHSnZiR1FnWVhKMElERW1jWFZ2ZERzc0lITmhibk10YzJWeWFXWTdYQ0krMktyWmhkaXgyTFk4TDNOd1lXNCtLVG9pTENKd2IybHVkSE1pT2pBc0ltbHRZV2RsSWpvaUlpd2lhVzFoWjJWWGFXUjBhQ0k2SWlJc0ltbHRZV2RsU0dWcFoyaDBJam9pSWl3aWRIbHdaU0k2SW0xamNTSXNJbU5vYjJsalpYTWlPbHNpMktyWmhkaXgyTGJaa2lJc0l0aXEyWVhZc2RpMjJZOGlMQ0xZcXRtRjJMSFl0dG1PSWwwc0ltTnZjbkpsWTNSQmJuTjNaWElpT2pGOUxIc2lkR1Y0ZENJNklpallwZG1HSU5tRDJZYllxaURZcXRpdDJLZ2cyS2ZaaE5pdTJZcllzU0RZcGRtRTJZclpoeURZcDltQjJMblpoTm1IS1M0ZzJLZlpoTmlzMllYWmhOaXAyS2ZaaE5pejJLZllxTm1DMktrZzJMWFlyZG1LMkszWXFTNG1ibUp6Y0RzaUxDSndiMmx1ZEhNaU9qQXNJbWx0WVdkbElqb2lJaXdpYVcxaFoyVlhhV1IwYUNJNklpSXNJbWx0WVdkbFNHVnBaMmgwSWpvaUlpd2lkSGx3WlNJNkltMWpjU0lzSW1Ob2IybGpaWE1pT2xzaTJMWFlyZG1LMkswaUxDTFlydGkzMktNaVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1YMHNleUowWlhoMElqb2kyS1BaaWlEWXFObUUySzhnMktyWXM5aW4yWUhZc1NEWW85aXoyS2ZaZ2RpeElObUYyTG5aZ3k0ZzJLWFl1ZGl4MktmWXFDQW8yS1BaaWlrNklOaW4yTFBaaFNEWXROaXgyTGNnMllYWXFObUcyWW9nMllIWmlpRFpoZGl0MllRZzJZYll0ZGlvSU5pNDJMSFpnU0RaaGRtRDJLZlpoaTRtYm1KemNEc2lMQ0p3YjJsdWRITWlPakFzSW1sdFlXZGxJam9pSWl3aWFXMWhaMlZYYVdSMGFDSTZJaUlzSW1sdFlXZGxTR1ZwWjJoMElqb2lJaXdpZEhsd1pTSTZJbTFqY1NJc0ltTm9iMmxqWlhNaU9sc2kyTFhZcmRtSzJLMGlMQ0xZcnRpMzJLTWlYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNWDBzZXlKMFpYaDBJam9pMllUWXB5RFlxdG1DMktyWXNkaW9JTm1GMllZZzJLZlpoTm1HMktmWXNTRFlxdGl0MkxIWmd0bURMaURZcDltRTJZSFl1ZG1FSUNqWXF0aXQyTEhaZ2lrZzJZWFlyTml5MllqWmhTRFlxTmlzMllqWXA5aW9JTmluMllUWXQ5bUUyS2d1Sm01aWMzQTdJaXdpY0c5cGJuUnpJam93TENKcGJXRm5aU0k2SWlJc0ltbHRZV2RsVjJsa2RHZ2lPaUlpTENKcGJXRm5aVWhsYVdkb2RDSTZJaUlzSW5SNWNHVWlPaUp0WTNFaUxDSmphRzlwWTJWeklqcGJJdGkxMkszWml0aXRJaXdpMks3WXQ5aWpJbDBzSW1OdmNuSmxZM1JCYm5OM1pYSWlPakY5TEhzaWRHVjRkQ0k2SXRtRjJZWWcyWXJaaDltRjJZUWcySy9Zc2RtSTJMUFpoeURaZ2RtRTJZWWcyWXJZcXRtQjJZalpnaTRnMllyWXJOaW9JTmluMllMWXF0aXgyS2ZaaGlEWXJObUkyS2ZZcUNEWXA5bUUyTFRZc2RpM0lOaW8yS2ZaaE5tQjJLZllvU0RaZ2RtS0lOaW4yWVRZck5tRjJZVFlxU0RZcDltRTJMUFlwOWlvMllMWXFTNG1ibUp6Y0RzaUxDSndiMmx1ZEhNaU9qQXNJbWx0WVdkbElqb2lJaXdpYVcxaFoyVlhhV1IwYUNJNklpSXNJbWx0WVdkbFNHVnBaMmgwSWpvaUlpd2lkSGx3WlNJNkltMWpjU0lzSW1Ob2IybGpaWE1pT2xzaTJMWFlyZG1LMkswaUxDTFlydGkzMktNaVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1IMHNleUowWlhoMElqb2kyWVRaaU5tRTJLY2cyS3JZc3RtSTJMSFpodGluSU5tRzJZUFlzZG1GMllNdUlOaW4yWVRaZ2RpNTJZUWdLTm1HMllQWXNkbUZLU0RaaGRpczJMTFppTm1GSU5pbzJLelppTmluMktnZzJLZlpoTmkzMllUWXFDNG1ibUp6Y0RzaUxDSndiMmx1ZEhNaU9qQXNJbWx0WVdkbElqb2lJaXdpYVcxaFoyVlhhV1IwYUNJNklpSXNJbWx0WVdkbFNHVnBaMmgwSWpvaUlpd2lkSGx3WlNJNkltMWpjU0lzSW1Ob2IybGpaWE1pT2xzaTJMWFlyZG1LMkswaUxDTFlydGkzMktNaVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1IMWRmUT09';
        const SECRET_KEY = 'change-this-to-your-own-secret-phrase-12345';
        const examData = JSON.parse(decodeURIComponent(escape(atob(atob(encodedExamData)))));

        try {
            if (examData.config.botToken) {
                const decryptedBytes = CryptoJS.AES.decrypt(examData.config.botToken, SECRET_KEY);
                examData.config.botToken = decryptedBytes.toString(CryptoJS.enc.Utf8);
            }
            if (examData.config.chatId) {
                const decryptedBytes = CryptoJS.AES.decrypt(examData.config.chatId, SECRET_KEY);
                examData.config.chatId = decryptedBytes.toString(CryptoJS.enc.Utf8);
            }
            if (examData.config.githubToken) {
                const decryptedBytes = CryptoJS.AES.decrypt(examData.config.githubToken, SECRET_KEY);
                examData.config.githubToken = decryptedBytes.toString(CryptoJS.enc.Utf8);
            }
        } catch (e) { console.error("Decryption failed!", e); }

        const GITHUB_OWNER = 'alshami2024';
        const GITHUB_REPO = 'alshami';

        let studentName = '', studentAnswers = new Array(examData.questions.length).fill(null), timerInterval, currentQuestionIndex = 0, tabSwitchCount = 0, examFinished = false;
        const startScreen = document.getElementById('startScreen'), examArea = document.getElementById('examArea'), resultContainer = document.getElementById('resultContainer'), savingResultsScreen = document.getElementById('savingResultsScreen');
        const accessControl = examData.config.accessControl || { enabled: false, students: [] };
        
        window.onload = function() {
            const uniqueExamId = `examStarted_${btoa(unescape(encodeURIComponent(examData.config.title)))}`;
            if (examData.config.singleUseMode && localStorage.getItem(uniqueExamId)) {
                document.body.innerHTML = `<div class="container" style="text-align:center;"><h1>ÿ™ŸÖ ŸÇŸÅŸÑ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</h1><p>ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ®ÿØÿ° Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿßŸÑŸÅÿπŸÑ ŸÖŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠. ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ¨ÿ±ÿßÿ§Ÿá ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.</p></div>`;
                return;
            }
            const now = new Date();
            const startTime = examData.config.startTime ? new Date(examData.config.startTime) : null;
            const endTime = examData.config.endTime ? new Date(examData.config.endTime) : null;
            if (startTime && now < startTime) {
                document.getElementById('startScreen').innerHTML = `<h1>ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ ÿ®ÿπÿØ</h1><p>ÿ≥ŸäŸÉŸàŸÜ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿ™ÿßÿ≠Ÿãÿß ŸÅŸä: ${startTime.toLocaleString('ar-EG')}</p>`;
                return;
            }
            if (endTime && now > endTime) {
                document.getElementById('startScreen').innerHTML = `<h1>ÿßŸÜÿ™Ÿáÿ™ ŸÅÿ™ÿ±ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</h1><p>ŸÑŸÇÿØ ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÑÿ•ÿ¨ÿ±ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±.</p>`;
                return;
            }
            document.getElementById('examTitleStudent').textContent = examData.config.title;
            document.getElementById('examDescriptionStudent').textContent = examData.config.description;
            document.getElementById('startExamBtn').addEventListener('click', validateStudentAndStart);
        };
        
        async function validateStudentAndStart() {
            const nameInput = document.getElementById('studentName').value.trim();
            if (!nameInput) { alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ.'); return; }
            if (accessControl.enabled) {
                const codeInput = document.getElementById('accessCode').value.trim();
                if (!codeInput) { alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÖÿ≤ ÿßŸÑÿØÿÆŸàŸÑ.'); return; }
                const isValidStudent = accessControl.students.some(student => 
                    student.name.trim().toLowerCase() === nameInput.toLowerCase() && student.code === codeInput
                );
                if (!isValidStudent) { alert('ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÖÿ≤ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠.'); return; }
                if (examData.config.singleUseMode && examData.config.githubToken && examData.config.resultsFilename) {
                    try {
                        const hasTakenExam = await checkIfStudentHasTakenExam(nameInput, examData.config.githubToken, `exam/${examData.config.resultsFilename}`);
                        if (hasTakenExam) { alert('ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ•ÿ¨ÿ±ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿ≥ÿ®ŸÇŸãÿß.'); return; }
                    } catch (error) { console.error(error); return; }
                }
                studentName = nameInput; startTheExam();
            } else { studentName = nameInput; startTheExam(); }
        }
        
        async function checkIfStudentHasTakenExam(studentName, githubToken, fullFilenamePath) {
            const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${fullFilenamePath}`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `token ${githubToken}` } });
                if (response.status === 404) return false;
                if (!response.ok) throw new Error('GitHub Error');
                const data = await response.json();
                const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                return content.some(result => result.studentName.trim().toLowerCase() === studentName.toLowerCase());
            } catch (error) { return false; }
        }
        
        function startTheExam() {
            if (examData.config.singleUseMode) {
                const uniqueExamId = `examStarted_${btoa(unescape(encodeURIComponent(examData.config.title)))}`;
                localStorage.setItem(uniqueExamId, 'true');
            }
            sendStartNotificationToTelegram();
            startScreen.style.display = 'none'; examArea.style.display = 'block';
            document.getElementById('welcomeStudent').textContent = `ÿ®ÿßŸÑÿ™ŸàŸÅŸäŸÇÿå ${studentName}!`;
            if (examData.config.time > 0) startTimer(examData.config.time * 60); else document.getElementById('timer').style.display = 'none';
            if (examData.config.shuffle) { examData.questions.sort(() => Math.random() - 0.5); }
            setupSmartFeatures(); renderQuestionsForStudent();
            document.getElementById('finishExamBtn').addEventListener('click', () => { if(confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿ∫ÿ®ÿ™ŸÉ ŸÅŸä ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±ÿü")) finishTheExam(); });
        }
        
        function renderQuestionsForStudent(){const container=document.getElementById("questionsContainer");container.innerHTML="",examData.config.layout==="one-by-one"?(renderSingleQuestion(currentQuestionIndex),updateNavigationButtons()):examData.questions.forEach((e,t)=>container.appendChild(createQuestionElement(e,t))),updateProgressBar()}
        
        function createQuestionElement(e,t){
            const n=document.createElement("div");n.className="question-card",n.id=`question-${t}`;
            let imgHtml = e.image ? `<div class="q-image-container"><img src="${e.image}" class="q-image"></div>` : '';
            let o=`${imgHtml}<h3>ÿßŸÑÿ≥ÿ§ÿßŸÑ ${t+1}: ${e.text}</h3>`;
            if("mcq"===e.type || "tf"===e.type){
                const choicesList = e.type === "tf" ? ["ÿµÿ≠", "ÿÆÿ∑ÿ£"] : e.choices;
                const i=choicesList.map((lbl,idx)=>`<li onclick="handleChoiceClick(${t}, ${idx}, this)"><input type="radio" name="q${t}" id="q${t}c${idx}" value="${idx}" ${studentAnswers[t]===idx?"checked":""}><label for="q${t}c${idx}">${lbl}</label></li>`).join("");o+=`<ul class="choices">${i}</ul>`
            }else{
                const s=studentAnswers[t]||"";o+=`<textarea class="essay-answer" oninput="handleEssayInput(${t}, this.value)" placeholder="ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ŸáŸÜÿß...">${s}</textarea>`
            }
            return n.innerHTML=o,n;
        }
        
        function handleChoiceClick(e,t,n){
            studentAnswers[e]=t;
            n.querySelector("input").checked=!0;
            const qType = examData.questions[e].type;
            if(examData.config.layout==="one-by-one" && examData.config.learningMode && (qType==="mcq" || qType==="tf")){
                const isCorrect = t === examData.questions[e].correctAnswer;
                n.classList.add(isCorrect ? "correct" : "incorrect");
                n.parentElement.querySelectorAll("li").forEach(li=>{li.style.pointerEvents="none"});
            }
            updateProgressBar();
        }

        function handleEssayInput(e,t){studentAnswers[e]=t.trim(),updateProgressBar()}
        function renderSingleQuestion(e){document.getElementById("questionsContainer").appendChild(createQuestionElement(examData.questions[e],e))}
        function updateNavigationButtons(){const e=document.getElementById("navigation-buttons");if("one-by-one"!==examData.config.layout)return void(e.style.display="none");let t="";examData.config.noGoingBack||(t='<button id="prevBtn" class="btn">ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>'),e.innerHTML=`${t}<button id="nextBtn" class="btn">ÿßŸÑÿ™ÿßŸÑŸä</button>`;const n=document.getElementById("nextBtn");n.disabled=currentQuestionIndex===examData.questions.length-1,n.addEventListener("click",()=>{currentQuestionIndex<examData.questions.length-1&&(currentQuestionIndex++,renderQuestionsForStudent())}),examData.config.noGoingBack||(document.getElementById("prevBtn").disabled=0===currentQuestionIndex,document.getElementById("prevBtn").addEventListener("click",()=>{currentQuestionIndex>0&&(currentQuestionIndex--,renderQuestionsForStudent())}))}
        function updateProgressBar(){const e=studentAnswers.filter(e=>null!==e&&""!==e).length,t=e/examData.questions.length*100,n=document.getElementById("progressBar");n.style.width=`${t}%`,n.textContent=`${Math.round(t)}%`}
        function setupSmartFeatures(){if(examData.config.disableCheating){["contextmenu","copy","paste"].forEach(evt=>document.body.addEventListener(evt,e=>e.preventDefault()))}if(examData.config.monitorTabs){document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden"&&!examFinished){tabSwitchCount++;if(examData.config.finishOnSwitch){alert("ŸÑŸÇÿØ ÿÆÿ±ÿ¨ÿ™ ŸÖŸÜ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±ÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±.");finishTheExam()}}})}}
        
        async function finishTheExam(){
            if(examFinished) return;
            examFinished = true;
            clearInterval(timerInterval);
            examArea.style.display = "none";
            if (examData.config.githubToken && examData.config.resultsFilename) {
                savingResultsScreen.style.display = 'block';
                await saveResultsToGithub(); 
                savingResultsScreen.style.display = 'none';
            }
            resultContainer.style.display = "block";
            let correctMcq = 0, totalMcq = 0;
            examData.questions.forEach((q, index) => {
                if ("mcq" === q.type || "tf" === q.type) {
                    totalMcq++;
                    if (studentAnswers[index] === q.correctAnswer) correctMcq++;
                }
            });
            document.getElementById("resultTitle").textContent = "ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ!";
            if(examData.config.showResults){
                let summaryHtml = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${studentName}ÿå ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ ŸÅŸä ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿ¢ŸÑŸäÿ© ŸáŸä: <strong>${correctMcq} / ${totalMcq}</strong>`;
                if (examData.questions.some(q => "essay" === q.type)) {
                    summaryHtml += '<br><small>ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖŸÇÿßŸÑŸäÿ© ÿ™ÿ™ÿ∑ŸÑÿ® ÿ™ÿµÿ≠Ÿäÿ≠Ÿãÿß ŸäÿØŸàŸäÿßŸã/ÿ¢ŸÑŸäÿßŸã Ÿàÿ≥ÿ™ÿ∏Ÿáÿ± ŸÜÿ™Ÿäÿ¨ÿ™Ÿáÿß ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© ŸÑÿßÿ≠ŸÇÿßŸã.</small>';
                }
                if (examData.config.monitorTabs && tabSwitchCount > 0) {
                    summaryHtml += `<br><small style="color:var(--danger-color);">ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ŸÉ ŸÖŸÜ ÿßŸÑÿµŸÅÿ≠ÿ© ${tabSwitchCount} ŸÖÿ±ÿßÿ™.</small>`;
                }
                document.getElementById("resultSummary").innerHTML = summaryHtml;
            } else {
                document.getElementById("resultSummary").textContent = "ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉÿå ÿ™ŸÖ ÿ™ÿ≥ŸÑŸäŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠.";
            }
            if (examData.config.showResults && examData.config.enableReview) renderReview();
            if (examData.config.enableCertificate && totalMcq > 0 && (correctMcq / totalMcq * 100) >= examData.config.successPercentage) {
                renderCertificate(correctMcq, totalMcq);
            }
            if (examData.config.botToken && examData.config.chatId) await sendResultsToTelegram(correctMcq, totalMcq);
        }
    
        function renderReview(){
            const e=document.getElementById("reviewContainer");
            e.innerHTML="<h3>ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™:</h3>";
            examData.questions.forEach((t,n)=>{
                let o="";
                if(t.type === "mcq" || t.type === "tf") {
                    const choicesList = t.type === "tf" ? ["ÿµÿ≠", "ÿÆÿ∑ÿ£"] : t.choices;
                    const userAns = choicesList[studentAnswers[n]] || "ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©";
                    const correctAns = choicesList[t.correctAnswer];
                    const isCorrect = studentAnswers[n] === t.correctAnswer;
                    
                    o=`<div class="question-card" style="background:${isCorrect?"#d4edda":"#f8d7da"};"><p><strong>${t.text}</strong></p><p>ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ: ${userAns} ${isCorrect?"‚úîÔ∏è":"‚ùå"}</p>${!isCorrect?`<p style="color:var(--primary-color);">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ${correctAns}</p>`:""}</div>`;
                } else {
                    o=`<div class="question-card" style="background: #e9ecef;"><p><strong>(ÿ≥ÿ§ÿßŸÑ ŸÖŸÇÿßŸÑŸä) ${t.text}</strong></p><p style="font-weight:bold;">ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ:</p><p style="white-space: pre-wrap; background: #fff; padding:10px; border-radius:5px;">${studentAnswers[n]?studentAnswers[n].replace(/</g,"&lt;").replace(/>/g,"&gt;"):"ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©"}</p></div>`;
                }
                e.innerHTML+=o;
            });
        }

        function renderCertificate(e,t){const n=document.getElementById("certificate");n.style.display="block",document.getElementById("certName").textContent=studentName,document.getElementById("certScore").textContent=`${e} / ${t}`,document.getElementById("certDate").textContent=(new Date).toLocaleDateString("ar-EG")}
        function startTimer(e){let t=e;const n=document.getElementById("timer");timerInterval=setInterval(()=>{let e=parseInt(t/60,10),o=parseInt(t%60,10);e=e<10?"0"+e:e,o=o<10?"0"+o:o,n.textContent=`${e}:${o}`,--t<0&&(clearInterval(timerInterval),alert("ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!"),finishTheExam())},1e3)}
        
        async function sendResultsToTelegram(e,t){
            const{botToken:n,chatId:o,title:s}=examData.config;if(!n||!o)return;
            function i(e){return"string"!=typeof e?"":e.replace(/([_*[\]()~>#+\-=|{}.!])/g,"\\$1")}
            let a=`*üìä ŸÜÿ™Ÿäÿ¨ÿ© ÿßÿÆÿ™ÿ®ÿßÿ± ÿ¨ÿØŸäÿØÿ©*\n\n*ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±:* ${i(s)}\n*ÿßŸÑÿ∑ÿßŸÑÿ®:* ${i(studentName)}\n*ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ¢ŸÑŸäÿ©:* ${e} ŸÖŸÜ ${t}\n*ŸÖÿ±ÿßÿ™ ÿßŸÑÿÆÿ±Ÿàÿ¨:* ${tabSwitchCount}`;
            let d="\n\n*ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÖŸÇÿßŸÑŸäÿ©*",r=!1;
            examData.questions.forEach((e,t)=>{("essay"===e.type&&(r=!0,d+=`\n\n*‚ùì ÿßŸÑÿ≥ÿ§ÿßŸÑ: ${i(e.text)}*\n*üìù ÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®:*\n${i(studentAnswers[t]||"ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©")}`))});
            r&&(a+=d);
            const c=`https://api.telegram.org/bot${n}/sendMessage`;
            try{
                a.length>4096&&(a=a.substring(0,4e3)+"\n\n... (ÿ™ŸÖ ÿßŸÇÿ™ÿ∑ÿßÿπ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÑÿ£ŸÜŸáÿß ÿ∑ŸàŸäŸÑÿ© ÿ¨ÿØÿßŸã)");
                const l=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:o,text:a,parse_mode:"MarkdownV2"})});
            }catch(p){console.error("Fetch error or issue sending to Telegram:",p)}
        }

        async function sendStartNotificationToTelegram(){
            const{botToken:n,chatId:o,title:s}=examData.config;if(!n||!o)return;
            function i(e){return"string"!=typeof e?"":e.replace(/([_*[\]()~>#+\-=|{}.!])/g,"\\$1")}
            const a=`*üîî ÿ®ÿØÿ° ÿßÿÆÿ™ÿ®ÿßÿ± ÿ¨ÿØŸäÿØ*\n\n*ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±:* ${i(s)}\n*ÿßŸÑÿ∑ÿßŸÑÿ®:* ${i(studentName)}`,c=`https://api.telegram.org/bot${n}/sendMessage`;
            try{await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:o,text:a,parse_mode:"MarkdownV2"})});}catch(p){}
        }
        
        async function saveResultsToGithub() {
            const token = examData.config.githubToken;
            const filename = examData.config.resultsFilename;
            if (!token || !filename) { return; } 
            const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/exam1/${filename}`;
            let correctMcq = 0, totalMcq = 0;
            examData.questions.forEach((q, index) => {
                if ("mcq" === q.type || "tf" === q.type) {
                    totalMcq++;
                    if (studentAnswers[index] === q.correctAnswer) correctMcq++;
                }
            });
            const resultData = {
                studentName: studentName,
                submissionDate: new Date().toISOString(),
                mcqScore: { correct: correctMcq, total: totalMcq },
                tabSwitchCount: tabSwitchCount,
                examTitle: examData.config.title,
                answers: examData.questions.map((q, index) => {
                    const studentAnswerRaw = studentAnswers[index];
                    let studentAnswerText = studentAnswerRaw;
                    let isCorrect = null;
                    let correctAnswerText = null;
                    if (q.type === 'mcq' || q.type === 'tf') {
                        const choicesList = q.type === "tf" ? ["ÿµÿ≠", "ÿÆÿ∑ÿ£"] : q.choices;
                        isCorrect = (studentAnswerRaw === q.correctAnswer);
                        studentAnswerText = (studentAnswerRaw !== null) ? choicesList[studentAnswerRaw] : "ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©";
                        if (!isCorrect) correctAnswerText = choicesList[q.correctAnswer];
                    } else if (q.type === 'essay') {
                        studentAnswerText = studentAnswerRaw;
                        isCorrect = null;
                        correctAnswerText = null;
                        return { type: 'essay', question: q.text, answer: studentAnswerText, isGraded: false, maxScore: q.maxScore || 0 };
                    }
                    return { type: q.type, question: q.text, answer: studentAnswerText, isCorrect: isCorrect, correctAnswer: correctAnswerText };
                })
            };
            try {
                let currentContent = [];
                let sha;
                try {
                    const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                    if (res.ok) {
                        const data = await res.json();
                        sha = data.sha;
                        currentContent = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    }
                } catch (fetchError) { }
                currentContent.push(resultData);
                const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ∑ÿßŸÑÿ®: ${studentName}`, content: updatedContent, sha: sha })
                });
            } catch (error) { document.getElementById("resultSummary").innerHTML += '<br><small style="color:red;">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿ≠ÿßŸàŸÑÿ© ÿ≠ŸÅÿ∏ ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ.</small>'; }
        }
    </script>
    </body>
    </html>
    