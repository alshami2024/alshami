
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿØÿ≥ÿ™Ÿàÿ±Ÿä</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0056b3; --bg-color: #e9ecef; --white: #fff; --danger: #dc3545; --success: #28a745; --warning: #ffc107; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; direction: rtl; line-height: 1.6; }
        .container { background-color: var(--white); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 850px; margin: 0 auto; padding: 25px; min-height: 80vh; position: relative; }
        .btn { background: var(--primary-color); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-family: inherit; margin: 5px; font-weight: bold; transition: 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: #000; }
        
        .question-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .question-card:hover { box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .choices { list-style: none; padding: 0; }
        .choices li { background: #fff; border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .choices li:hover { background: #e9ecef; border-color: var(--primary-color); }
        .choices li.selected { border-color: var(--primary-color); background: #e7f1ff; font-weight: bold; }
        
        .voice-btn { position: absolute; top: 15px; left: 15px; background: #fff; border: 1px solid #ddd; width: 35px; height: 35px; border-radius: 50%; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .voice-btn:hover { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        
        .ai-explanation-box { background: #e3f2fd; border-right: 4px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 6px; display: none; font-size: 0.95em; line-height: 1.8; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s linear infinite; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .timer-badge { background: #ffeeee; color: var(--danger); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid #ffcccc; }
        
        .footer-copyright {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            width: 100%;
            display: block;
        }

       /* --- Smart Timer Styles (ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿßŸÑŸÖÿ§ŸÇÿ™ ÿßŸÑÿ¥ÿßŸÖŸÑÿ©) --- */
.smart-timer-container {
    position: absolute;
    top: -25px;
    left: 20px;
    z-index: 100; /* ÿ±ŸÅÿπ ÿßŸÑÿ∑ÿ®ŸÇÿ© ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ∏ŸáŸàÿ± ŸÅŸàŸÇ ŸÉŸÑ ÿßŸÑÿπŸÜÿßÿµÿ± */
}

.smart-timer {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #ffffff;
    border: 5px solid #2ecc71; /* ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿÆÿ∂ÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä */
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 1.4rem;
    color: #2c3e50;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    box-sizing: border-box; /* ÿ∂ŸÖÿßŸÜ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ∑ÿßÿ± ÿ∂ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ */
}

/* ŸÖÿ±ÿßÿ≠ŸÑ ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ± ŸàÿßŸÑÿÆÿ∑ÿ± (ÿßŸÑÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™) */
.timer-warning {
    border-color: #f39c12 !important;
    color: #d35400 !important;
}

.timer-danger {
    border-color: #e74c3c !important;
    color: #c0392b !important;
    background: #fff5f5 !important;
    animation: pulse-red 1s infinite;
}

@keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); transform: scale(1); }
    70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); transform: scale(1.1); }
    100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); transform: scale(1); }
}

/* --- ÿ™ÿÆÿµŸäÿµ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ (Mobile Styles) --- */
@media (max-width: 600px) {
    .container { padding: 15px; }
    
    /* ÿ™Ÿàÿ≥Ÿäÿπ ÿßŸÑŸÉÿßÿ±ÿØ ŸÑÿ•ÿπÿ∑ÿßÿ° ŸÖÿ≥ÿßÿ≠ÿ© */
    .question-card { 
        padding: 25px 15px 15px 15px !important; 
        overflow: visible !important; /* ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑŸÖÿ§ŸÇÿ™ ÿ®ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿπŸÜ ÿ≠ÿØŸàÿØ ÿßŸÑŸÉÿßÿ±ÿØ */
    }

    /* ÿ™ÿπÿØŸäŸÑ ŸÖŸÉÿßŸÜ Ÿàÿ≠ÿ¨ŸÖ ÿßŸÑŸÖÿ§ŸÇÿ™ ŸÑŸÑŸÖŸàÿ®ÿßŸäŸÑ */
    .smart-timer-container {
        top: -20px !important;
        left: 10px !important;
    }

    .smart-timer {
        width: 45px !important;
        height: 45px !important;
        font-size: 1rem !important;
        border-width: 4px !important; /* ÿ•ÿ¨ÿ®ÿßÿ± ÿ∏ŸáŸàÿ± ÿßŸÑÿ•ÿ∑ÿßÿ± */
        border-style: solid !important; /* ÿ™ÿ£ŸÉŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ•ÿ∑ÿßÿ± */
    }

    /* ÿ•ÿ≤ÿßÿ≠ÿ© ŸÜÿµ ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸÑŸÑŸäŸÖŸäŸÜ ÿ≠ÿ™Ÿâ ŸÑÿß Ÿäÿ∫ÿ∑ŸäŸá ÿßŸÑŸÖÿ§ŸÇÿ™ */
    .question-card h3 {
        margin-top: 10px;
        padding-left: 50px !important; /* ŸÖÿ≥ÿßÿ≠ÿ© ŸÅÿßÿ±ÿ∫ÿ© ŸÖŸÉÿßŸÜ ÿßŸÑŸÖÿ§ŸÇÿ™ */
        line-height: 1.6;
    }

    /* ÿ™ÿ≠ÿ±ŸäŸÉ ÿ≤ÿ± ÿßŸÑÿµŸàÿ™ ŸÑŸÑÿ£ÿ≥ŸÅŸÑ */
    .voice-btn {
        top: auto !important;
        bottom: 10px !important;
        left: 10px !important;
        width: 30px !important;
        height: 30px !important;
    }
}
/* --- Modern Result Screen Styles --- */
.result-dashboard {
    text-align: center;
    padding: 20px 0;
    animation: slideUp 0.5s ease-out;
}

/* ÿØÿßÿ¶ÿ±ÿ© ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ© */
.score-circle-container {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 0 auto 25px;
}
.score-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(var(--primary-color) 0%, #eee 0%);
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 1s ease-out;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.score-inner {
    width: 85%;
    height: 85%;
    background: white;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.score-number {
    font-size: 3rem;
    font-weight: 800;
    color: var(--primary-color);
    line-height: 1;
}
.score-label {
    font-size: 0.9rem;
    color: #888;
    margin-top: 5px;
}

/* ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ŸÇŸäŸäŸÖ */
.grade-message {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 10px;
    color: #2d3436;
}
.grade-subtext {
    color: #636e72;
    margin-bottom: 30px;
}

/* ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 30px;
}
.stat-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #eee;
    transition: transform 0.2s;
}
.stat-card:hover { transform: translateY(-3px); border-color: var(--primary-color); }
.stat-icon { font-size: 1.5rem; margin-bottom: 8px; display: block; }
.stat-val { font-size: 1.2rem; font-weight: bold; display: block; color: #2d3436; }
.stat-lbl { font-size: 0.8rem; color: #888; }

/* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ¨ÿØŸäÿØÿ© */
.action-buttons-grid {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}
.action-btn-modern {
    padding: 12px 25px;
    border-radius: 50px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    font-size: 1rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.btn-retry { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
.btn-review { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
.btn-print { background: linear-gradient(135deg, #2d3436, #636e72); color: white; }
.btn-cert { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
.action-btn-modern:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); opacity: 0.95; }

/* ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑŸÉŸàŸÜŸÅŸäÿ™Ÿä (ÿßÿ≠ÿ™ŸÅÿßŸÑ) */
.confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background-color: #f00;
    animation: fall linear forwards;
    z-index: 9999;
}
@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

                    :root { --primary-color: #6c5ce7; --secondary-color: #a29bfe; --light-gray: #f3f0ff; --dark-gray: #2d3436; --success-color: #00b894; --danger-color: #d63031; --background-color: #dfe6e9; --text-color: #2d3436; --white: #fff; }
                    body { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); min-height: 100vh; }
                    .container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; }
                    .btn { background: linear-gradient(45deg, #6c5ce7, #a29bfe); border: none; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4); }
                    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(108, 92, 231, 0.6); }
                    .question-card { box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: none; }
                    .choices li { transition: all 0.3s ease; border: 2px solid #f3f0ff; }
                    .choices li:hover { border-color: #6c5ce7; transform: translateX(-5px); }
                    #certificate { background: #fff; border: 2px solid #6c5ce7; box-shadow: 0 0 20px rgba(108, 92, 231, 0.2); }
                  
/* --- Waiting Room Styles (ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±) --- */
#waitingRoom, #expiredRoom {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #2c3e50, #000);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-align: center;
    padding: 20px;
    transition: opacity 0.5s ease-out;
}

.waiting-icon { font-size: 4rem; margin-bottom: 20px; color: #f39c12; animation: float 3s infinite ease-in-out; }
.expired-icon { font-size: 4rem; margin-bottom: 20px; color: #e74c3c; }

.countdown-container {
    display: flex; gap: 15px; margin-top: 30px; direction: ltr; /* ŸÑÿ¨ÿπŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸÖŸÜ ÿßŸÑŸäÿ≥ÿßÿ± ŸÑŸÑŸäŸÖŸäŸÜ */
}
.time-box {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 15px;
    border-radius: 10px;
    min-width: 80px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.time-val { font-size: 2.5rem; font-weight: bold; display: block; color: #00d2d3; font-family: monospace; }
.time-label { font-size: 0.8rem; color: #ccc; text-transform: uppercase; margin-top: 5px; }

@keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }  
</style>
</head>
<body>
<div class="container">
    <div id="startScreen">
        <h1 style="color:var(--primary-color); margin-bottom:10px;">ÿßŸÑŸÇÿßŸÜŸàŸÜ ÿßŸÑÿØÿ≥ÿ™Ÿàÿ±Ÿä</h1>
        <p style="color:#666; margin-bottom:20px;">ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä</p>
        <div style="background:#f1f3f5; padding:15px; border-radius:8px; margin-bottom:20px;">
            <i class="fa-regular fa-clock"></i> ÿßŸÑŸÖÿØÿ©: 10 ÿØŸÇŸäŸÇÿ© <br>
            <i class="fa-solid fa-list-ol"></i> ÿπÿØÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©: 10
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        
        <div class="form-group">
            <label for="studentName">ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÉÿßŸÖŸÑ</label>
            <input type="text" id="studentName" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
        </div>
        
    
        
        <button onclick="validateAndStart()" class="btn">ÿ®ÿØÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± üöÄ</button>

        <div class="footer-copyright">Jamal-Alshami ¬© 2025</div>
        </div>

    <div id="examArea" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="font-weight:bold;"><i class="fa-regular fa-user"></i> <span id="studentNameDisplay"></span></div>
            <div id="timer" class="timer-badge">00:00</div>
        </div>
        
        <div style="height:8px; background:#eee; border-radius:10px; margin-bottom:25px; overflow:hidden;">
            <div id="progressBar" style="height:100%; width:0%; background:var(--success); transition:0.4s ease-out;"></div>
        </div>
        
        <div id="questionsContainer"></div>
        
        <div id="navButtons" style="margin-top:25px; display:flex; gap:10px; justify-content: flex-end; flex-wrap: wrap;"></div>
    </div>

    <div id="savingScreen" style="display:none; text-align:center; padding:40px;">
        <div class="spinner" style="width:50px; height:50px; border-width:5px;"></div>
        <h3>ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ...</h3>
        <p>Ÿäÿ±ÿ¨Ÿâ ÿπÿØŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©</p>
    </div>

   <div id="resultScreen" style="display:none;">
        <div class="result-dashboard">
            <div class="score-circle-container">
                <div id="scoreCircle" class="score-circle">
                    <div class="score-inner">
                        <span id="finalScoreNumber" class="score-number">0%</span>
                        <span class="score-label">ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©</span>
                    </div>
                </div>
            </div>

            <h2 id="resultStudentName" style="margin: -10px 0 15px; color: var(--primary-color); font-size: 1.4rem;"></h2>
            
            <div id="gradeMessage" class="grade-message"></div>
            <div id="gradeSubtext" class="grade-subtext"></div>

            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-icon" style="color:#2ecc71">‚úîÔ∏è</span>
                    <span id="statCorrect" class="stat-val">0</span>
                    <span class="stat-lbl">ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon" style="color:#e74c3c">‚ùå</span>
                    <span id="statWrong" class="stat-val">0</span>
                    <span class="stat-lbl">ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon" style="color:#3498db">‚è±Ô∏è</span>
                    <span id="statTime" class="stat-val">00:00</span>
                    <span class="stat-lbl">ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ∫ÿ±ŸÇ</span>
                </div>
            </div>

            <div id="modernActionButtons" class="action-buttons-grid"></div>

            <div id="certificateArea" style="display:none; border: 10px double var(--primary-color); padding: 30px; margin-top: 30px; background: #fff; position: relative;">
                <div style="position:absolute; top:10px; left:10px; opacity:0.1;"><i class="fa-solid fa-award" style="font-size:100px;"></i></div>
                <h2 style="color:var(--primary-color);">ÿ¥ŸáÿßÿØÿ© ÿ•ÿ™ŸÖÿßŸÖ</h2>
                <p>ÿ™ÿ¥ŸáÿØ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿ£ŸÜ ÿßŸÑÿ∑ÿßŸÑÿ®/ÿ©:</p>
                <h1 id="certName" style="margin: 15px 0;"></h1>
                <p>ŸÇÿØ ÿßÿ¨ÿ™ÿßÿ≤ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠ ÿ®ŸÜÿ™Ÿäÿ¨ÿ©:</p>
                <h2 id="certScore" style="color:var(--success);"></h2>
                <p>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: <span id="certDate"></span></p>
            </div>

<div id="reviewArea" style="text-align: right; margin-top: 40px;"></div>
        </div>
    </div> 
    
    </div> <div id="waitingRoom" style="display:none;">
    <i class="fa-solid fa-hourglass-start waiting-icon"></i>
    <h1 style="margin:0;">ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ Ÿäÿ®ÿØÿ£ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿπÿØ</h1>
    <p style="color:#aaa; margin-top:10px;">ÿ≥Ÿäÿ™ŸÖ ŸÅÿ™ÿ≠ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿÆŸÑÿßŸÑ:</p>
    
    <div class="countdown-container">
        <div class="time-box"><span id="cd-days" class="time-val">00</span><span class="time-label">ŸäŸàŸÖ</span></div>
        <div class="time-box"><span id="cd-hours" class="time-val">00</span><span class="time-label">ÿ≥ÿßÿπÿ©</span></div>
        <div class="time-box"><span id="cd-minutes" class="time-val">00</span><span class="time-label">ÿØŸÇŸäŸÇÿ©</span></div>
        <div class="time-box"><span id="cd-seconds" class="time-val">00</span><span class="time-label">ÿ´ÿßŸÜŸäÿ©</span></div>
    </div>
    <div style="margin-top: 30px; font-size: 0.9rem; opacity: 0.7;">
        <i class="fa-solid fa-calendar-day"></i> ŸÖŸàÿπÿØ ÿßŸÑÿ®ÿØÿ°: <span id="startDateDisplay" style="color:#fff; font-weight:bold;"></span>
    </div>
</div>

<div id="expiredRoom" style="display:none;">
    <i class="fa-solid fa-lock expired-icon"></i>
    <h1>ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</h1>
    <p>ŸÑŸÑÿ£ÿ≥ŸÅÿå ŸÑŸÇÿØ ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ≠ÿØÿØ ŸÑŸÑÿØÿÆŸàŸÑ ŸÑŸáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±.</p>
    <div style="margin-top:20px; padding:10px; background:rgba(231, 76, 60, 0.2); border-radius:8px;">
        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°: <span id="endDateDisplay"></span>
    </div>

<script>
    const encodedData = 'ZXlKamIyNW1hV2NpT25zaWRHbDBiR1VpT2lMWXA5bUUyWUxZcDltRzJZalpoaURZcDltRTJLL1lzOWlxMllqWXNkbUtJaXdpWkdWelkzSnBjSFJwYjI0aU9pTFlxdGlzMkxIWml0aW8yWW9pTENKemRHRnlkRlJwYldVaU9pSWlMQ0psYm1SVWFXMWxJam9pSWl3aWJHRjViM1YwSWpvaWIyNWxMV0o1TFc5dVpTSXNJblJwYldVaU9qRXdMQ0p6YUhWbVpteGxJanAwY25WbExDSnphSFZtWm14bFEyaHZhV05sY3lJNlptRnNjMlVzSW01dlIyOXBibWRDWVdOcklqcDBjblZsTENKa2FYTmhZbXhsUTJobFlYUnBibWNpT25SeWRXVXNJbTF2Ym1sMGIzSlVZV0p6SWpwMGNuVmxMQ0ptYVc1cGMyaFBibE4zYVhSamFDSTZabUZzYzJVc0lteGxZWEp1YVc1blRXOWtaU0k2Wm1Gc2MyVXNJbk5wYm1kc1pWVnpaVTF2WkdVaU9tWmhiSE5sTENKemFHOTNVbVZ6ZFd4MGN5STZkSEoxWlN3aVpXNWhZbXhsVW1WMmFXVjNJanBtWVd4elpTd2laVzVoWW14bFEyVnlkR2xtYVdOaGRHVWlPblJ5ZFdVc0ltVnVZV0pzWlZSbGVIUlViMU53WldWamFDSTZabUZzYzJVc0ltVnVZV0pzWlVGSlZIVjBiM0lpT21aaGJITmxMQ0psYm1GaWJHVlRiV0Z5ZEZKbGRISjVJanBtWVd4elpTd2ljR1Z5VVhWbGMzUnBiMjVVYVcxbGNpSTZabUZzYzJVc0luQmxjbEYxWlhOMGFXOXVVMlZqYjI1a2N5STZNekFzSW5Sb1pXMWxJam9pY0hWeWNHeGxJaXdpYzNWalkyVnpjMUJsY21ObGJuUmhaMlVpT2pVd0xDSmliM1JVYjJ0bGJpSTZJbFV5Um5Oa1IxWnJXREV2VURabVduWnlVVTltYzJ0WlRrZFFhV1pYVm1oMlRWQmxTbFpaWlRsdldtcHBRVGh1YVRseFZGTTVSalJTU1VoTFNrcHdPRE51TUdaUk5FNUJjblpJVFdKaVMyOTRjVWRYVGxkQlBUMGlMQ0pqYUdGMFNXUWlPaUpWTWtaelpFZFdhMWd4T0dwbFkxVnFja3h5YzJsd1NIUnpWSEJwZWpCRlRGSnFWVVJSZG5KckwzVkpQU0lzSW1kcGRHaDFZbFJ2YTJWdUlqb2lWVEpHYzJSSFZtdFlNVGs0VVVGbGFFWnlZVGgyU0ZvNVJWaEpUMlUzTVhSSlZYbDZWM1ZQZG5sS2VFaG1abVZqUTAxdVZsZ3lLMVJQU0RsR1RITlBhbXhwVm01VU4zSkNlRTFOY1dsa09FcDFiR3hZZW1jOVBTSXNJbkpsYzNWc2RITkdhV3hsYm1GdFpTSTZJbVY0WVcxZk1qQXlOVEV4TWpaZk1UVTBNalE1TG1wemIyNGlMQ0poWTJObGMzTkRiMjUwY205c0lqcDdJbVZ1WVdKc1pXUWlPbVpoYkhObExDSnpkSFZrWlc1MGN5STZXMTE5ZlN3aWNYVmxjM1JwYjI1eklqcGJleUowZVhCbElqb2liV054SWl3aWRHVjRkQ0k2SXRtRjJLY2cyWWZaaUNEWXA5bUUyS1BZdGRtRUlOaW4yWVRaaE5pNjJZalppaURaaE5tRDJZVFpoZGlwSUZ3aTJLL1lzOWlxMllqWXNWd2lJTm1CMllvZzJLZlpoTm1FMkxyWXFTRFlwOW1FMllIWXA5aXgyTFBaaXRpcDJKOGlMQ0pqYUc5cFkyVnpJanBiSXRtRjJZTFl0OWk1SU5tSTJLZllyZGl2SU5pbzJZWFl1ZG1HMllrZzJLZlpoTmlxMlliWXVObUsyWVVpTENMWmhkbUMyTGZZdWRpbjJZWTZJRndpMksvWXM5aXFYQ0lnMktqWmhkaTUyWWJaaVNEWXA5bUUyTFBaaE5pMzJLa2cyWWhjSXRtSTJMRmNJaURZcU5tRjJMblpodG1KSU5pMTJLZllyZGlvSWl3aTJZWFpndGkzMkxuWXA5bUdPaUJjSXRpdjJMUFlxbHdpSU5pbzJZWFl1ZG1HMllrZzJLZlpoTm1DMktmWXVkaXYyS2tnMktQWmlDRFlwOW1FMktQWXM5aW4yTE1nMlloY0l0bUkyTEZjSWlEWXFObUYyTG5aaHRtSklOaTEyS2ZZcmRpb0lpd2kyWVBaaE5tRjJLa2cyWVRZcDlpcTJZclpodG1LMktrZzJLcll1ZG1HMllvZzJLZlpoTmlxMktQWXM5bUsyTE1pWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TW4wc2V5SjBlWEJsSWpvaWJXTnhJaXdpZEdWNGRDSTZJdGlqMllvZzJZWFpoaURZcDltRTJLZlpodGlxMllMWXA5aXYyS2ZZcWlEWXA5bUUyS3JZcDltRTJZcllxU0RZcXRtSTJLelpoeURaaE5tRTJZWFlyOW1FMllqWmhDRFlwOW1FMllUWXV0bUkyWW9nS05pbjJZVFlwOWkwMktyWmd0aW4yWUxaaWlrZzJZVFpoTm1DMktmWmh0bUkyWVlnMktmWmhOaXYyTFBZcXRtSTJMSFppdGlmSWl3aVkyaHZhV05sY3lJNld5TFlwOWk1MktyWXNkaW4yWUhaaHlEWXFOaW4yWVRZcjlpejJLZllxdG1LMkxFZzJLZlpoTmk1MkxIWmdkbUsyS2tpTENMWXF0aXgyWVBaaXRpeTJZY2cyTG5aaE5tSklObUYyTGJaaGRtSTJZWWcyS2ZaaE5tQzJZallwOWk1Mks4ZzJLZlpoTml2MkxQWXF0bUkyTEhaaXRpcElpd2kyS3JZck5pbjJZZlpoTm1ISU5tRTJZVFlxdGkzMllqWXNTRFlwOW1FMktyWXA5aXgyWXJZcnRtS0lObUUyWVRZcjlpejJLZllxdG1LMkxFaUxDTFl0ZGk1MllqWXFOaXBJTmlxMkszWXI5bUsySzhnMlliWXQ5aW4yWUlnMktmWmhObUMyS2ZaaHRtSTJZWWcyS2ZaaE5pdjJMUFlxdG1JMkxIWmlpRFlxTml2MllMWXFTSmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3lmU3g3SW5SbGVIUWlPaUxaaGRtR0lObUYyTExZcDltSzJLY2cyS2ZaaE5tRjJLL1poTm1JMllRZzJLZlpoTmkwMllQWmhObUtJQ2pZcDltRTJZallxOWluMktiWmd0bUtLU0RaaE5tRTJZTFlwOW1HMllqWmhpRFlwOW1FMksvWXM5aXEyWWpZc2RtS09pSXNJbWx0WVdkbElqcHVkV3hzTENKMGVYQmxJam9pYldOeElpd2lZMmh2YVdObGN5STZXeUxZcDltRTJLZll1ZGlxMkxIWXA5bUJJTmlvMktmWmhOaXYyTFBZcDlpcTJZcllzU0RZcDltRTJMbllzZG1CMllyWXFTRFl1dG1LMkxFZzJLZlpoTm1GMllQWXF0bUkyS2pZcVNJc0l0aWwyWVhaZzlpbjJZYlppdGlwSU5pbDJLL1lzZGluMkt3ZzJZWFppTmkyMllqWXVkaW4yS29nMkxyWml0aXhJTml2MkxQWXF0bUkyTEhaaXRpcElObUIyWW9nMktmWmhObUkyS3ZaaXRtQzJLa2lMQ0xZcDltRTJZall0dG1JMkswZzJZallwOW1FMkxQWmg5bUkyWVRZcVNEWmdkbUtJTmlxMkszWXI5bUsySzhnMllYWXB5RFpoOW1JSU5pdjJMUFlxdG1JMkxIWmlpSXNJdGluMllUWmhkaXgyWWpaaHRpcElObUIyWW9nMllYWmlOaW4yWVBZcU5pcElOaW4yWVRZcXRpMzJZallzZGluMktvZzJLZlpoTml2MkxQWXF0bUkyTEhaaXRpcElsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qSjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWml0aXgyWWtnMktmWmhObUYySy9aaE5tSTJZUWcyS2ZaaE5tRjJZall0dG1JMkxuWmlpQW8yS2ZaaE5pczJZalpoOWl4MllvcElOaWoyWVlnMktmWmhObUMyS2ZaaHRtSTJZWWcyS2ZaaE5pdjJMUFlxdG1JMkxIWmlpRFpoOW1JSU5tRjJLelpoZG1JMkxuWXFTRFlwOW1FMllMWmlOaW4yTG5ZcnlEWXA5bUUyWUxZcDltRzJZalpodG1LMktrZzJLZlpoTmlxMllvZzJLclpodGk0MllVZzJMVFlwTm1JMllZZzJLZlpoTml0MllQWmhTRFpnZG1LSU5pbjJZVFlyOW1JMllUWXFkaU1JTm1JMktmWmhObUYyTG5aaXRpbjJMRWcyS2ZaaE5pajJMUFlwOWl6MllvZzJZSFppdG1ISU5tSDJZZzZJaXdpWTJodmFXTmxjeUk2V3lMWXA5bUUyWVhZdGRpdjJMRWcyS2ZaaE5pMDJZUFpoTm1LSU5tRTJZVFpndGluMkxuWXI5aXBJQ2pZcDltRTJZallxOW1LMllMWXFTRFlwOW1FMksvWXM5aXEyWWpZc2RtSzJLa3BJaXdpMktmWXM5bUZJTmluMllUWmlOaXIyWXJaZ3RpcElOaW4yWVRZcXRtS0lOaXEyS3JZdHRtRjJZWWcyS2ZaaE5tQzJZallwOWk1Mks4aUxDTFpoZGkyMllYWmlObUdJTmluMllUWmd0aW4yTG5ZcjlpcElObUkyWVhaaU5pMjJZall1ZG1IMktjZzJLall1dGkySU5pbjJZVFpodGk0MkxFZzJMblpoaURZdE5tRDJZVFpoOWluSU5pajJZZ2cyWVhZdGRpdjJMSFpoOWluSWl3aTJMbllyOWl2SU5pbjJZVFpoZG1JMktmWXJ5RFlwOW1FMllqWXA5aXgySy9ZcVNEWmdkbUtJTmluMllUWmlOaXIyWXJaZ3RpcElOaW4yWVRZcjlpejJLclppTml4MllyWXFTSmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3lmU3g3SW5SNWNHVWlPaUp0WTNFaUxDSjBaWGgwSWpvaTJZalpnZG1DMll2WXB5RFpoTm1FMkxIWW85bUtJTmluMllUWXNkaW4yS3pZclNEWXA5bUUyTERaaWlEWml0aWsyWVBZcnlEWXA5bUUyTGZZcU5tSzJMbllxU0RZcDltRTJLWFpoTml5MktmWmhkbUsyS2tnMllUWmhObUMyS2ZaaHRtSTJZWWcyS2ZaaE5pdjJMUFlxdG1JMkxIWml0aU1JTmlqMllvZzJZWFpoZGluSU5tSzJZVFppaURaaXRtUDJMbllyeURZck5peTJLZllvZG1MSU5pejJZcllwOWl6MllyWmk5aW5JTmk1MllUWmlTRFpoZGl1MktmWmhObUIyS2tnMktmWmhObUMyWWpZcDlpNTJLOGcyS2ZaaE5pdjJMUFlxdG1JMkxIWml0aXAySjhpTENKamFHOXBZMlZ6SWpwYkl0aWwyWVRZdXRpbjJLRWcyS1BaaUNEWmlObUMyWUVnMktyWmh0bUIyWXJZc0NEWXA5bUUyWUxaaU5pbjJZYlppdG1HSU5pbjJZVFpoZGl1MktmWmhObUIyS2tnMllUWmhOaXYyTFBZcXRtSTJMRWlMQ0xZdWRpeTJZUWcyS2ZaaE5tRjJMUFlwTm1JMllUWml0bUdJTmk1MllZZzJLZlpoTm1GMks3WXA5bUUyWUhZcDlpcUlOaW4yWVRZck5pejJZclpoZGlwSWl3aTJMUFlyZGlvSU5pbjJZVFlxTml4MllUWmhkaW4yWVlnMllUWmhOaXIyWUxZcVNEWmhkbUdJTmluMllUWXJkbUQyWWpaaGRpcElpd2kyWUhZc2RpMklOaTUyWUxaaU5pbzJLZllxaURZcDltQzJLcll0ZGluMksvWml0aXBJTml2MllqWmhObUsyS2tpWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TW4wc2V5SjBlWEJsSWpvaWRHWWlMQ0owWlhoMElqb2kyWXJaajlpNTJLcllxTml4SU5pdjJMUFlxdG1JMkxFZzJLZlpoTm1JMllUWXA5bUsyS2ZZcWlEWXA5bUUyWVhZcXRpdDJLL1lxU0RZcDltRTJLUFpoZGl4MllyWmc5bUsyS25ZakNEWXA5bUUyTERaaWlEWW85bVAyWUxZc1NEWXVkaW4yWVVnTVRjNE45bUYySXdnMktQWmlObUVJTml2MkxQWXF0bUkyTEVnMllYWmc5aXEyWWpZcUNEWXJkaXYyWXJZcXlEWmhOaW5JTm1LMkxMWXA5bUVJTm1HMktmWmdkaXcyS2ZaaXlEWXJkaXEyWWtnMktmWmhObUsyWWpaaFM0aUxDSmpiM0p5WldOMFFXNXpkMlZ5SWpvd2ZTeDdJblI1Y0dVaU9pSjBaaUlzSW5SbGVIUWlPaUxaaXRpcTJMUFpoU0RZbzlpejJZVFppTmlvSU5pbjJZVFpoZG1HMkszWXFTRFpnZG1LSU5tRzJMVFlvOWlwSU5pbjJZVFlyOWl6MktmWXF0bUsyTEVnMktqWXROaXgyTG5aaXRpcElOaTAyTG5ZcU5tSzJLa2cyWUxaaU5tSzJLa2cyWWJZdU5peDJLZlppeURaaE5tRTJZWFl0TmluMkxIWmc5aXBJTmluMllUWmhkaW8yS2ZZdE5peDJLa2cyWVRaaE5tRjJZallwOWkzMlliWml0bUdJTm1CMllvZzJZall0dGk1MlljdUlpd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1YMHNleUowZVhCbElqb2lkR1lpTENKMFpYaDBJam9pMllyWXVkaXEyS2pZc1NEWW85aXoyWVRaaU5pb0lOaW4yWVRZck5tRjJMblppdGlwSU5pbjJZVFlxdGlqMkxQWml0aXoyWXJZcVNEWmdkbUtJTm1JMkxiWXVTRFlwOW1FMksvWXM5aW4yS3JaaXRpeElOaW4yWVRZbzltQzJZUWcySy9aaXRtRjJZTFlzZGluMkxmWml0aXBJTm1JMllIWmd0aW4yWXNnMllUWXBkaXMyWVhZcDlpNUlOaW4yWVRaZ2RtQzJZY2cyS2ZaaE5pdjJMUFlxdG1JMkxIWmlpRFlwOW1FMllYWXVkaW4yTFhZc1M0aUxDSmpiM0p5WldOMFFXNXpkMlZ5SWpveGZTeDdJblI1Y0dVaU9pSjBaaUlzSW5SbGVIUWlPaUxaaXRpMDJLcllzZGkzSU5tQjJZb2cyS2ZaaE5peDJZUFpoaURZcDltRTJZWFlwOWl2MllvZzJZVFpoTmk1MkxIWmdTRFlwOW1FMksvWXM5aXEyWWpZc2RtS0lOaWoyWVlnMllyWXF0bUQyTEhZc1NEWXA5bUUyTFBaaE5tSTJZTWcyWVhZc2RpcElObUkyS2ZZcmRpdjJLa2cyWUhaZ3RpM0lObUUyWXJZdGRpbzJLMGcyWUxZcDlpNTJLL1lxU0RZdWRpeDJZSFppdGlwSU5tRjJZVFlzdG1GMktrdUlpd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1YMHNleUowZVhCbElqb2lkR1lpTENKMFpYaDBJam9pMllyWXNkbUIyTFlnMkxyWXA5bUUyS2paaXRpcElOaW4yWVRaZ2RtQzJZY2cyS2ZaaE5pdjJMUFlxdG1JMkxIWmlpRFlwOW1FMllYWXVkaW4yTFhZc1NEWXA5bUUyTG5Zc2RtQklOaW4yWVRaaGRpNTJLL1poQ0RaZ2RtS0lOaW4yWVRZcjlpejJLZllxdG1LMkxFZzJLZlpoTmlzMktmWmhkaXYyS2tnMllUWW85bUcyWWNnMllyWmo5bUIyTEhZdWlEWXA5bUUyWWJZdFNEWXA5bUUySy9ZczlpcTJZallzZG1LSU5tRjJZWWcyWVhZcmRpcTJZallwOW1ISU5tSTJZclpqOW1FMkxyWmlpRFlwZGlzMkxIWXA5aWgyS2ZZcWlEWXA5bUUyS3JZdWRpdjJZclpoQ0RZcDltRTJLL1lzOWlxMllqWXNkbUtJTmluMllUWXNkaXoyWVhaaXRpcExpSXNJbU52Y25KbFkzUkJibk4zWlhJaU9qQjlYWDA9';
    const GEMINI_KEY = '';
    const SECRET_KEY = 'change-this-to-your-own-secret-phrase-12345';
    let fullExamData = JSON.parse(decodeURIComponent(escape(atob(atob(encodedData)))));

    try {
        if (fullExamData.config.botToken) fullExamData.config.botToken = CryptoJS.AES.decrypt(fullExamData.config.botToken, SECRET_KEY).toString(CryptoJS.enc.Utf8);
        if (fullExamData.config.chatId) fullExamData.config.chatId = CryptoJS.AES.decrypt(fullExamData.config.chatId, SECRET_KEY).toString(CryptoJS.enc.Utf8);
        if (fullExamData.config.githubToken) fullExamData.config.githubToken = CryptoJS.AES.decrypt(fullExamData.config.githubToken, SECRET_KEY).toString(CryptoJS.enc.Utf8);
    } catch (e) { console.error("Decryption Error"); }

    const CONFIG = {
        tts: fullExamData.config.enableTextToSpeech,
        ai: fullExamData.config.enableAITutor,
        retry: fullExamData.config.enableSmartRetry,
        layout: fullExamData.config.layout || 'one-by-one', // ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿßÿµŸÑÿ© ŸáŸÜÿß
        qTimer: fullExamData.config.perQuestionTimer,
        qSeconds: fullExamData.config.perQuestionSeconds
    };

    const GITHUB_OWNER = 'alshami2024';
    const GITHUB_REPO = 'alshami';

    let currentQuestions = JSON.parse(JSON.stringify(fullExamData.questions));
    let studentAnswers = {};
    let currentIndex = 0;
    let studentName = "";
    let isRetryMode = false;
    let timerInterval;
    let tabSwitchCount = 0;
    let examFinished = false;
    let examStartTime = null;
    function validateAndStart() {
const now = new Date();
        if (fullExamData.config.startTime) {
            const start = new Date(fullExamData.config.startTime);
            if (now < start) {
                alert("‚õî ÿπÿ∞ÿ±ÿßŸãÿå ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÑŸÖ Ÿäÿ®ÿØÿ£ ÿ®ÿπÿØ!\nŸÖŸàÿπÿØ ÿßŸÑÿ®ÿØÿ°: " + start.toLocaleString());
                return;
            }
        }
        if (fullExamData.config.endTime) {
            const end = new Date(fullExamData.config.endTime);
            if (now > end) {
                alert("‚õî ÿπÿ∞ÿ±ÿßŸãÿå ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±!\nŸÖŸàÿπÿØ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°: " + end.toLocaleString());
                return;
            }
        }
        const nameInput = document.getElementById('studentName').value.trim();
        if(!nameInput) return alert("ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ");
        
        if (fullExamData.config.accessControl && fullExamData.config.accessControl.enabled) {
            const codeInput = document.getElementById('accessCode').value.trim();
            const valid = fullExamData.config.accessControl.students.some(s => 
                s.name.trim().toLowerCase() === nameInput.toLowerCase() && s.code === codeInput
            );
            if (!valid) return alert("ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©");
        }

        studentName = nameInput;
        document.getElementById('studentNameDisplay').textContent = studentName;
        
        const uniqueId = `exam_${fullExamData.config.title}_${studentName}`;
        if(fullExamData.config.singleUseMode && localStorage.getItem(uniqueId)){
            return alert("ŸÑŸÇÿØ ÿ£ÿØŸäÿ™ Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿ≥ÿ®ŸÇÿßŸã.");
        }
        if(fullExamData.config.singleUseMode) localStorage.setItem(uniqueId, 'true');

        sendTelegramNotification(`üîî *ÿ®ÿØÿ° ÿßÿÆÿ™ÿ®ÿßÿ±*\nÿßŸÑÿ∑ÿßŸÑÿ®: ${studentName}\nÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±: ${fullExamData.config.title}`);
        
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('examArea').style.display = 'block';
examStartTime = new Date();
        if(fullExamData.config.shuffle && !isRetryMode) currentQuestions.sort(() => Math.random() - 0.5);
// --- ŸÖŸäÿ≤ÿ© ÿÆŸÑÿ∑ ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™ (Shuffle Choices) ---
        if(fullExamData.config.shuffleChoices && !isRetryMode) {
            currentQuestions.forEach(q => {
                // ÿßŸÑÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸÖŸÜ ŸÜŸàÿπ ÿÆŸäÿßÿ±ÿßÿ™ (mcq) ŸàŸÑŸäÿ≥ ÿµÿ≠/ÿÆÿ∑ÿ£ (tf)
                // ŸàÿßŸÑÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ŸÑÿØŸäŸá ÿÆŸäÿßÿ±ÿßÿ™ ŸÑŸÑÿ•ÿ¨ÿßÿ®ÿ©
                if ((q.type === 'mcq' || q.type === 'MCQ') && q.choices && q.choices.length > 0) {
                    
                    // 1. ÿ±ÿ®ÿ∑ ŸÉŸÑ ŸÜÿµ ÿ®ÿßŸÑŸÅŸáÿ±ÿ≥ ÿßŸÑÿ£ÿµŸÑŸä ŸÑŸá (ÿπÿ¥ÿßŸÜ ŸÜÿπÿ±ŸÅ ŸàŸäŸÜ ÿ±ÿßÿ≠ÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©)
                    let mappedChoices = q.choices.map((text, originalIndex) => {
                        return { text: text, originalIndex: originalIndex };
                    });

                    // 2. ÿÆŸÑÿ∑ ÿßŸÑŸÖÿµŸÅŸàŸÅÿ© ÿπÿ¥Ÿàÿßÿ¶ŸäÿßŸã
                    mappedChoices.sort(() => Math.random() - 0.5);

                    // 3. ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµŸàÿµ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ®ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ¨ÿØŸäÿØ
                    q.choices = mappedChoices.map(item => item.text);

                    // 4. ÿ™ÿ≠ÿØŸäÿ´ ÿ±ŸÇŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸäÿ¥Ÿäÿ± ŸÑŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ¨ÿØŸäÿØ
                    // ŸÜÿ®ÿ≠ÿ´: ŸàŸäŸÜ ÿµÿßÿ± ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑŸÑŸä ŸÉÿßŸÜ ÿ±ŸÇŸÖŸá ŸáŸà (correctAnswer)ÿü
                    const newCorrectIndex = mappedChoices.findIndex(item => item.originalIndex == q.correctAnswer);
                    
                    if (newCorrectIndex !== -1) {
                        q.correctAnswer = newCorrectIndex;
                    }
                }
            });
        }
        
        // ---------------------------------
        if(fullExamData.config.time > 0) startTimer(fullExamData.config.time * 60);
        else document.getElementById('timer').style.display = 'none';

        setupSecurity();
        renderExam();
    }

    function renderExam() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        if(CONFIG.layout === 'one-by-one') {
            renderSingleQuestion(currentIndex, container);
        } else {
            currentQuestions.forEach((q, idx) => {
                const wrapper = document.createElement('div');
                renderSingleQuestion(idx, wrapper);
                container.appendChild(wrapper);
            });
        }
        updateNav();
        updateProgress();
    }
let questionInterval;
let questionEndTime; // ŸÖÿ™ÿ∫Ÿäÿ± ÿ¨ÿØŸäÿØ ŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸàŸÇÿ™ ÿßŸÑŸÜŸáÿßŸäÿ© ÿßŸÑÿ≠ŸÇŸäŸÇŸä

function startQTimer() {
        if (!CONFIG.qTimer || CONFIG.layout !== 'one-by-one') return;
        
        clearInterval(questionInterval);
        
        const now = Date.now();
        questionEndTime = now + (CONFIG.qSeconds * 1000);
        
        updateSmartTimerUI(CONFIG.qSeconds); // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸàÿ±Ÿä
        
        questionInterval = setInterval(() => {
            const currentTime = Date.now();
            const secondsLeft = Math.ceil((questionEndTime - currentTime) / 1000);
            
            updateSmartTimerUI(secondsLeft);
            
            if (secondsLeft <= 0) {
                clearInterval(questionInterval);
                // ŸàŸÖŸäÿ∂ ÿ£ÿÆŸäÿ± ŸÇÿ®ŸÑ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ
                const ring = document.getElementById('smartTimerRing');
                if(ring) { ring.style.background = '#e74c3c'; ring.style.color = '#fff'; }
                
                setTimeout(() => {
                    if (currentIndex < currentQuestions.length - 1) {
                        currentIndex++;
                        renderExam();
                    } else {
                        finishExamWrapper();
                    }
                }, 500);
            }
        }, 200);
    }

    function updateSmartTimerUI(sec) {
        const textEl = document.getElementById('qTimerDisplay');
        const ringEl = document.getElementById('smartTimerRing');
        
        if(textEl && ringEl) {
            textEl.innerText = sec;
            
            // ÿßŸÑŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑÿ£ŸÑŸàÿßŸÜ
            const total = CONFIG.qSeconds;
            const ratio = sec / total;

            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÉŸÑÿßÿ≥ÿßÿ™
            ringEl.classList.remove('timer-warning', 'timer-danger');

            if (sec <= 5) {
                // ÿ¢ÿÆÿ± 5 ÿ´ŸàÿßŸÜŸä: ÿÆÿ∑ÿ± + ŸÜÿ®ÿ∂
                ringEl.classList.add('timer-danger');
            } else if (ratio <= 0.5) {
                // ÿ£ŸÇŸÑ ŸÖŸÜ ŸÜÿµŸÅ ÿßŸÑŸàŸÇÿ™: ÿ™ÿ≠ÿ∞Ÿäÿ± (ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä)
                ringEl.classList.add('timer-warning');
            }
            // ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ∑ÿ®ŸäÿπŸä (ÿ£ÿÆÿ∂ÿ±) ŸáŸà ÿßŸÑÿ≥ÿ™ÿßŸäŸÑ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
        }
    }
    function renderSingleQuestion(idx, container) {
        const q = currentQuestions[idx];
        const voiceBtn = CONFIG.tts ? `<button class="voice-btn" onclick="speak('${q.text.replace(/'/g, "\\'")}')" title="ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ≥ÿ§ÿßŸÑ"><i class="fa-solid fa-volume-high"></i></button>` : '';
        const imgHtml = q.image ? `<div style="text-align:center; margin-bottom:10px;"><img src="${q.image}" style="max-width:100%; border-radius:8px; max-height:200px;"></div>` : '';
        
        // --- ŸÉŸàÿØ ÿßŸÑŸÖÿ§ŸÇÿ™ ÿßŸÑÿ∞ŸÉŸä ---
        let timerHtml = '';
        if (CONFIG.qTimer && CONFIG.layout === 'one-by-one') {
            timerHtml = `
            <div class="smart-timer-container">
                <div id="smartTimerRing" class="smart-timer">
                    <span id="qTimerDisplay">${CONFIG.qSeconds}</span>
                </div>
            </div>`;
            setTimeout(startQTimer, 100); 
        }

        let html = `
            <div class="question-card" id="q-card-${idx}" style="margin-top: 30px;">
                ${timerHtml}
                ${voiceBtn}
                ${imgHtml}
                <h3 style="margin-top:15px; padding-right: ${CONFIG.tts?40:0}px;">${idx + 1}. ${q.text}</h3>
        `;

        if(q.type === 'mcq' || q.type === 'tf') {
            const options = q.type === 'tf' ? ['ÿµÿ≠', 'ÿÆÿ∑ÿ£'] : q.choices;
            html += '<ul class="choices">';
            options.forEach((opt, optIdx) => {
                const isSelected = studentAnswers[idx] === optIdx ? 'selected' : '';
                html += `<li class="${isSelected}" onclick="selectOption(${idx}, ${optIdx}, this)">
                    <div style="width:20px; height:20px; border:2px solid #ccc; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-left:10px;">
                        ${isSelected ? '<div style="width:10px; height:10px; background:var(--primary-color); border-radius:50%;"></div>' : ''}
                    </div>
                    ${opt}
                </li>`;
            });
            html += '</ul>';
        } else {
            html += `<textarea style="width:100%; border:1px solid #ddd; padding:10px; border-radius:8px;" rows="4" placeholder="ÿßŸÉÿ™ÿ® ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ŸáŸÜÿß..." oninput="studentAnswers[${idx}]=this.value">${studentAnswers[idx]||''}</textarea>`;
        }
        
        html += '</div>';
        container.innerHTML += html;
    } 

    // ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ÿ£ÿµÿ®ÿ≠ÿ™ ŸÖŸÜŸÅÿµŸÑÿ© Ÿàÿ™ÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ¢ŸÜ
    function selectOption(qIdx, optIdx, el) {
        studentAnswers[qIdx] = optIdx;
        if(CONFIG.layout === 'one-by-one') {
            const parent = el.parentElement;
            parent.querySelectorAll('li').forEach(l => {
                l.classList.remove('selected');
                l.querySelector('div').innerHTML = '';
            });
            el.classList.add('selected');
            el.querySelector('div').innerHTML = '<div style="width:10px; height:10px; background:var(--primary-color); border-radius:50%;"></div>';
            
            if(fullExamData.config.learningMode && !isRetryMode) {
                 const isCorrect = optIdx === currentQuestions[qIdx].correctAnswer;
                 el.style.background = isCorrect ? '#d4edda' : '#f8d7da';
                 el.style.borderColor = isCorrect ? '#c3e6cb' : '#f5c6cb';
            }
        } else {
            renderExam(); 
        }
        updateProgress();
    }

    function updateNav() {
        const navDiv = document.getElementById('navButtons');
        navDiv.innerHTML = '';
        
        if(CONFIG.layout === 'one-by-one') {
            if(currentIndex > 0 && !fullExamData.config.noGoingBack) {
                navDiv.innerHTML += `<button class="btn" style="background:#6c757d" onclick="currentIndex--; renderExam()">ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>`;
            }
            if(currentIndex < currentQuestions.length - 1) {
                navDiv.innerHTML += `<button class="btn" onclick="currentIndex++; renderExam()">ÿßŸÑÿ™ÿßŸÑŸä</button>`;
            } else {
                navDiv.innerHTML += `<button class="btn btn-danger" onclick="finishExamWrapper()">ÿ•ŸÜŸáÿßÿ° Ÿàÿ™ÿ≥ŸÑŸäŸÖ üèÅ</button>`;
            }
        } else {
            navDiv.innerHTML += `<button class="btn btn-danger" style="width:100%" onclick="finishExamWrapper()">ÿ•ŸÜŸáÿßÿ° Ÿàÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ üèÅ</button>`;
        }
    }

    function updateProgress() {
        const answered = Object.keys(studentAnswers).length;
        const total = currentQuestions.length;
        const pct = (answered / total) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
    }

    async function finishExamWrapper() {
        if(!confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©ÿü")) return;
        finishExam();
    }

   async function finishExam() {
        if(examFinished) return;
        examFinished = true;
        clearInterval(timerInterval);
        if(typeof questionInterval !== 'undefined') clearInterval(questionInterval);
        
        document.getElementById('examArea').style.display = 'none';
        document.getElementById('savingScreen').style.display = 'block';

        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™
        const endTime = new Date();
        const timeDiff = examStartTime ? Math.floor((endTime - examStartTime) / 1000) : 0;
        const minutes = Math.floor(timeDiff / 60).toString().padStart(2, '0');
        const seconds = (timeDiff % 60).toString().padStart(2, '0');
        const timeFormatted = `${minutes}:${seconds}`;

        let correct = 0;
        let total = 0;
        let wrongIndices = [];
        let detailedAnswers = [];
        let essayTotalMax = 0;

        currentQuestions.forEach((q, i) => {
            const studentAns = studentAnswers[i];
            const qType = (q.type || 'mcq').toLowerCase();

            let ansObj = {
                question: q.text,
                type: qType, 
                isCorrect: false,
                isGraded: true, 
                maxScore: 1, 
                answer: "ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©"
            };

            if(qType === 'mcq' || qType === 'tf') {
                total++;
                let opts = q.choices;
                if(qType === 'tf') opts = ['ÿµÿ≠', 'ÿÆÿ∑ÿ£'];

                if(studentAns !== undefined && studentAns !== null && opts[studentAns] !== undefined) {
                    ansObj.answer = opts[studentAns];
                }
                
                if(parseInt(studentAns) === parseInt(q.correctAnswer)) {
                    correct++;
                    ansObj.isCorrect = true;
                } else {
                    wrongIndices.push(i);
                    ansObj.isCorrect = false;
                    if(opts && opts[q.correctAnswer]) {
                        ansObj.correctAnswer = opts[q.correctAnswer];
                    }
                }
            } else {
                ansObj.answer = studentAns || "ŸÑÿß ÿ•ÿ¨ÿßÿ®ÿ©";
                ansObj.isGraded = false; 
                ansObj.essayScore = 0;
                ansObj.maxScore = q.maxScore || 10;
                essayTotalMax += ansObj.maxScore;
            }
            detailedAnswers.push(ansObj);
        });

        const percentage = total > 0 ? Math.round((correct/total)*100) : 0;
        const passed = percentage >= fullExamData.config.successPercentage;

        if(fullExamData.config.githubToken && fullExamData.config.resultsFilename) {
            await saveToGithub(correct, total, wrongIndices, detailedAnswers, essayTotalMax);
        }

        await sendTelegramNotification(`üìä *ŸÜÿ™Ÿäÿ¨ÿ©*\nÿßŸÑÿ∑ÿßŸÑÿ®: ${studentName}\nÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©: ${correct}/${total} (${percentage}%)\nÿßŸÑŸàŸÇÿ™: ${timeFormatted}`);

        document.getElementById('savingScreen').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'block';

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
        document.getElementById('statCorrect').innerText = correct;
        document.getElementById('statWrong').innerText = total - correct;
        document.getElementById('statTime').innerText = timeFormatted;
document.getElementById('resultStudentName').innerText = studentName;
        // ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑÿØÿßÿ¶ÿ±ÿ©
        const circle = document.getElementById('scoreCircle');
        const numberEl = document.getElementById('finalScoreNumber');
        const color = passed ? '#2ecc71' : '#e74c3c';
        
        let currentPct = 0;
        const timer = setInterval(() => {
            if(percentage === 0) { clearInterval(timer); numberEl.innerText = "0%"; return; }
            currentPct++;
            numberEl.innerText = currentPct + "%";
            numberEl.style.color = color;
            circle.style.background = `conic-gradient(${color} ${currentPct * 3.6}deg, #eee ${currentPct * 3.6}deg)`;
            if (currentPct >= percentage) clearInterval(timer);
        }, 20);

        // ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ∞ŸÉŸäÿ©
        const msgEl = document.getElementById('gradeMessage');
        const subEl = document.getElementById('gradeSubtext');
        
        if (percentage >= 95) {
            msgEl.innerText = "ÿ£ÿØÿßÿ° ÿ£ÿ≥ÿ∑Ÿàÿ±Ÿä! üèÜ";
            msgEl.style.color = "#f1c40f";
            subEl.innerText = "ÿ£ŸÜÿ™ ÿπÿ®ŸÇÿ±Ÿäÿå ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ£ŸÑŸÇ.";
            startConfetti();
        } else if (percentage >= 85) {
            msgEl.innerText = "ŸÖŸÖÿ™ÿßÿ≤ ÿ¨ÿØÿßŸã! üåü";
            msgEl.style.color = "#2ecc71";
            subEl.innerText = "ÿ£ÿØÿßÿ° ÿ±ÿßÿ¶ÿπÿå ÿ™ÿ™ÿ®ŸÇŸâ ÿÆÿ∑Ÿàÿ© ÿµÿ∫Ÿäÿ±ÿ©.";
            startConfetti();
        } else if (percentage >= 75) {
            msgEl.innerText = "ÿ¨ŸäÿØ ÿ¨ÿØÿßŸã üëç";
            msgEl.style.color = "#3498db";
            subEl.innerText = "ŸÜÿ™Ÿäÿ¨ÿ© ÿ∑Ÿäÿ®ÿ©.";
        } else if (percentage >= 50) {
            msgEl.innerText = "ŸÜÿßÿ¨ÿ≠ üôÇ";
            msgEl.style.color = "#e67e22";
            subEl.innerText = "ŸÑŸÇÿØ ÿπÿ®ÿ±ÿ™ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±.";
        } else {
            msgEl.innerText = "ÿ≠ÿ∏ÿßŸã ÿ£ŸàŸÅÿ± üòî";
            msgEl.style.color = "#e74c3c";
            subEl.innerText = "ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
        }

        // ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
        const btnContainer = document.getElementById('modernActionButtons');
        let btnsHtml = '';

        if(CONFIG.retry && wrongIndices.length > 0) {
            btnsHtml += `<button class="action-btn-modern btn-retry" onclick='startSmartRetry(${JSON.stringify(wrongIndices)})'><i class="fa-solid fa-rotate-left"></i> ÿ™ÿµÿ≠Ÿäÿ≠ ÿ£ÿÆÿ∑ÿßÿ¶Ÿä</button>`;
        }
        
        if(fullExamData.config.enableReview) {
            btnsHtml += `<button class="action-btn-modern btn-review" onclick="document.getElementById('reviewArea').scrollIntoView({behavior:'smooth'})"><i class="fa-solid fa-eye"></i> ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™</button>`;
            btnsHtml += `<button class="action-btn-modern btn-print" onclick="window.print()"><i class="fa-solid fa-print"></i> ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©</button>`;
        }

        if(fullExamData.config.enableCertificate && passed) {
            btnsHtml += `<button class="action-btn-modern btn-cert" onclick="showCertificate()"><i class="fa-solid fa-certificate"></i> ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ¥ŸáÿßÿØÿ©</button>`;
            document.getElementById('certName').textContent = studentName;
            document.getElementById('certScore').textContent = percentage + "%";
            document.getElementById('certDate').textContent = new Date().toLocaleDateString('ar-EG');
        }
        
        btnContainer.innerHTML = btnsHtml;

        if(fullExamData.config.showResults && fullExamData.config.enableReview) {
            renderDetailedReview(wrongIndices);
        }
    }

    function showCertificate() {
        document.getElementById('certificateArea').style.display = 'block';
        document.getElementById('certificateArea').scrollIntoView({behavior:'smooth'});
        startConfetti();
    }

    function startConfetti() {
        const colors = ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6'];
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti');
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
            confetti.style.opacity = Math.random();
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 5000);
        }
    }

    function renderDetailedReview(wrongIndices) {
        const div = document.getElementById('reviewArea');
        div.innerHTML = '<h3 style="border-bottom:2px solid #eee; padding-bottom:10px;">ŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™</h3>';
        
        currentQuestions.forEach((q, i) => {
            const userAnsIdx = studentAnswers[i];
            const isCorrect = userAnsIdx === q.correctAnswer;
            
            let userAnsText = "ŸÑŸÖ ÿ™ÿ™ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©";
            let correctAnsText = "";
            
            if(q.type === 'mcq' || q.type === 'tf') {
                const opts = q.type === 'tf' ? ['ÿµÿ≠', 'ÿÆÿ∑ÿ£'] : q.choices;
                if(userAnsIdx !== undefined) userAnsText = opts[userAnsIdx];
                correctAnsText = opts[q.correctAnswer];
            } else {
                userAnsText = studentAnswers[i] || "";
                correctAnsText = "ŸÖÿ™ÿ±ŸàŸÉ ŸÑŸÑŸÖÿµÿ≠ÿ≠";
            }

            const bg = isCorrect ? '#d4edda' : '#f8d7da';
            const icon = isCorrect ? '‚úîÔ∏è' : '‚ùå';

            let aiBtn = '';
            if(!isCorrect && CONFIG.ai && GEMINI_KEY && (q.type==='mcq'||q.type==='tf')) {
                aiBtn = `<button class="btn" style="font-size:0.8rem; background:#673ab7; margin-top:10px;" onclick="askAI(this, ${i})"><i class="fa-solid fa-robot"></i> ŸÑŸÖÿßÿ∞ÿß ÿ•ÿ¨ÿßÿ®ÿ™Ÿä ÿÆÿßÿ∑ÿ¶ÿ©ÿü</button>
                         <div id="ai-res-${i}" class="ai-explanation-box"></div>`;
            }

            div.innerHTML += `
                <div class="question-card" style="background:${bg}; border-color:${isCorrect?'#c3e6cb':'#f5c6cb'}">
                    <p><strong>${i+1}. ${q.text}</strong></p>
                    <p>ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ: <b>${userAnsText}</b> ${icon}</p>
                    ${!isCorrect ? `<p style="color:#155724;">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: <b>${correctAnsText}</b></p>` : ''}
                    ${aiBtn}
                </div>
            `;
        });
    }

    async function askAI(btn, idx) {
        const q = currentQuestions[idx];
        const opts = q.type === 'tf' ? ['ÿµÿ≠', 'ÿÆÿ∑ÿ£'] : q.choices;
        const userTxt = opts[studentAnswers[idx]] || "ŸÑÿß ŸäŸàÿ¨ÿØ";
        const corrTxt = opts[q.correctAnswer];
        
        const resBox = document.getElementById(`ai-res-${idx}`);
        resBox.style.display = 'block';
        resBox.innerHTML = '<span class="spinner"></span> ÿ¨ÿßÿ±Ÿä ÿ≥ÿ§ÿßŸÑ ÿßŸÑŸÖÿπŸÑŸÖ ÿßŸÑÿ∞ŸÉŸä...';
        btn.disabled = true;

        const prompt = `ÿßÿ¥ÿ±ÿ≠ ŸÑÿ∑ÿßŸÑÿ® ŸÑŸÖÿßÿ∞ÿß ÿ•ÿ¨ÿßÿ®ÿ™Ÿá ÿÆÿßÿ∑ÿ¶ÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ®ÿßÿÆÿ™ÿµÿßÿ±. ÿßŸÑÿ≥ÿ§ÿßŸÑ: "${q.text}". ÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ∑ÿßŸÑÿ® ÿßŸÑÿÆÿßÿ∑ÿ¶ÿ©: "${userTxt}". ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: "${corrTxt}".`;
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            resBox.innerHTML = `<strong>ü§ñ ÿßŸÑŸÖÿπŸÑŸÖ ÿßŸÑÿ∞ŸÉŸä:</strong><br>${data.candidates[0].content.parts[0].text}`;
        } catch(e) {
            resBox.innerHTML = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä.';
            btn.disabled = false;
        }
    }

    function speak(text) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-SA';
            window.speechSynthesis.speak(u);
        }
    }

    function startSmartRetry(indices) {
        const wrongQs = indices.map(i => currentQuestions[i]);
        currentQuestions = wrongQs;
        studentAnswers = {};
        currentIndex = 0;
        isRetryMode = true;
        
        document.getElementById('resultScreen').style.display = 'none';
        document.getElementById('examArea').style.display = 'block';
        renderExam();
        alert("ÿ®ÿØÿ£ÿ™ ÿ¨ŸàŸÑÿ© ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©! ÿ±ŸÉÿ≤ ÿ¨ŸäÿØÿßŸã Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ© üí™");
    }

    async function saveToGithub(correct, total, wrongIndices, detailedAnswers, essayTotalMax) {
        const { githubToken, resultsFilename } = fullExamData.config;
        if(!githubToken || !resultsFilename) return;
        
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/exam/${resultsFilename}`;
        
        // --- ŸáŸäŸÉŸÑÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ---
        const resultPayload = {
            studentName: studentName,
            submissionDate: new Date().toISOString(),
            mcqScore: { correct, total }, // ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿßÿ≥ŸÖ ŸÑŸäÿ™ÿ∑ÿßÿ®ŸÇ
            essayScore: { totalScore: 0, totalMax: essayTotalMax }, // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÇÿßŸÑŸä
            answers: detailedAnswers, // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ ŸÉÿßŸÖŸÑÿ©
            tabSwitchCount: tabSwitchCount
        };

        try {
            let currentData = [];
            let sha = null;
            try {
                const getRes = await fetch(url, { headers: { 'Authorization': `token ${githubToken}` } });
                if(getRes.ok) {
                    const json = await getRes.json();
                    sha = json.sha;
                    currentData = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                }
            } catch(e){}

            currentData.push(resultPayload);
            // ÿ™ÿ±ŸÖŸäÿ≤ UTF-8 ÿ¢ŸÖŸÜ
            const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2))));
            
            await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'New Result', content: contentEncoded, sha: sha })
            });
        } catch(e) { console.error("Github Save Failed", e); }
    }

    async function sendTelegramNotification(text) {
        const { botToken, chatId } = fullExamData.config;
        if(!botToken || !chatId) return;
        try {
            await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'Markdown' })
            });
        } catch(e){}
    }

    function startTimer(seconds) {
        const display = document.getElementById('timer');
        let remaining = seconds;
        timerInterval = setInterval(() => {
            remaining--;
            const m = Math.floor(remaining / 60).toString().padStart(2, '0');
            const s = (remaining % 60).toString().padStart(2, '0');
            display.textContent = `${m}:${s}`;
            if(remaining <= 0) {
                clearInterval(timerInterval);
                alert("ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!");
                finishExam();
            }
        }, 1000);
    }

    function setupSecurity() {
        if(fullExamData.config.disableCheating) {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('copy', e => e.preventDefault());
        }
        if(fullExamData.config.monitorTabs) {
            document.addEventListener('visibilitychange', () => {
                if(document.hidden && !examFinished) {
                    tabSwitchCount++;
                    if(fullExamData.config.finishOnSwitch) {
                        finishExam();
                        alert("ÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ®ÿ≥ÿ®ÿ® ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿµŸÅÿ≠ÿ©!");
                    }
                }
            });
        }
    }
// --- Smart Timing System (ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ŸàŸÇŸäÿ™ ÿßŸÑÿ∞ŸÉŸä) ---
    (function checkExamStatus() {
        const waitingRoom = document.getElementById('waitingRoom');
        const expiredRoom = document.getElementById('expiredRoom');
        const startDisplay = document.getElementById('startDateDisplay');
        const endDisplay = document.getElementById('endDateDisplay');
        
        // 1. ÿ¨ŸÑÿ® ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ
        const startTimeStr = fullExamData.config.startTime;
        const endTimeStr = fullExamData.config.endTime;
        
        if (!startTimeStr && !endTimeStr) return; // ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÖŸÅÿ™Ÿàÿ≠ ÿØÿßÿ¶ŸÖÿßŸã
        
        const startDate = startTimeStr ? new Date(startTimeStr) : null;
        const endDate = endTimeStr ? new Date(endTimeStr) : null;
        
        if(startDisplay && startDate) startDisplay.innerText = startDate.toLocaleString('ar-EG');
        if(endDisplay && endDate) endDisplay.innerText = endDate.toLocaleString('ar-EG');

        // ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±
        const timer = setInterval(() => {
            const now = new Date();

            // ÿ£) ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖŸÜÿ™ŸáŸä
            if (endDate && now > endDate) {
                clearInterval(timer);
                waitingRoom.style.display = 'none';
                expiredRoom.style.display = 'flex'; // ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
                document.querySelector('.container').style.display = 'none'; // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ£ÿµŸÑŸä
                return;
            }

            // ÿ®) ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ∞Ÿä ŸÑŸÖ Ÿäÿ®ÿØÿ£ (ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±)
            if (startDate && now < startDate) {
                waitingRoom.style.display = 'flex'; // ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
                document.querySelector('.container').style.display = 'none'; // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ£ÿµŸÑŸä
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä
                const diff = startDate - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØÿßÿ™
                document.getElementById('cd-days').innerText = days.toString().padStart(2, '0');
                document.getElementById('cd-hours').innerText = hours.toString().padStart(2, '0');
                document.getElementById('cd-minutes').innerText = minutes.toString().padStart(2, '0');
                document.getElementById('cd-seconds').innerText = seconds.toString().padStart(2, '0');
            } 
            // ÿ¨) ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ (ÿ≠ÿßŸÜ ÿßŸÑŸàŸÇÿ™!)
            else {
                // ÿ•ÿ∞ÿß ŸÉŸÜÿß ŸÅŸä ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±ÿå ŸÜÿÆŸÅŸäŸáÿß ŸàŸÜÿ∏Ÿáÿ± ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±
                if (waitingRoom.style.display !== 'none') {
                    waitingRoom.style.opacity = '0';
                    setTimeout(() => {
                        waitingRoom.style.display = 'none';
                        document.querySelector('.container').style.display = 'block';
                        // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿ™ŸÜÿ®ŸäŸá ÿ®ÿ≥Ÿäÿ∑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
                        // new Audio('notification.mp3').play().catch(e=>{});
                    }, 500);
                }
            }
        }, 1000); // ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑ ÿ´ÿßŸÜŸäÿ©
    })();
</script>
</body>
</html>
    