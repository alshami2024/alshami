
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø£Ù†Ø«Ø±ÙˆØ¨ÙˆÙ„ÙˆØ¬ÙŠØ§</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0056b3; --bg-color: #e9ecef; --white: #fff; --danger: #dc3545; --success: #28a745; --warning: #ffc107; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; direction: rtl; line-height: 1.6; }
        .container { background-color: var(--white); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 850px; margin: 0 auto; padding: 25px; min-height: 80vh; position: relative; z-index: 10; }
        .btn { background: var(--primary-color); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-family: inherit; margin: 5px; font-weight: bold; transition: 0.3s; width: 100%; font-size: 1.1rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .question-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; transition: 0.3s; }
        .choices { list-style: none; padding: 0; }
        .choices li { background: #fff; border: 1px solid #ddd; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .choices li:hover { background: #e9ecef; border-color: var(--primary-color); }
        .choices li.selected { border-color: var(--primary-color); background: #e7f1ff; font-weight: bold; }
        .voice-btn { position: absolute; top: 15px; left: 15px; background: #fff; border: 1px solid #ddd; width: 35px; height: 35px; border-radius: 50%; color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; z-index: 5; }
        .voice-btn:hover { background: var(--primary-color); color: #fff; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .timer-badge { background: #ffeeee; color: var(--danger); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid #ffcccc; }
        .smart-timer-container { position: absolute; top: -25px; left: 20px; z-index: 50; }
        .smart-timer { width: 50px; height: 50px; background: white; border: 4px solid #2ecc71; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: monospace; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .timer-danger { border-color: #e74c3c; color: #c0392b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .result-dashboard { text-align: center; padding: 20px 0; display: none; }
        .score-circle-container { position: relative; width: 180px; height: 180px; margin: 0 auto 25px; }
        .score-circle { width: 100%; height: 100%; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; transition: background 1s ease-out; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .score-inner { width: 85%; height: 85%; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .score-number { font-size: 3rem; font-weight: 800; color: var(--primary-color); line-height: 1; }
        .grade-message { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; color: #2d3436; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        .stat-val { font-size: 1.2rem; font-weight: bold; display: block; color: #2d3436; }
        .ai-explanation-box { background: #e3f2fd; border-right: 4px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 6px; display: none; font-size: 0.9em; text-align: right; }
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 9999; top: -10px; }

        /* --- Smart Overlay Styles (Waiting & Expired) --- */
        .smart-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; color: white; font-family: 'Tajawal', sans-serif; overflow: hidden;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ (Tamper Room) */
        #tamperRoom { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); }

        /* Glassmorphism Card */
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 40px; border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center; max-width: 90%; width: 450px;
            animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative; z-index: 2;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* Animated Background Particles */
        .circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1; }
        .circles li { position: absolute; display: block; list-style: none; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.2); animation: animate 25s linear infinite; bottom: -150px; border-radius: 50%; }
        .circles li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .circles li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .circles li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .circles li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .circles li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .circles li:nth-child(6){ left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .circles li:nth-child(7){ left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .circles li:nth-child(8){ left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .circles li:nth-child(9){ left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .circles li:nth-child(10){ left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }
        @keyframes animate { 0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; } 100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; } }

        /* Countdown Styles */
        .countdown-container { display: flex; justify-content: center; gap: 10px; margin: 25px 0; }
        .time-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; min-width: 60px; }
        .time-val { font-size: 2rem; font-weight: 800; display: block; line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .time-lbl { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; margin-top: 5px; display: block; }
        
        .status-icon { font-size: 4rem; margin-bottom: 20px; display: inline-block; }
        .waiting-icon { color: #f1c40f; animation: pulseIcon 2s infinite; }
        .expired-icon { color: #e74c3c; }
        .tamper-icon { color: #fff; animation: shake 0.5s; animation-iteration-count: infinite; }
        
        @keyframes pulseIcon { 0% { transform: scale(1); opacity: 0.9; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 0.9; } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        .jamal-signature { margin-top: 30px; font-family: 'Courier New', monospace; font-size: 0.9rem; letter-spacing: 2px; opacity: 0.6; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; display: inline-block; width: 100%; }
        
        
                    :root { --primary-color: #6c5ce7; --secondary-color: #a29bfe; --light-gray: #f3f0ff; --dark-gray: #2d3436; --success-color: #00b894; --danger-color: #d63031; --background-color: #dfe6e9; --text-color: #2d3436; --white: #fff; }
                    body { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); min-height: 100vh; }
                    .container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 16px; }
                    .btn { background: linear-gradient(45deg, #6c5ce7, #a29bfe); border: none; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4); }
                    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(108, 92, 231, 0.6); }
                    .question-card { box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: none; }
                    .choices li { transition: all 0.3s ease; border: 2px solid #f3f0ff; }
                    .choices li:hover { border-color: #6c5ce7; transform: translateX(-5px); }
                    #certificate { background: #fff; border: 2px solid #6c5ce7; box-shadow: 0 0 20px rgba(108, 92, 231, 0.2); }
                
    </style>
</head>
<body>

<ul class="circles">
    <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
</ul>

<div class="container">
    <div id="startScreen">
        <h1 style="color:var(--primary-color); margin-bottom:10px;">Ø§Ù„Ø£Ù†Ø«Ø±ÙˆØ¨ÙˆÙ„ÙˆØ¬ÙŠØ§</h1>
        <p style="color:#666; margin-bottom:20px;">Ø§Ø®ØªØ¨Ø§Ø± ÙŠÙ‚ÙŠØ³ ÙÙ‡Ù… Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ù†Ø«Ø±ÙˆØ¨ÙˆÙ„ÙˆØ¬ÙŠØ§ ÙˆØ¹Ù„Ù… Ø§Ù„Ù†ÙØ³ ÙˆØ§Ù…ØªØ¯Ø§Ø¯Ù‡Ø§ Ø¥Ù„Ù‰ Ø¹Ù„ÙˆÙ… Ø§Ù„ØªØ±Ø¨ÙŠØ©</p>
     
<div style="background:#f1f3f5; padding:15px; border-radius:8px; margin-bottom:20px;">
    <i class="fa-regular fa-clock"></i> Ø§Ù„Ù…Ø¯Ø©: 10 Ø¯Ù‚ÙŠÙ‚Ø© <br>
    <i class="fa-solid fa-list-ol"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: 10
    
    
    <div style="margin-top:8px; color: #d63031; font-weight: bold; border-top: 1px dashed #ccc; padding-top: 8px;">
        <i class="fa-solid fa-calendar-times"></i> ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: 
        <span style="direction: ltr; display: inline-block;">
            Ø§Ù„Ø®Ù…ÙŠØ³ØŒ Ù¨ ÙŠÙ†Ø§ÙŠØ± Ù¢Ù Ù¢Ù¦ ÙÙŠ Ù Ù¤:Ù Ù  Ù…
        </span>
    </div>
    
</div>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
        
        <div class="form-group">
            <label for="studentName">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="studentName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        
    
        <button id="startBtn" onclick="validateAndStart()" class="btn">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸš€</button>
        <div class="footer-copyright" style="margin-top:30px; text-align:center; color:#888; font-size:0.8rem;">Jamal-Alshami Â© 2025</div>
    </div>

    <div id="examArea" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="font-weight:bold;"><i class="fa-regular fa-user"></i> <span id="studentNameDisplay"></span></div>
            <div id="timer" class="timer-badge">00:00</div>
        </div>
        <div style="height:8px; background:#eee; border-radius:10px; margin-bottom:25px; overflow:hidden;">
            <div id="progressBar" style="height:100%; width:0%; background:var(--success); transition:0.4s ease-out;"></div>
        </div>
        <div id="questionsContainer"></div>
        <div id="navButtons" style="margin-top:25px; display:flex; gap:10px; justify-content: flex-end;"></div>
    </div>

    <div id="savingScreen" style="display:none; text-align:center; padding:40px;"><h3>Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ...</h3></div>

    <div id="resultScreen" class="result-dashboard">
        <div class="score-circle-container">
            <div id="scoreCircle" class="score-circle">
                <div class="score-inner"><span id="finalScoreNumber" class="score-number">0%</span><span style="font-size: 0.9rem; color: #888;">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</span></div>
            </div>
        </div>
        <h2 id="resultStudentName" style="color:var(--primary-color);"></h2>
        <div id="gradeMessage" class="grade-message"></div>
        <div class="stats-grid">
            <div class="stat-card"><span style="font-size:1.5rem;">âœ”ï¸</span><span id="statCorrect" class="stat-val">0</span><span style="color:#888;">ØµØ­ÙŠØ­Ø©</span></div>
            <div class="stat-card"><span style="font-size:1.5rem;">âŒ</span><span id="statWrong" class="stat-val">0</span><span style="color:#888;">Ø®Ø§Ø·Ø¦Ø©</span></div>
            <div class="stat-card"><span style="font-size:1.5rem;">â±ï¸</span><span id="statTime" class="stat-val">00:00</span><span style="color:#888;">Ø§Ù„ÙˆÙ‚Øª</span></div>
        </div>
        <div id="modernActionButtons" style="margin-top:20px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;"></div>
        <div id="certificateArea" style="display:none; border: 10px double var(--primary-color); padding: 30px; margin-top: 30px; background: #fff; position: relative; text-align:center;">
            <h2 style="color:var(--primary-color);">Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù…</h2>
            <p>ØªØ´Ù‡Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©:</p>
            <h1 id="certName" style="margin: 15px 0;"></h1>
            <p>Ù‚Ø¯ Ø§Ø¬ØªØ§Ø² Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ù†ØªÙŠØ¬Ø©:</p>
            <h2 id="certScore" style="color:var(--success);"></h2>
            <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="certDate"></span></p>
        </div>
        <div id="reviewArea" style="text-align:right; margin-top:30px;"></div>
    </div>
</div>

<div id="waitingRoom" class="smart-overlay">
    <div class="glass-panel">
        <i class="fa-solid fa-hourglass-start status-icon waiting-icon"></i>
        <h2 style="margin:0; font-size:1.8rem;">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</h2>
        <p style="opacity:0.9; margin-top:10px;">Ø§Ø³ØªØ¹Ø¯! Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø®Ù„Ø§Ù„:</p>
        <div class="countdown-container">
            <div class="time-box"><span class="time-val" id="cd-days">0</span><span class="time-lbl">ÙŠÙˆÙ…</span></div>
            <div class="time-box"><span class="time-val" id="cd-hours">00</span><span class="time-lbl">Ø³Ø§Ø¹Ø©</span></div>
            <div class="time-box"><span class="time-val" id="cd-minutes">00</span><span class="time-lbl">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
            <div class="time-box"><span class="time-val" id="cd-seconds">00</span><span class="time-lbl">Ø«Ø§Ù†ÙŠØ©</span></div>
        </div>
        <div style="font-size:0.9rem; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; display:inline-block;">
            <i class="fa-regular fa-calendar-check"></i> Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡: <span id="startDateDisplay" style="font-weight:bold; color:#f1c40f;"></span>
        </div>
        <div class="jamal-signature">Jamal-Alshami</div>
    </div>
</div>

<div id="expiredRoom" class="smart-overlay">
    <div class="glass-panel" style="border-color: rgba(231, 76, 60, 0.3);">
        <i class="fa-solid fa-lock status-icon expired-icon"></i>
        <h2 style="margin:0; font-size:2rem; color:#ffcccc;">Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
        <p style="margin: 15px 0; font-size:1.1rem; line-height:1.6;">
            Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ØªØ§Ø­Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„.<br>
            Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø£Ùˆ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.
        </p>
        <button class="btn" style="background:rgba(255,255,255,0.2); border:1px solid white; width:auto; margin-top:15px;" onclick="window.location.reload()">
            <i class="fa-solid fa-rotate-right"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
        </button>
        <div class="jamal-signature">Jamal-Alshami</div>
    </div>
</div>

<div id="tamperRoom" class="smart-overlay">
    <div class="glass-panel" style="background: rgba(0,0,0,0.4); border-color: red;">
        <i class="fa-solid fa-triangle-exclamation status-icon tamper-icon"></i>
        <h2 style="margin:0; font-size:2rem; color:#fff;">âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªÙ„Ø§Ø¹Ø¨</h2>
        <p style="margin: 15px 0; font-size:1.1rem; line-height:1.6; color:#ffcccc;">
            Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØºÙŠÙŠØ± ØªØ§Ø±ÙŠØ® Ø£Ùˆ ÙˆÙ‚Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.<br>
            ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©.
        </p>
        <div style="background:rgba(255,0,0,0.2); padding:10px; border-radius:5px; font-size:0.9rem; margin-top:10px;">
            Error Code: TIME_INTEGRITY_FAIL
        </div>
        <div class="jamal-signature">Jamal-Alshami Security System</div>
    </div>
</div>

<script>
    const encodedData = 'ZXlKamIyNW1hV2NpT25zaWRHbDBiR1VpT2lMWXA5bUUyS1BaaHRpcjJMSFppTmlvMllqWmhObUkyS3paaXRpbklpd2laR1Z6WTNKcGNIUnBiMjRpT2lMWXA5aXUyS3JZcU5pbjJMRWcyWXJaZ3RtSzJMTWcyWUhaaDltRklOaW4yWVRZdWRtRTJLZlpndGlwSU5pbjJZVFpoZGlxMktqWXA5aXYyWVRZcVNEWXFObUsyWVlnMktmWmhOaWoyWWJZcTlpeDJZallxTm1JMllUWmlOaXMyWXJZcHlEWmlOaTUyWVRaaFNEWXA5bUUyWWJaZ2RpeklObUkyS2ZaaGRpcTJLL1lwOWl2MllmWXB5RFlwZG1FMllrZzJMblpoTm1JMllVZzJLZlpoTmlxMkxIWXFObUsyS2tpTENKemRHRnlkRlJwYldVaU9pSXlNREkyTFRBeExUQXhWREUyT2pBd0lpd2laVzVrVkdsdFpTSTZJakl3TWpZdE1ERXRNRGhVTVRZNk1EQWlMQ0pzWVhsdmRYUWlPaUp2Ym1VdFlua3RiMjVsSWl3aWRHbHRaU0k2TVRBc0luTm9kV1ptYkdVaU9uUnlkV1VzSW5Ob2RXWm1iR1ZEYUc5cFkyVnpJanAwY25WbExDSnViMGR2YVc1blFtRmpheUk2ZEhKMVpTd2laR2x6WVdKc1pVTm9aV0YwYVc1bklqcDBjblZsTENKdGIyNXBkRzl5VkdGaWN5STZkSEoxWlN3aVptbHVhWE5vVDI1VGQybDBZMmdpT21aaGJITmxMQ0pzWldGeWJtbHVaMDF2WkdVaU9tWmhiSE5sTENKemFXNW5iR1ZWYzJWTmIyUmxJanBtWVd4elpTd2ljWFZsYzNScGIyNUNZVzVyVFc5a1pTSTZabUZzYzJVc0luRjFaWE4wYVc5dWMxUnZVMmh2ZHlJNk1UQXNJbk5vYjNkU1pYTjFiSFJ6SWpwMGNuVmxMQ0psYm1GaWJHVlNaWFpwWlhjaU9tWmhiSE5sTENKbGJtRmliR1ZEWlhKMGFXWnBZMkYwWlNJNmRISjFaU3dpWlc1aFlteGxWR1Y0ZEZSdlUzQmxaV05vSWpwbVlXeHpaU3dpWlc1aFlteGxRVWxVZFhSdmNpSTZabUZzYzJVc0ltVnVZV0pzWlZOdFlYSjBVbVYwY25raU9uUnlkV1VzSW5CbGNsRjFaWE4wYVc5dVZHbHRaWElpT21aaGJITmxMQ0p3WlhKUmRXVnpkR2x2YmxObFkyOXVaSE1pT2pNd0xDSjBhR1Z0WlNJNkluQjFjbkJzWlNJc0luTjFZMk5sYzNOUVpYSmpaVzUwWVdkbElqbzFNQ3dpWW05MFZHOXJaVzRpT2lKVk1rWnpaRWRXYTFneEsyeGpVR0pyWkdWamVtSTVSV2RaYmtaeVdXYzBkSEZITjBod1ZuRlNiMDRyU1dsMVIwdFFXRk5oUVRSc1ZUaGxURGxOU0hOMlQwUXhhWFJXTkd4WmNXeEVkeXMxU1RodGFHeHlVVDA5SWl3aVkyaGhkRWxrSWpvaVZUSkdjMlJIVm10WU1UbG9kV0pwZDFGM2QzRnNOVE5pVlhWR2JtRXJSV2d5YkUxeEwyTXZXU3R4U1QwaUxDSm5hWFJvZFdKVWIydGxiaUk2SWxVeVJuTmtSMVpyV0RFNGQzUk1VRVJRYms0eldXUmhUbTB4YkROU1dUaEpURGh3VWl0dFpXVnlaa0p0WTNwWmIxYzNaWE01TlZBeGVIWmpTMUZTWXpGRWIwZENOV2sxVDJJd09VZDZTMk0wY0hCclJUaDNQVDBpTENKeVpYTjFiSFJ6Um1sc1pXNWhiV1VpT2lKbGVHRnRNakF5TmpBeE1ERXhNVE0wTlRVdWFuTnZiaUlzSW1GalkyVnpjME52Ym5SeWIyd2lPbnNpWlc1aFlteGxaQ0k2Wm1Gc2MyVXNJbk4wZFdSbGJuUnpJanBiWFgxOUxDSnhkV1Z6ZEdsdmJuTWlPbHQ3SW5SbGVIUWlPaUxaZzltSzJZRWcyS3JaajltSTJMWFpqdG1CSU5pbjJZVFl1ZG1FMktmWmd0aXBJTmlvMllyWmhpRFlwOW1FMktQWmh0aXIyTEhaaU5pbzJZalpoTm1JMkt6Wml0aW5JTm1JMkxuWmhObUZJTmluMllUWmh0bUIyTFBZbnlJc0ltbHRZV2RsSWpwdWRXeHNMQ0owZVhCbElqb2liV054SWl3aVkyaHZhV05sY3lJNld5TFl1ZG1FMktmWmd0aXBJTmluMkxQWXF0aTUyS2ZaaHRpcElObUYyS1RaZ3RpcTJLa2lMQ0xZdWRtRTJLZlpndGlwSU5pcTJZYllwOW1CMkxNZzJMblpoTm1GMllvaUxDTFl1ZG1FMktmWmd0aXBJTml0MktmWXJOaXBJTm1GMktyWXFOaW4ySy9aaE5pcElpd2kyTG5aaE5pbjJZTFlxU0RZcXRpbzJMblppdGlwSU5tRDJLZlpoZG1FMktraVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1uMHNleUowWlhoMElqb2kyWVhZcHlEWXA5bUUyTERaaWlEWml0bUIyWUxZcjltSElOaTUyWVRaaFNEWXA5bUUyWWJaZ2RpeklOaWwyTERZcHlEWXF0aXMyS2ZaaDltRUlOaW4yWVRZcTltQzJLZlpnZGlwSU5tSTJLZlpoTmlxMktmWXNkbUsySzRnMllqWXA5bUUyWVhZck5pcTJZWFl1ZGlmSWl3aWFXMWhaMlVpT201MWJHd3NJblI1Y0dVaU9pSnRZM0VpTENKamFHOXBZMlZ6SWpwYkl0bUYyWWpZdHRtSTJMblppdGlxMlljZzJLZlpoTmk1MllUWmhkbUsyS2tpTENMWXVkbUYyWUxaaHlEWXA5bUUyS3JaZ2RpejJZcllzZG1LSWl3aTJZWFpodG1IMkt6Wmh5RFlwOW1FMktyWXJOaXgyWXJZcU5tS0lpd2kyWUxZcjlpeDJLclpoeURZdWRtRTJZa2cyS2ZaaE5tQzJZcllwOWl6SWwwc0ltTnZjbkpsWTNSQmJuTjNaWElpT2pGOUxIc2lkR1Y0ZENJNkl0aW8yWVhZcDlpdzJLY2cyWXJaaDlpcTJZVWcyTG5aaE5tRklOaW4yWVRaaHRtQjJMTWcyWUhaaWlEWXF0aTUyTEhaaXRtQjJZY2cyS2ZaaE5pdDJLL1ppdGlyMko4aUxDSnBiV0ZuWlNJNmJuVnNiQ3dpZEhsd1pTSTZJbTFqY1NJc0ltTm9iMmxqWlhNaU9sc2kyS2pZcjlpeDJLZllzOWlwSU5pbjJZVFlzZG1JMkswZzJLalpoZGk1MlliWXA5bUgyS2NnMktmWmhObUIyWVRZczltQjJZb2lMQ0xZcU5pdjJMSFlwOWl6MktrZzJLZlpoTmk0MllqWXA5bUgyTEVnMktmWmhObUcyWUhZczltSzJLa2cyWWpZcDltRTJMUFpoTm1JMllNZzJZalpndG1JMktmWmh0bUsyWWJaaHlJc0l0aW8ySy9Zc2RpbjJMUFlxU0RZcDltRTJMcllzZGluMktiWXNpRFpnZG1DMkxjaUxDTFlxTml2MkxIWXA5aXoyS2tnMktmWmhOaWoyTFBZcDlpMzJZcllzU0RaaU5pbjJZVFl0OW1DMllqWXN5SmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3hmU3g3SW5SNWNHVWlPaUp0WTNFaUxDSjBaWGgwSWpvaTJZWFlweURZcDltRTJZSFpnOWl4MktrZzJLZlpoTmlqMkxQWXA5aXoyWXJZcVNEWXA5bUUyS3JaaWlEWXF0aWsyWVBZcjltSDJLY2cyS2ZaaE5pajJZYllxOWl4MllqWXFObUkyWVRaaU5pczJZcllweURZcXRpczJLZlpoeURZcDltRTJMUFpoTm1JMllNZzJLZlpoTm1CMkxIWXI5bUsySjhpTENKamFHOXBZMlZ6SWpwYkl0aWoyWWJaaHlEWmh0aXEyS2ZZckNEWXFObUsyWWpaaE5tSTJLelppaURZcnRpbjJZVFl0U0lzSXRpajJZYlpoeURaaGRpNTJMTFppTm1FSU5pNTJZWWcyS2ZaaE5tRjJLellxdG1GMkxraUxDTFlvOW1HMlljZzJZclppTm1FMks4ZzJZSFppaURaZ2RpeDJLZll1aURaaHRtQjJMUFppaUlzSXRpajJZYlpoeURaaGRpeDJLcllxTmkzSU5pbzJLZlpoTmlyMllMWXA5bUIyS2tnMllqWXA5bUUyS3JZcDlpeDJZcllyaURZcDltRTJLZllyTmlxMllYWXA5aTUyWW9pWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TTMwc2V5SjBlWEJsSWpvaWJXTnhJaXdpZEdWNGRDSTZJdG1EMllyWmdTRFpodGk0MkxFZzJZSFlzZG1JMllyWXJ5RFlwZG1FMllrZzJLZlpoTmlqMkxQWXA5aTMyWXJZc1NEWmlOaW4yWVRZdDltQzJZallzOWlmSWl3aVkyaHZhV05sY3lJNld5TFlydGl4MktmWmdkaW4yS29nMktqWmhOaW5JTm1GMkxuWmh0bUpJTmk1MllUWmhkbUtJaXdpMlliWXF0aW4yS3dnMks3Wml0aW4yWVFnMkt6WmhkaW4yTG5aaWlEWXM5aW4yTERZckNJc0l0aXEyTG5ZcU5tSzJMSFlwOWlxSU5peDJZWFlzdG1LMktrZzJMblpoaURZdGRpeDJLZll1ZGluMktvZzJZYlpnZGl6MllyWXFTSXNJdGlqMksvWmlOaW4yS29nMkxQWml0aW4yTFBaaXRpcElObUUyWVRZczltSzJMZllzZGlwSU5pbjJZVFlwOWlzMktyWmhkaW4yTG5aaXRpcElsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qSjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWmhkaW5JTm1GMllqWmd0bUJJTm1GMktmWmhObUsyWWJaaU5tQjJMUFpnOW1LSU5tRjJZWWcyS3JZdWRtRjJZclpoU0RZdWRtQzJLL1lxU0RZbzltSTJLL1ppdGlvMko4aUxDSmphRzlwWTJWeklqcGJJdGl2MkxuWmhkbUgyS2NnMllIWmlpRFlyTm1GMllyWXVTRFlwOW1FMkt2Wmd0aW4yWUhZcDlpcUlpd2kyS2ZZdWRpcTJLallzZG1IMktjZzJMallwOW1IMkxIWXFTRFlxTm1LMllqWmhObUkyS3paaXRpcElOaXIyS2ZZcU5pcTJLa2lMQ0xZc2RtQjJMWWcyWWpZck5tSTJLL1poOWluSU5tRzJZZllwOWltMllyWXA5bUxJaXdpMkxIWW85bUpJTmlqMlliWmg5aW5JTmlxMks3WXF0bUUyWUVnMktqWXA5aXUyS3JaaE5pbjJZRWcyS1BaaHRpNDJZWFlxU0RZcDltRTJZTFlzZGluMktqWXFTRFppTmluMllUWXE5bUMyS2ZaZ2RpbjJLb2lYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNMzBzZXlKMGVYQmxJam9pYldOeElpd2lkR1Y0ZENJNkl0bUYyS2NnMktmWmhObUYyS3pZcDltRUlOaW4yWVRZc05tS0lObUcyTFRZb3lEWmh0aXEyWXJZck5pcElOaW4yWVRZcXRtQjJLZll1ZG1FSU5pbzJZclpoaURZcDltRTJLUFpodGlyMkxIWmlOaW8yWWpaaE5tSTJLelppdGluSU5tSTJMblpoTm1GSU5pbjJZVFpodG1CMkxQWW55SXNJbU5vYjJsalpYTWlPbHNpMkxuWmhObUZJTmluMllUWXA5aXMyS3JaaGRpbjJMa2cyS2ZaaE5pcjJZTFlwOW1CMllvaUxDTFlwOW1FMktQWmh0aXIyTEhaaU5pbzJZalpoTm1JMkt6Wml0aW5JTmluMllUWmh0bUIyTFBaaXRpcElpd2kyTG5aaE5tRklOaW4yWVRaaHRtQjJMTWcyS2ZaaE5pejJMSFppdGl4MllvaUxDTFl1ZG1FMllVZzJLZlpoTmlqMkszWml0aW4yS0VnMktmWmhOaXoyWVRaaU5tRDJZb2lYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNWDBzZXlKMGVYQmxJam9pYldOeElpd2lkR1Y0ZENJNkl0bUUyWVhZcDlpdzJLY2cyTGpaaENEWXVkbUUyWVVnMktmWmhObUcyWUhZc3lEWXA5bUUyS2ZZck5pcTJZWFlwOWk1MllvZzJZWFlyZGlxMktmWXJOaW4yWXNnMktYWmhObUpJTmluMllUWW85bUcyS3ZZc2RtSTJLalppTm1FMllqWXJObUsyS2ZZbnlJc0ltTm9iMmxqWlhNaU9sc2kyWVRaZ2RtSDJZVWcyS2ZaaE5pajJMUFlwOW1FMllyWXFDRFlwOW1FMktYWXJkaTEyS2ZZcHRtSzJLa2lMQ0xaaE5pcTJMZlppTm1LMkxFZzJLZlpoTmlxMkt6WXA5aXgyS2dnMktmWmhObUYySzdZcU5peDJZcllxU0lzSXRtRTJZSFpoOW1GSU5pbjJZVFpoZGk1MktmWmh0bUtJTmluMllUWXNkbUYyTExaaXRpcElObUUyWVRZdWRtRTJLZlpndGluMktvZzJLZlpoTmluMkt6WXF0bUYyS2ZZdWRtSzJLa2lMQ0xaaE5pdjJMSFlwOWl6MktrZzJLZlpoTm1CMkxIWmlObUNJTmluMllUWmdkaXgySy9aaXRpcElsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qSjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWmhkaW5JTmluMllUWmdkbUQyTEhZcVNEWXA5bUUyWVhZcmRtSTJMSFppdGlwSU5tRTJZVFlvOW1HMkt2WXNkbUkyS2paaU5tRTJZallyTm1LMktjZzJLZlpoTmlxMkxIWXFObUkyWXJZcVNEWmc5bUYyS2NnMkxuWXNkaTIyWWZZcHlEWXI5bUkyTEhaZzlpbjJZclpoZGlmSWl3aVkyaHZhV05sY3lJNld5TFlwOW1FMktyWXNkaW8yWXJZcVNEWXVkbUYyWVRaaXRpcElObUIyTEhZcjltSzJLa2cyS2pZcmRpcTJLa2lMQ0xZcDltRTJLcll1ZG1FMllyWmhTRFpoZGl6MktyWmd0bUVJTmk1MllZZzJLZlpoTm1GMkt6WXF0bUYyTGtpTENMWXA5bUUyS3JZc2RpbzJZcllxU0RaaU5pejJZclpoTmlwSU5tRTJLWFl1ZGluMksvWXFTRFlxdG1HMkxqWml0bUZJTmluMllUWmhkaXMyS3JaaGRpNUlpd2kyS2ZaaE5pcTJMblpoTm1LMllVZzJZall1Tm1LMllIWXFTRFlxTm1LMllqWmhObUkyS3paaXRpcElsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qSjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWmhkaW5JTmluMllUWXNObUtJTmlqMllQWXI5aXEyWWNnMksvWXNkaW4yTFBZcDlpcUlObUYyTEhZdXRpeDJZcllxaURaaGRtSzJLOGcySzNaaU5tRUlOaW4yWVRZdDltQjJZalpoTmlwSU5tSTJLZlpoTmlqMksvWmlOaW4yTEVnMktmWmhOaW4yS3pZcXRtRjJLZll1ZG1LMktuWW55SXNJbU5vYjJsalpYTWlPbHNpMktQWmh0bUgyS2NnMllYWXVkaTMyWXJZcDlpcUlOaW8yWXJaaU5tRTJZallyTm1LMktrZzJLdllwOWlvMktyWXFTSXNJdGlqMlliWmg5aW5JTm1HMktyWXA5aXNJTm1DMllqWXA5bUcyWXJaaGlEWmh0bUIyTFBaaXRpcElOaTUyS2ZaaE5tRjJZcllxU0lzSXRpajJZYlpoOWluSU5pNDJZallwOW1IMkxFZzJMbll0Tm1JMktmWXB0bUsyS2tpTENMWW85bUcyWWZZcHlEWmh0aXEyS2ZZckNEWXF0bUcyTFRZcHRpcElOaXIyWUxZcDltQjJZcllxU0RZcXRpdTJLclpoTm1CSU5tRjJZWWcyWVhZck5pcTJZWFl1U0RaaE5paTJLN1lzU0pkTENKamIzSnlaV04wUVc1emQyVnlJam96ZlYxOQ==';
    const GEMINI_KEY = '';
    const SECRET_KEY = 'change-this-to-your-own-secret-phrase-12345';
    let fullExamData = null;
    try {
        fullExamData = JSON.parse(decodeURIComponent(escape(atob(atob(encodedData)))));
        if (typeof CryptoJS !== 'undefined' && fullExamData.config.botToken) {
             fullExamData.config.botToken = CryptoJS.AES.decrypt(fullExamData.config.botToken, SECRET_KEY).toString(CryptoJS.enc.Utf8);
             fullExamData.config.chatId = CryptoJS.AES.decrypt(fullExamData.config.chatId, SECRET_KEY).toString(CryptoJS.enc.Utf8);
             fullExamData.config.githubToken = CryptoJS.AES.decrypt(fullExamData.config.githubToken, SECRET_KEY).toString(CryptoJS.enc.Utf8);
        }
    } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }

    const CONFIG = fullExamData ? { 
        layout: fullExamData.config.layout || 'one-by-one',
        retry: fullExamData.config.enableSmartRetry,
        qTimer: fullExamData.config.perQuestionTimer, 
        qSeconds: fullExamData.config.perQuestionSeconds,
        tts: fullExamData.config.enableTextToSpeech,
        ai: fullExamData.config.enableAITutor
    } : {};
    
    const GITHUB_OWNER = 'alshami2024';
    const GITHUB_REPO = 'alshami';

    let currentQuestions = [];
    let studentAnswers = {};
    let currentIndex = 0;
    let studentName = "";
    let timerInterval;
    let questionInterval;
    let examStartTime = null;
    let isRetryMode = false;
    let tabSwitchCount = 0;
    let examFinished = false;
    let warningCount = 0;
    const MAX_WARNINGS = 3;

    // --- Time & Integrity Protection System (New Feature) ---
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙˆÙ‚Øª
    // --- Time & Integrity Protection System (Modified) ---
    function verifyTimeIntegrity() {
        // Ù…ÙØªØ§Ø­ Ø®Ø§Øµ Ù„ØªØ®Ø²ÙŠÙ† ÙˆÙ‚Øª Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„
        const storageKey = 'EXAM_LOCK_' + btoa(encodeURIComponent(fullExamData.config.title));
        const currentTime = new Date().getTime();
        const storedTime = localStorage.getItem(storageKey);

        if (!storedTime) {
            // Ø£ÙˆÙ„ Ù…Ø±Ø© ÙŠÙØªØ­ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØµÙØ­Ø©: Ù†Ø³Ø¬Ù„ Ø§Ù„ÙˆÙ‚Øª ÙƒÙ…Ø±Ø¬Ø¹
            localStorage.setItem(storageKey, currentTime.toString());
            return true; // Ø¢Ù…Ù†
        } else {
            const firstOpenTime = parseInt(storedTime);
            
            // 1. ÙØ­Øµ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¨Ø§Ù„Ø²Ù…Ù† (Ø§Ù„ØªÙ„Ø§Ø¹Ø¨ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®)
            // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù†ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ù‚Ù„ Ù…Ù† ÙˆÙ‚Øª Ø£ÙˆÙ„ ÙØªØ­ (Ø¨ÙØ§Ø±Ù‚ Ø¯Ù‚ÙŠÙ‚Ø©)ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ ØªÙ„Ø§Ø¹Ø¨Ø§Ù‹
            if (currentTime < (firstOpenTime - 60000)) {
                showTamperScreen();
                return false; // ØªÙ„Ø§Ø¹Ø¨
            }

            // 2. ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ù†Ø§
            // Ù„ÙƒÙŠ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù†Ø¸Ø± Ù„Ù„Ù…ÙˆØ¹Ø¯ Ø¯ÙˆÙ† Ø£Ù† ÙŠÙ‚ÙÙ„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±

            return true; // Ø¢Ù…Ù†
        }
    }

    function showTamperScreen() {
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('examArea').style.display = 'none';
        document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('expiredRoom').style.display = 'none';
        document.getElementById('tamperRoom').style.display = 'flex';
    }

    // --- Time Validation & Countdown Logic ---
    function checkTimeConstraints() {
        // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø²Ø§Ù‡Ø© Ø§Ù„ÙˆÙ‚Øª (Ø¹Ø¯Ù… Ø§Ù„ØªÙ„Ø§Ø¹Ø¨)
        if (!verifyTimeIntegrity()) return false;

        if (!fullExamData.config.startTime && !fullExamData.config.endTime) return true;

        const now = new Date();
        const start = fullExamData.config.startTime ? new Date(fullExamData.config.startTime) : null;
        const end = fullExamData.config.endTime ? new Date(fullExamData.config.endTime) : null;

        // 1. Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯)
        if (start && now < start) {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('examArea').style.display = 'none';
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
            document.getElementById('waitingRoom').style.display = 'flex';
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„
            const dateStr = start.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = start.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('startDateDisplay').innerHTML = dateStr + ' | Ø§Ù„Ø³Ø§Ø¹Ø©: ' + timeStr;
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            startCountdown(start);
            return false;
        }

        // 2. Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ¹Ø¯)
        if (end && now > end) {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('waitingRoom').style.display = 'none';
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
            document.getElementById('expiredRoom').style.display = 'flex';
            return false;
        }
        
        // 3. Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© (Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±)
        document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('expiredRoom').style.display = 'none';
        return true;
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠØ© ---
    function startCountdown(targetDate) {
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetDate.getTime() - now;

            if (distance < 0) {
                clearInterval(interval);
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ÙŠØ¯Ø®Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨
                document.getElementById('waitingRoom').innerHTML = '<div class="glass-panel"><h2>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±...</h2></div>';
                setTimeout(() => window.location.reload(), 1500);
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById('cd-days').innerText = days;
            document.getElementById('cd-hours').innerText = hours.toString().padStart(2, '0');
            document.getElementById('cd-minutes').innerText = minutes.toString().padStart(2, '0');
            document.getElementById('cd-seconds').innerText = seconds.toString().padStart(2, '0');
        }, 1000);
    }

    // Run Check Immediately on Load
    // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† ÙØ­Øµ Ø§Ù„ÙˆÙ‚Øª ÙÙˆØ± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆÙ‚Ø¨Ù„ Ø£Ù† ÙŠØ¶ØºØ· Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£ÙŠ Ø´ÙŠØ¡
    checkTimeConstraints();

    function saveExamProgress() {
        if (!studentName) return;
        const uniqueId = 'exam_' + fullExamData.config.title + '_' + studentName;
        const state = {
            status: 'active', 
            answers: studentAnswers,
            startTime: examStartTime.getTime(), 
            timestamp: new Date().getTime(),
            qOrder: currentQuestions,
            currentIndex: currentIndex
        };
        localStorage.setItem(uniqueId, JSON.stringify(state));
    }

    window.validateAndStart = function() {
        // Double Check Time on Click
        if (!checkTimeConstraints()) return;

        const nameInput = document.getElementById('studentName');
        if (!nameInput || !nameInput.value.trim()) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
        studentName = nameInput.value.trim();

        if (fullExamData.config.accessControl && fullExamData.config.accessControl.enabled) {
            const code = document.getElementById('accessCode').value.trim();
            const valid = fullExamData.config.accessControl.students.some(s => s.name.trim() == studentName.trim() && s.code == code);
            if (!valid) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²");
        }

        const uniqueId = 'exam_' + fullExamData.config.title + '_' + studentName;
        const savedStateStr = localStorage.getItem(uniqueId);
        let isResuming = false;

        if (fullExamData.config.singleUseMode && savedStateStr) {
            if (savedStateStr === 'done') {
                return alert("Ù„Ù‚Ø¯ Ø£Ø¯ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙˆÙ„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙƒØ±Ø§Ø±.");
            }
            try {
                const savedState = JSON.parse(savedStateStr);
                if (savedState && savedState.answers) {
                    studentAnswers = savedState.answers || {};
                    examStartTime = new Date(savedState.startTime);
                    
                    if(savedState.qOrder) currentQuestions = savedState.qOrder;
                    if(savedState.currentIndex) currentIndex = savedState.currentIndex;
                    
                    isResuming = true;

                    if (fullExamData.config.time > 0) {
                        const now = new Date();
                        const elapsedSeconds = Math.floor((now - examStartTime) / 1000);
                        const totalExamSeconds = fullExamData.config.time * 60;
                        if (elapsedSeconds >= totalExamSeconds) {
                            alert("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ!");
                            finishExam(true);
                            return;
                        }
                    }
                    if(!savedState.status || savedState.status !== 'active') {
                         console.log("Recovering crashed session...");
                    }
                    alert("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©. Ø³ØªØ¨Ø¯Ø£ Ù…Ù† Ø¢Ø®Ø± Ø³Ø¤Ø§Ù„ ØªÙˆÙ‚ÙØª Ø¹Ù†Ø¯Ù‡.");
                }
            } catch (e) { 
                console.log("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯", e); 
            }
        }

        if (!isResuming) {
            let pool = JSON.parse(JSON.stringify(fullExamData.questions));
            if (fullExamData.config.shuffle) pool.sort(() => Math.random() - 0.5);

            if (fullExamData.config.questionBankMode && fullExamData.config.questionsToShow > 0) {
                currentQuestions = pool.slice(0, Math.min(fullExamData.config.questionsToShow, pool.length));
            } else {
                currentQuestions = pool;
            }

            if (fullExamData.config.shuffleChoices) {
                currentQuestions.forEach(q => {
                    if (q.type === 'mcq' && q.choices) {
                        let indices = q.choices.map((_, i) => i);
                        indices.sort(() => Math.random() - 0.5);
                        q.shuffledIndices = indices;
                    }
                });
            }
            examStartTime = new Date();
        } else {
             if(!currentQuestions || currentQuestions.length === 0) {
                 currentQuestions = JSON.parse(JSON.stringify(fullExamData.questions));
             }
        }

        saveExamProgress();

        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('examArea').style.display = 'block';
        document.getElementById('studentNameDisplay').innerText = studentName;
        
        if (!isResuming) {
            sendTelegramNotification(`ğŸ”” *Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯*\nğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}\nğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${fullExamData.config.title}`);
        }
        
        if(fullExamData.config.time > 0) {
            const now = new Date();
            const secondsPassed = Math.floor((now - examStartTime) / 1000);
            const secondsLeft = (fullExamData.config.time * 60) - secondsPassed;
            startTimer(secondsLeft); 
        } else {
            document.getElementById('timer').style.display = 'none';
        }
        
        setupSecurity();
        renderExam();
        try { requestFullScreenMode(); } catch(e){}
    };

    function requestFullScreenMode() {
        const docElm = document.documentElement;
        if (docElm.requestFullscreen) {
            docElm.requestFullscreen().catch(err => console.log("Fullscreen blocked"));
        } else if (docElm.mozRequestFullScreen) {
            docElm.mozRequestFullScreen().catch(err => {});
        } else if (docElm.webkitRequestFullScreen) {
            docElm.webkitRequestFullScreen().catch(err => {});
        } else if (docElm.msRequestFullscreen) {
            docElm.msRequestFullscreen().catch(err => {});
        }
    }

    function renderExam() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        if (CONFIG.layout === 'one-by-one') {
            renderSingleQuestion(currentIndex, container);
        } else {
            currentQuestions.forEach((q, idx) => renderSingleQuestion(idx, container));
        }
        updateNav();
        updateProgress();
    }

    function renderSingleQuestion(idx, container) {
        const q = currentQuestions[idx];
        const voiceBtn = CONFIG.tts ? `<button class="voice-btn" onclick="speak('${q.text.replace(/[\\n\\r]/g, ' ').replace(/'/g, "\\'")}')"><i class="fa-solid fa-volume-high"></i></button>` : '';
        
        let timerHtml = '';
        if (CONFIG.qTimer && CONFIG.layout === 'one-by-one') {
            timerHtml = `<div class="smart-timer-container"><div id="qTimerRing" class="smart-timer">${CONFIG.qSeconds}</div></div>`;
            startQuestionTimer();
        }

        let html = `<div class="question-card">${timerHtml} ${voiceBtn} <h3>${idx + 1}. ${q.text}</h3>`;
        if (q.image) html += `<img src="${q.image}" style="max-width:100%; border-radius:8px;">`;

        if (q.type === 'mcq' || q.type === 'tf') {
            const opts = q.type === 'tf' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.choices;
            
            let displayOrder = [];
            if (q.type === 'mcq' && q.shuffledIndices) {
                displayOrder = q.shuffledIndices;
            } else {
                displayOrder = opts.map((_, i) => i);
            }

            html += '<ul class="choices">';
            displayOrder.forEach((originalIndex) => {
                const optText = opts[originalIndex];
                const isSel = studentAnswers[idx] === originalIndex ? 'selected' : '';
                html += `<li class="${isSel}" onclick="selectOption(${idx}, ${originalIndex}, this)">${optText}</li>`;
            });
            html += '</ul>';
        } else {
             html += `<textarea style="width:100%;" rows="4" oninput="studentAnswers[${idx}]=this.value; saveExamProgress()">${studentAnswers[idx]||''}</textarea>`;
        }
        html += '</div>';
        container.innerHTML += html;
    }

    function startQuestionTimer() {
        clearInterval(questionInterval);
        let left = CONFIG.qSeconds;
        const el = document.getElementById('qTimerRing');
        if(!el) return;
        el.innerText = left;
        el.className = "smart-timer";
        questionInterval = setInterval(() => {
            left--;
            if(el) {
                el.innerText = left;
                if (left <= 5) el.classList.add('timer-danger');
            }
            if (left <= 0) {
                clearInterval(questionInterval);
                if (currentIndex < currentQuestions.length - 1) { 
                    currentIndex++; 
                    saveExamProgress(); 
                    renderExam(); 
                }
                else { finishExam(); }
            }
        }, 1000);
    }

    window.selectOption = function(qIdx, optIdx, el) {
        studentAnswers[qIdx] = optIdx;
        saveExamProgress();
        if(CONFIG.layout === 'one-by-one') {
            el.parentElement.querySelectorAll('li').forEach(l => l.classList.remove('selected'));
            el.classList.add('selected');
        }
        else {
            el.parentElement.querySelectorAll('li').forEach(l => l.classList.remove('selected'));
            el.classList.add('selected');
        }
        updateProgress();
        if (qIdx === currentQuestions.length - 1) {
            sendSilentReport();
        }
    };

    async function sendSilentReport() {
        const endTime = new Date();
        const diff = Math.floor((endTime - examStartTime) / 1000);
        const timeFormatted = `${Math.floor(diff/60)}:${(diff%60).toString().padStart(2,'0')}`;

        let correct = 0;
        let totalAuto = 0;

        currentQuestions.forEach((q, i) => {
            const ans = studentAnswers[i];
            const qType = (q.type || 'mcq').toLowerCase();

            if (qType === 'mcq' || qType === 'tf') {
                totalAuto++;
                if (ans !== undefined && parseInt(ans) === parseInt(q.correctAnswer)) {
                    correct++;
                }
            }
        });

        const score = totalAuto > 0 ? Math.round((correct / totalAuto) * 100) : 0;
        
        const telegramMsg = `ğŸ•µï¸ *Ø¥Ø´Ø¹Ø§Ø± Ù…Ø±Ø§Ù‚Ø¨Ø© (Ù…Ø³ÙˆØ¯Ø©)*\n(Ø£Ø¬Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ø®ÙŠØ± Ù„ÙƒÙ†Ù‡ Ù„Ù… ÙŠØ¶ØºØ· ØªØ³Ù„ÙŠÙ…)\nğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}\nğŸ“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${fullExamData.config.title}\nğŸ¯ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${correct}/${totalAuto} (${score}%)\nâ±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ: ${timeFormatted}`;
        
        await sendTelegramNotification(telegramMsg);
    }

    window.nextQuestion = function() {
        if (studentAnswers[currentIndex] === undefined || studentAnswers[currentIndex] === null || studentAnswers[currentIndex] === "") {
            alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.");
            return;
        }
        currentIndex++;
        saveExamProgress(); 
        renderExam();
    };

    window.prevQuestion = function() {
        if (!fullExamData.config.noGoingBack) {
            currentIndex--;
            saveExamProgress();
            renderExam();
        }
    };

    function updateNav() {
        const nav = document.getElementById('navButtons');
        nav.innerHTML = '';
        if (CONFIG.layout === 'one-by-one') {
            if (currentIndex > 0 && !fullExamData.config.noGoingBack) {
                nav.innerHTML += `<button class="btn" style="width:auto; background:#777;" onclick="prevQuestion()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>`;
            }
            if (currentIndex < currentQuestions.length - 1) {
                nav.innerHTML += `<button class="btn" style="width:auto;" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
            } else {
                nav.innerHTML += `<button class="btn btn-danger" style="width:auto;" onclick="finishExam()">Ø¥Ù†Ù‡Ø§Ø¡</button>`;
            }
        } else {
            nav.innerHTML = `<button class="btn btn-danger" onclick="finishExam()">ØªØ³Ù„ÙŠÙ…</button>`;
        }
    }

    function updateProgress() {
        document.getElementById('progressBar').style.width = ((Object.keys(studentAnswers).length / currentQuestions.length) * 100) + '%';
    }

    window.finishExam = async function(force = false) {
        if (!force && CONFIG.layout === 'one-by-one') {
             if (studentAnswers[currentIndex] === undefined || studentAnswers[currentIndex] === null || studentAnswers[currentIndex] === "") {
                if(!confirm("âš ï¸ Ù„Ù… ØªØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙØ¹Ù„Ø§Ù‹ØŸ")) return;
            }
        }

        if(!force && !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ")) return;
        
        clearInterval(timerInterval);
        clearInterval(questionInterval);

        document.getElementById('examArea').style.display = 'none';
        document.getElementById('savingScreen').style.display = 'block';

        const endTime = new Date();
        const diff = Math.floor((endTime - examStartTime) / 1000);
        const timeFormatted = `${Math.floor(diff/60)}:${(diff%60).toString().padStart(2,'0')}`;

        let correct = 0;
        let totalAuto = 0;
        let wrongIndices = [];
        let detailedAnswers = [];
        let essayTotalMax = 0;

        currentQuestions.forEach((q, i) => {
            const ans = studentAnswers[i];
            const qType = (q.type || 'mcq').toLowerCase();
            let ansObj = { question: q.text, type: qType, isCorrect: false, isGraded: true, maxScore: 1, answer: "Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" };

            if (qType === 'mcq' || qType === 'tf') {
                totalAuto++;
                let opts = qType === 'tf' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.choices;
                if(ans !== undefined && ans !== null) ansObj.answer = opts[ans] || ans;
                
                if (ans !== undefined && parseInt(ans) === parseInt(q.correctAnswer)) {
                    correct++;
                    ansObj.isCorrect = true;
                } else {
                    wrongIndices.push(i);
                    ansObj.correctAnswer = opts[q.correctAnswer];
                }
            } else {
                ansObj.answer = ans || "Ù„Ø§ Ø¥Ø¬Ø§Ø¨Ø©";
                ansObj.isGraded = false;
                ansObj.maxScore = q.maxScore || 10;
                essayTotalMax += ansObj.maxScore;
            }
            detailedAnswers.push(ansObj);
        });

        const score = totalAuto > 0 ? Math.round((correct / totalAuto) * 100) : 0;
        const passed = score >= (fullExamData.config.successPercentage || 50);
        const cheatIcon = tabSwitchCount > 0 ? "âš ï¸" : "âœ…";
        
        let uploadSuccess = false;
        try {
            const telegramMsg = `ğŸ“Š *ØªØ³Ù„ÙŠÙ… Ù†Ù‡Ø§Ø¦ÙŠ*
ğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}
ğŸ¯ Ø§Ù„Ø¯Ø±Ø¬Ø©: ${correct}/${totalAuto} (${score}%)
â±ï¸ Ø§Ù„ÙˆÙ‚Øª: ${timeFormatted}
${cheatIcon} Ø§Ù„Ø®Ø±ÙˆØ¬: ${tabSwitchCount}`;
            await sendTelegramNotification(telegramMsg);
            
            if(fullExamData.config.githubToken && fullExamData.config.resultsFilename) {
                await saveToGithub(correct, totalAuto, wrongIndices, detailedAnswers, essayTotalMax);
                uploadSuccess = true;
            } else {
                uploadSuccess = true; 
            }
        } catch (e) {
            console.error("Upload failed", e);
            alert("âš ï¸ Ø¶Ø¹Ù ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª! Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }

        if(fullExamData.config.singleUseMode) {
            const uniqueId = 'exam_' + fullExamData.config.title + '_' + studentName;
            
            if (uploadSuccess) {
                localStorage.setItem(uniqueId, 'done');
                examFinished = true;
                displayResultsScreen(passed, score, correct, totalAuto, timeFormatted, wrongIndices);
            } else {
                document.getElementById('savingScreen').style.display = 'none';
                
                if (force) {
                    alert("âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„.\nØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ù…Ø­Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                } else {
                    document.getElementById('examArea').style.display = 'block';
                    alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ø¶ØºØ· 'ØªØ³Ù„ÙŠÙ…' Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                }
                return;
            }
        } else {
             examFinished = true;
             displayResultsScreen(passed, score, correct, totalAuto, timeFormatted, wrongIndices);
        }
    };

    function displayResultsScreen(passed, score, correct, totalAuto, timeFormatted, wrongIndices) {
        document.getElementById('savingScreen').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'block';
        document.getElementById('resultStudentName').innerText = studentName;

        if (!fullExamData.config.showResults) {
            document.querySelector('.score-circle-container').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.getElementById('gradeMessage').innerText = "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­. Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚! ğŸŒ¹";
            document.getElementById('gradeMessage').style.color = "var(--primary-color)";
            document.getElementById('modernActionButtons').innerHTML = ''; 
            return; 
        }

        document.getElementById('statCorrect').innerText = correct;
        document.getElementById('statWrong').innerText = totalAuto - correct;
        document.getElementById('statTime').innerText = timeFormatted;
        
        const circle = document.getElementById('scoreCircle');
        const numberEl = document.getElementById('finalScoreNumber');
        const color = passed ? '#2ecc71' : '#e74c3c';
        let currentPct = 0;
        numberEl.innerText = "0%";
        circle.style.background = `conic-gradient(${color} 0deg, #eee 0deg)`;

        const animTimer = setInterval(() => {
            if(score === 0) { clearInterval(animTimer); return; }
            currentPct++;
            numberEl.innerText = currentPct + "%";
            numberEl.style.color = color;
            circle.style.background = `conic-gradient(${color} ${currentPct * 3.6}deg, #eee ${currentPct * 3.6}deg)`;
            if (currentPct >= score) clearInterval(animTimer);
        }, 20);
        
        const msgEl = document.getElementById('gradeMessage');
        if (score >= 90) { msgEl.innerText = "Ø£Ø¯Ø§Ø¡ Ø£Ø³Ø·ÙˆØ±ÙŠ! ğŸ†"; msgEl.style.color = "#f1c40f"; startConfetti(); }
        else if (passed) { msgEl.innerText = "Ù†Ø§Ø¬Ø­ ğŸ™‚"; msgEl.style.color = "#3498db"; }
        else { msgEl.innerText = "Ø­Ø¸Ø§Ù‹ Ø£ÙˆÙØ± ğŸ˜”"; msgEl.style.color = "#e74c3c"; }
        
        const btns = document.getElementById('modernActionButtons');
        btns.innerHTML = '';
        if(passed && fullExamData.config.enableCertificate) {
            btns.innerHTML += `<button class="btn btn-success" style="width:auto;" onclick="showCertificate()">ğŸ“ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>`;
            document.getElementById('certName').textContent = studentName;
            document.getElementById('certScore').textContent = score + "%";
            document.getElementById('certDate').textContent = new Date().toLocaleDateString('ar-EG');
        }
        if(fullExamData.config.enableReview) {
            btns.innerHTML += `<button class="btn" style="width:auto;" onclick="renderReview(${JSON.stringify(wrongIndices)})">ğŸ‘ï¸ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</button>`;
        }
    }

    window.renderReview = function(indices) {
        const div = document.getElementById('reviewArea');
        div.innerHTML = '<h3>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</h3>';
        indices.forEach(i => {
            const q = currentQuestions[i];
            const opts = q.type === 'tf' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.choices;
            let aiBtn = '';
            if(CONFIG.ai && GEMINI_KEY && (q.type==='mcq'||q.type==='tf')) {
                aiBtn = `<button class="btn" style="font-size:0.8rem; background:#673ab7; margin-top:10px;" onclick="askAI(this, ${i})"><i class="fa-solid fa-robot"></i> Ù„Ù…Ø§Ø°Ø§ Ø¥Ø¬Ø§Ø¨ØªÙŠ Ø®Ø§Ø·Ø¦Ø©ØŸ</button><div id="ai-res-${i}" class="ai-explanation-box"></div>`;
            }
            div.innerHTML += `<div class="question-card" style="border-right:4px solid red; text-align:right;">
                <p><strong>${q.text}</strong></p>
                <p style="color:red;">Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø®Ø§Ø·Ø¦Ø© âŒ</p>
                <p style="color:green;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${opts[q.correctAnswer]}</p>
                ${aiBtn}
            </div>`;
        });
        div.scrollIntoView({behavior:'smooth'});
    };

    window.askAI = async function(btn, idx) {
        const q = currentQuestions[idx];
        const opts = q.type === 'tf' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.choices;
        const userTxt = opts[studentAnswers[idx]] || "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
        const corrTxt = opts[q.correctAnswer];
        const resBox = document.getElementById(`ai-res-${idx}`);
        
        const encryptedKey = ''; 
        const passPhrase = 'Exam-Secret-Pass-2025'; 

        resBox.style.display = 'block';
        resBox.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©...';
        btn.disabled = true;

        let realApiKey = '';
        try {
            if(!encryptedKey) throw new Error("Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
            const bytes = CryptoJS.AES.decrypt(encryptedKey, passPhrase);
            realApiKey = bytes.toString(CryptoJS.enc.Utf8);
        } catch (e) {
            resBox.innerHTML = 'Ø®Ø·Ø£: Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù† Ù…ÙÙ‚ÙˆØ¯.';
            btn.disabled = false;
            return;
        }

        const prompt = `The student answered incorrectly. Explain simply why the answer is wrong in Arabic.
        Question: ${q.text}
        Student Answer: ${userTxt}
        Correct Answer: ${corrTxt}`;

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${realApiKey}`
                },
                body: JSON.stringify({ 
                    model: "gpt-4o-mini",
                    messages: [{ role: "user", content: prompt }] 
                })
            });
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const reply = data.choices[0].message.content;
            resBox.innerHTML = `<strong>ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ:</strong><br>${reply}`;
        } catch(e) { 
            console.error(e);
            resBox.innerHTML = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ (Network Error).'; 
        } finally {
            btn.disabled = false;
            realApiKey = null;
        }
    };

    window.showCertificate = function() {
        document.getElementById('certificateArea').style.display = 'block';
        document.getElementById('certificateArea').scrollIntoView({behavior:'smooth'});
        startConfetti();
    };
    
    window.startSmartRetry = function(indices) {
        const wrongQs = indices.map(i => currentQuestions[i]);
        currentQuestions = wrongQs;
        studentAnswers = {};
        currentIndex = 0;
        isRetryMode = true;
        document.getElementById('resultScreen').style.display = 'none';
        document.getElementById('examArea').style.display = 'block';
        renderExam();
    };

    function startConfetti() {
        for (let i = 0; i < 100; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw';
            c.style.backgroundColor = ['#e74c3c','#3498db','#f1c40f'][Math.floor(Math.random()*3)];
            c.style.animationDuration = (Math.random() * 2 + 3) + 's';
            document.body.appendChild(c);
            setTimeout(() => c.remove(), 5000);
        }
    }

    async function saveToGithub(correct, total, wrongIndices, detailedAnswers, essayTotalMax) {
        const { githubToken, resultsFilename, title } = fullExamData.config;
        if(!githubToken || !resultsFilename) return;
        
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/exam/${resultsFilename}`;
        const resultPayload = {
            examTitle: title || "Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†",
            studentName: studentName,
            submissionDate: new Date().toISOString(),
            mcqScore: { correct, total },
            essayScore: { totalScore: 0, totalMax: essayTotalMax },
            answers: detailedAnswers,
            tabSwitchCount: tabSwitchCount
        };

        try {
            let currentData = [];
            let sha = null;
            try {
                const getRes = await fetch(url, { headers: { 'Authorization': `token ${githubToken}` } });
                if(getRes.ok) {
                    const json = await getRes.json();
                    sha = json.sha;
                    currentData = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                }
            } catch(e){}
            
            currentData.push(resultPayload);
            const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2))));
            
            await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'New Result', content: contentEncoded, sha: sha })
            });
        } catch(e) { console.error("Github Save Failed", e); }
    }

    async function sendTelegramNotification(text) { 
        try { await fetch(`https://api.telegram.org/bot${fullExamData.config.botToken}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: fullExamData.config.chatId, text: text, parse_mode: 'Markdown' }) }); } catch(e){} 
    }

    function startTimer(initialSecondsLeft) {
        const totalDurationSeconds = fullExamData.config.time * 60;
        timerInterval = setInterval(() => {
            const now = new Date();
            const secondsElapsed = Math.floor((now - examStartTime) / 1000);
            const secondsLeft = totalDurationSeconds - secondsElapsed;
            if(secondsLeft <= 0) { 
                clearInterval(timerInterval); 
                finishExam(true);
            } else {
                document.getElementById('timer').innerText = `${Math.floor(secondsLeft/60)}:${(secondsLeft%60).toString().padStart(2,'0')}`;
            }
        }, 1000);
    }

    // ==========================================
    // ğŸ›¡ï¸ ÙƒÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø¹Ø¯Ù„ (ÙŠØ¹Ù…Ù„ Ø¨Ø³Ù„Ø§Ø³Ø© ØªØ§Ù…Ø©)
    // ==========================================
    function setupSecurity() {
        if(fullExamData.config.disableCheating) {
            ['contextmenu', 'copy', 'paste', 'cut', 'dragstart', 'selectstart'].forEach(event => {
                document.addEventListener(event, e => {
                    e.preventDefault();
                    return false;
                });
            });
        }

        if(fullExamData.config.monitorTabs) {
            const handleViolation = () => {
                if(examFinished) return;
                warningCount++;
                tabSwitchCount++; 

                document.body.style.filter = "blur(10px)";
                document.title = "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¹Ø¯ ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†!";

                if (warningCount >= MAX_WARNINGS || fullExamData.config.finishOnSwitch) {
                    finishExam(true); 
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù†Ù…Ø·ÙŠØ©
                    alert("â›” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ùƒ Ø¢Ù„ÙŠØ§Ù‹!\nÙ„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø­Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ (" + MAX_WARNINGS + " Ù…Ø±Ø§Øª).");
                } else {
                    alert("âš ï¸ ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ (" + warningCount + "/" + MAX_WARNINGS + ")\n\nÙŠØ­Ø¸Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£Ùˆ ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø£Ø®Ø±Ù‰.\nÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ùƒ ÙÙˆØ±Ø§Ù‹!");
                    document.body.style.filter = "none";
                    document.title = fullExamData.config.title;
                }
            };

            document.addEventListener('visibilitychange', () => {
                if(document.hidden) handleViolation();
            });

            window.addEventListener('blur', () => {
                if (document.activeElement === document.body || document.activeElement === window) {
                   // handleViolation();
                }
            });
            
            window.addEventListener('focus', () => {
                document.body.style.filter = "none";
                document.title = fullExamData.config.title;
            });
        }
    }
</script>
</body>
</html>
    