
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تدريبات الإضافة والمصدر (4) </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #0056b3; --secondary-color: #007bff; --light-gray: #f8f9fa; --dark-gray: #343a40; --success-color: #28a745; --danger-color: #dc3545; --background-color: #e9ecef; --text-color: #212529; --white: #fff; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--background-color); margin: 0; padding: 20px; color: var(--text-color); direction: rtl; }
        .container { background-color: var(--white); border-radius: 15px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); width: 95%; max-width: 900px; margin: 0 auto; padding: 30px; }
        h1, h2, h3 { color: var(--dark-gray); font-weight: 700; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input[type="text"], .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { background-color: var(--primary-color); color: var(--white); border: none; padding: 12px 25px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .btn:hover { background-color: #004a99; } .btn:disabled { background-color: #ccc; }
        .btn-danger { background-color: var(--danger-color); }
        .exam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .timer { font-size: 1.2em; color: var(--danger-color); font-weight: bold; }
        .question-card { background: var(--light-gray); border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: right; }
        .question-card ul { list-style: none; padding: 0; }
        .choices li { padding: 10px; margin: 8px 0; background: var(--white); border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .choices li:hover { background-color: #e3f2fd; }
        .choices li.correct { background-color: #d4edda !important; border-color: #c3e6cb; }
        .choices li.incorrect { background-color: #f8d7da !important; border-color: #f5c6cb; }
        .essay-answer { width: 100%; min-height: 120px; resize: vertical; margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #navigation-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        #progressBarContainer { width: 100%; background-color: #e9ecef; border-radius: 20px; margin-bottom: 25px; overflow: hidden; }
        #progressBar { width: 0%; height: 20px; background-color: var(--success-color); border-radius: 20px; transition: width 0.5s; text-align: center; color: white; line-height: 20px; }
        #certificate { display: none; border: 5px solid var(--primary-color); padding: 30px; margin-top: 30px; text-align: center; background: linear-gradient(135deg, #f9f9f9, #eef8ff); }
        #startScreen, #examArea, #resultContainer { display: none; }
        
    </style>
</head>
<body>
<div class="container">
    <div id="studentExamView" style="display:block;">
        <div id="startScreen" style="display:block;">
            <h1 id="examTitleStudent"></h1>
            <p id="examDescriptionStudent" style="white-space: pre-wrap;"></p>
            
        <div class="form-group">
            <label for="studentName">أدخل اسمك الكامل</label>
            <input type="text" id="studentName" placeholder="الاسم الكامل">
        </div>
        
        <div class="form-group">
            <label for="accessCode">أدخل رمز الدخول</label>
            <input type="text" id="accessCode" placeholder="رمز الدخول">
        </div>
    
            <button id="startExamBtn" class="btn">بدء الاختبار</button>
        </div>
        <div id="examArea">
            <div class="exam-header"><h2 id="welcomeStudent"></h2><div id="timer" class="timer"></div></div>
            <div id="progressBarContainer"><div id="progressBar"></div></div>
            <div id="questionsContainer"></div>
            <div id="navigation-buttons"></div>
            <button id="finishExamBtn" class="btn btn-danger" style="margin-top: 20px; width:100%;">إنهاء وتسليم الاختبار</button>
        </div>
        <div id="resultContainer">
             <h2 id="resultTitle"></h2><p id="resultSummary"></p>
             <div id="reviewContainer"></div>
             <div id="certificate">
                <h2>شهادة إتمام</h2><p>تشهد هذه الشهادة بأن الطالب/ة:</p><h3 id="certName"></h3>
                <p>قد أتم الاختبار بنجاح وحصل/ت على درجة:</p><h3 id="certScore"></h3>
                <p>بتاريخ: <span id="certDate"></span></p>
            </div>
        </div>
    </div>
</div>
<script>
    const encodedExamData = 'ZXlKamIyNW1hV2NpT25zaWRHbDBiR1VpT2lMWXF0aXYyTEhaaXRpbzJLZllxaURZcDltRTJLWFl0dGluMllIWXFTRFppTmluMllUWmhkaTEySy9Zc1NBb05Da2dJaXdpWkdWelkzSnBjSFJwYjI0aU9pTFpndGl6MllVZzJLZlpoTm1FMkxyWXFTRFlwOW1FMkxuWXNkaW8yWXJZcVNEWXA5bUUyWVhZczlpcTJZalppU0RZcDltRTJLdllwOW1FMkt0Y2J0bUcySzNaaURRaUxDSnpkR0Z5ZEZScGJXVWlPaUl5TURJMUxUQTRMVEl5VkRJeE9qTXdJaXdpWlc1a1ZHbHRaU0k2SWpJd01qVXRNRGd0TWpoVU1qTTZOVGtpTENKc1lYbHZkWFFpT2lKdmJtVXRZbmt0YjI1bElpd2lkR2x0WlNJNk5qQXNJbk5vZFdabWJHVWlPblJ5ZFdVc0ltNXZSMjlwYm1kQ1lXTnJJanAwY25WbExDSmthWE5oWW14bFEyaGxZWFJwYm1jaU9uUnlkV1VzSW0xdmJtbDBiM0pVWVdKeklqcDBjblZsTENKbWFXNXBjMmhQYmxOM2FYUmphQ0k2Wm1Gc2MyVXNJbXhsWVhKdWFXNW5UVzlrWlNJNlptRnNjMlVzSW5OcGJtZHNaVlZ6WlUxdlpHVWlPblJ5ZFdVc0luTm9iM2RTWlhOMWJIUnpJanAwY25WbExDSmxibUZpYkdWU1pYWnBaWGNpT25SeWRXVXNJbVZ1WVdKc1pVTmxjblJwWm1sallYUmxJanAwY25WbExDSjBhR1Z0WlNJNkltUmxabUYxYkhRaUxDSnpkV05qWlhOelVHVnlZMlZ1ZEdGblpTSTZOVEFzSW1KdmRGUnZhMlZ1SWpvaVZUSkdjMlJIVm10WU1UaDZVa3BVT0ROR2JYWTFNRU51V1ZWTU9VZFhXSEJTYWtWT2NrdHVhWFpCUVVGTWVuaDNSMHcwVVZoU1VuZHVhMnBETWpKRFptNUVWbVJyV0ZNeldtUnNLM0l5ZGpoalduTlBaR2M5UFNJc0ltTm9ZWFJKWkNJNklsVXlSbk5rUjFacldERXZMMjAzYlRkb1NHVlFOWFpsY210a0szaFRUa1EzZVVONlpIZHdiVUkzWm5jOUlpd2laMmwwYUhWaVZHOXJaVzRpT2lKVk1rWnpaRWRXYTFneEt6UTFjelJ2WW1oM2EzbGxUVUo0ZWpKV1oxcDRjR2wyUzFwaE1uY3ZiRWNyV1U5SWJUUnFSR2x3WkhkS2VuRXdiWFZWY1ZoQ1ZXUkRjVE5LU0VsNFZXUXJZbEpRU3pNdlIySktkejA5SWl3aWNtVnpkV3gwYzBacGJHVnVZVzFsSWpvaWNtVnpkV3gwY3k1cWMyOXVJaXdpWVdOalpYTnpRMjl1ZEhKdmJDSTZleUpsYm1GaWJHVmtJanAwY25WbExDSnpkSFZrWlc1MGN5STZXM3NpYm1GdFpTSTZJdGlqMkxUWmlOaW4yWUlnMktQWXJkbUYySzhnMkszWXM5bUsyWVlpTENKamIyUmxJam9pT1RReE56RTRJbjBzZXlKdVlXMWxJam9pMktQWmhOaTMyS2ZaZ1NEWml0aXQyWXJaaVNEWXA5bUUyTExaZ3RpeDJZb2lMQ0pqYjJSbElqb2lPVFk0TkRZMUluMHNleUp1WVcxbElqb2kyS1BaaGRtRUlOaTUyS2pZcjlpbjJZVFpoTm1ISU5pbjJZVFpoZGl0MllMWmh0bUtJaXdpWTI5a1pTSTZJakV4TXpRek1DSjlMSHNpYm1GdFpTSTZJdGlsMllyWmh0aW4yTE1nMkxYWXA5bUUySzBnMktmWmhOaTIyS2paaXRpNUlpd2lZMjlrWlNJNklqVTNNRFkxTnlKOUxIc2libUZ0WlNJNkl0aXgyTHJZcnlEWW85aXQyWVhZcnlEWXA5bUUyTFhaaXRpbjJLL1ppaUlzSW1OdlpHVWlPaUk0TWpJNU1URWlmU3g3SW01aGJXVWlPaUxZdGRpbjJLallzZG1LMllZZzJZWFlyZGl6MllZZzJLZlpoTml4MllMWml0bUYyWW9pTENKamIyUmxJam9pT1RjNU1EUTFJbjBzZXlKdVlXMWxJam9pMkxYWXFObUsySzNZcVNEWXVkbUUyWW9nMktmWmhOaTAyWVhZcDlpdDJZb2lMQ0pqYjJSbElqb2lPRFk0TkRjeEluMHNleUp1WVcxbElqb2kyTG5ZcDlpbTJLL1lxU0RaaHRpbjJMWFlzU0RZcDltRTJZYllyTmluMkxFaUxDSmpiMlJsSWpvaU5EazNOakF4SW4wc2V5SnVZVzFsSWpvaTJZTFppdGl6SU5pejJMbllyeURZcDltRTJLallyOW1JMllvaUxDSmpiMlJsSWpvaU56Z3dOalk0SW4wc2V5SnVZVzFsSWpvaTJZWFlzZGluMllVZzJMWFlwOW1FMkswZzJLZlpoTm1HMllYWXN5SXNJbU52WkdVaU9pSXlOelE0TWpVaWZTeDdJbTVoYldVaU9pTFpoZGl6MktyWmlOaXgyS2tnMktQWmhkbUsyWVlnMkxuWXFOaXZJTmluMllUWXNkaXQyWXJaaFNJc0ltTnZaR1VpT2lJM05EUTFPRFlpZlN4N0ltNWhiV1VpT2lMWml0aW4yTFBaaGRtSzJZWWcyS1BZcmRtRjJLOGcyTFBaaE5pbjJZVWlMQ0pqYjJSbElqb2lPRFl4TXpRd0luMHNleUp1WVcxbElqb2kyWXJZczlpeDJZa2cyWXJZcDlpejJMRWcyS2ZaaE5pMDJMcllyOWl4MllvaUxDSmpiMlJsSWpvaU56Z3dOVEV5SW4xZGZYMHNJbkYxWlhOMGFXOXVjeUk2VzNzaWRIbHdaU0k2SW0xamNTSXNJblJsZUhRaU9pTFpoZGluSU5pdjJZUWcyTG5aaE5tSklOaXQySy9ZcXlEWmhkbUMyS3JZc2RtR0lOaW8yTExaaGRtR0lObUgyWWdpTENKamFHOXBZMlZ6SWpwYkl0aW4yWVRaaGRpMTJLL1lzU0lzSXRpbjJMUFpoU0RZcDltRTJZWFl0ZGl2MkxFaUxDTFlwOW1FMllIWXVkbUVJaXdpMktmWmhObUIyS2ZZdWRtRUlsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qSjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWml0aTUyWVhaaENEWXA5bUUyWVhZdGRpdjJMRWcyS2pZcXRtQzJLL1ppdGl4SUNqWmhkaW5LU0RaaU5pbjJZVFpnZGk1MllUWWpDRFlwZGl3MktjZzJLUFlzZG1LMks4ZzJLalpoeUlzSW1Ob2IybGpaWE1pT2xzaTJLZlpoTml0MktmWmhDSXNJdGluMllUWmhkaXoyS3JaZ3RpbzJZUWlMQ0xZcDltRTJZWFlwOWkyMllvaUxDTFpoTmluSU5pMDJZcllvU0RaaGRtRjJLY2cyTFBZcU5tQ0lsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qQjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWmd0aW4yWVFnMktmWmhOaTAyS2ZZdWRpeE9seHUyTGJaaXRpNTJZSFpqeURZcDltRTJZYlpnOWluMllyWXFkbVFJTmlqMkxuWXI5aW4yS0haaHk0dUxpQmNidG1LMks3WXA5bUVJTmluMllUWmdkaXgyS2ZZc1NEWml0aXgyS2ZZcnRtS0lOaW4yWVRZbzlpczJZUXVJRnh1WEc3Wmh0bUkyTGtnMktmWmhObUYyTFhZcjlpeElObUIyWW9nMktmWmhOaW8yWXJZcWlEWXA5bUUyTFBZcDlpbzJZSWlMQ0pqYUc5cFkyVnpJanBiSXRtRjJMWFlyOWl4SU5tRjJZYlppTm1HSWl3aTJZWFl0ZGl2MkxFZzJZWFl0dGluMllFaUxDTFpoZGkxMksvWXNTRFpoZGl0MllUWmlTRFlxTmlqMllRaUxDTFpoTmluSU5pMDJZcllvU0RaaGRtRjJLY2cyTFBZcU5tQ0lsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qSjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWmd0aW4yWVFnMktyWXVkaW4yWVRaaVRvZ0tObUkyWVRaaU5tRTJLY2cySy9aZ2RpNUlOaW4yWVRaaE5tSElOaW4yWVRaaHRpbjJMTWcyS2pZdWRpMjJZZlpoU0RZcU5pbzJMbll0aURaaE5tQjJMUFlyOWlxSU5pbjJZVFlvOWl4MkxZcElGeHUyS1hZdWRpeDJLZllxQ0RaZzltRTJZWFlxU0FvMktmWmhObUcyS2ZZc3lraUxDSmphRzlwWTJWeklqcGJJdG1GMkxiWXA5bUJJTmlsMllUWml0bUhJTm1GMkt6WXNkbUkyTEVnMllUWmdkaTQyS2NnMllYWmh0aTEyWWpZcUNEWmhkaXQyWVRZcDltTElpd2kyWVhZdHRpbjJZRWcyS1haaE5tSzJZY2cyWVhZck5peDJZallzU0lzSXRtQjJLZll1ZG1FSU5tRjJMSFpnZG1JMkxraUxDTFpoZG1CMkxuWmlObUVJTmlvMlljZzJZWFpodGkxMllqWXFDSmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3pmU3g3SW5SNWNHVWlPaUp0WTNFaUxDSjBaWGgwSWpvaTJZWFpoaURZcmRtQ0lOaW4yWVRaaGRpejJZVFpoU0RZdWRtRTJZa2cyS2ZaaE5tRjJMUFpoTm1GSU5pbDJLellwOWlvMktyWmh5RFlwOW1FMksvWXVkbUkyS25ZakNEWmlOaW4yWVRZczltRTJLZlpoU0RZdWRtRTJZclpoeTRnWEc3WXA5aXoyS3JZcnRpeDJLd2dLTmluMkxQWmhTRFpoZGkxMksvWXNTa2cyWVhaaGlEWXA5bUUyS3paaGRtRTJLa2lMQ0pqYUc5cFkyVnpJanBiSXRpdDJZSWlMQ0xZcGRpczJLZllxTmlxMlljaUxDTFlwOW1FMkxQWmhOaW4yWVVpTENMWmhOaW5JTm1LMllqWXJOaXZJbDBzSW1OdmNuSmxZM1JCYm5OM1pYSWlPako5TEhzaWRIbHdaU0k2SW0xamNTSXNJblJsZUhRaU9pTFlzOWl4MlliWmlpRFlwZGlxMllMWXA5bUdJTml6MkxuWXA5aXZJTm1JMllIWXA5aTMyWVhZcVNEWXBkaTUyTEhZcDlpb0lOaW4yWVRZck5tRjJZVFlxUzRnWEc1Y2J0aW4yWVRZdHRpbzJMY2cyS2ZaaE5pMTJLM1ppdGl0SU5tRTJZUFpoTm1GMktrZzJZSFlwOWkzMllYWXFTSXNJbU5vYjJsalpYTWlPbHNpMkt6WmlOaW4yTElnMktmWmhOaXMyTEVnMllYWXNkaW4yTG5ZcDlpcElObUUyWVRaZ2RpNDJJd2cyWWpZck5tSTJLZllzaURZcDltRTJZYll0ZGlvSU5tRjJMSFlwOWk1MktmWXFTRFpoTm1FMllYWXJkbUVJaXdpMkt6WmlOaW4yTElnMktmWmhOaXMyTEVnMllYWXNkaW4yTG5ZcDlpcElObUUyWVRaZ2RpNDJJd2cyWWpZck5tSTJLZllzaURZcDltRTJMSFpnZGk1SU5tRjJMSFlwOWk1MktmWXFTRFpoTm1FMllYWXJkbUVJaXdpMllqWXJObUkyS2dnMktmWmhOaXMyTEVnMllIWmd0aTNJaXdpMllqWXJObUkyS2dnMktmWmhOaXgyWUhZdVNEWmdkbUMyTGNpWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TVgwc2V5SjBlWEJsSWpvaWJXTnhJaXdpZEdWNGRDSTZJdG1DMktmWmhDRFlxdGk1MktmWmhObUpPaUFvMllqWXA5bUUyWVRaaHlEWW85bUcyS2pZcXRtRDJZVWcyWVhaaGlEWXA5bUUyS1BZc2RpMklObUcyS2pZcDlpcTJLY3BJRnh1MllQWmhObUYyS2tnS05tRzJLallwOWlxMktjcElpd2lZMmh2YVdObGN5STZXeUxZcDlpejJZVWcyWUhZcDlpNTJZUWlMQ0xZdGRtSzJMcllxU0RaaGRpbzJLZlpoTmk2MktraUxDTFpoZGkxMksvWXNTSXNJdGluMkxQWmhTRFpoZGkxMksvWXNTSmRMQ0pqYjNKeVpXTjBRVzV6ZDJWeUlqb3pmU3g3SW5SNWNHVWlPaUp0WTNFaUxDSjBaWGgwSWpvaTJZTFlwOW1FSU5pcTJMbllwOW1FMllrNklDalpnZGlsMkxEWXB5RFpodG1QMllIWXJpRFpnZG1LSU5pbjJZVFl0ZG1JMkxFZzJZYlpnZGl1MktuWmpDRFppTmluMkszWXI5aXBLU0JjYnRpbDJMbllzZGluMktnZzJZUFpoTm1GMktrZ0tObUcyWUhZcnRpcEtTSXNJbU5vYjJsalpYTWlPbHNpMllIWXA5aTUyWVFpTENMWmh0aW4yS2JZcUNEWmdkaW4yTG5aaENJc0l0bUYyWUhZdWRtSTJZUWcyWVhZdDltRTJZSWlMQ0xaaGRtQjJMblppTm1FSU5pbzJZY2lYU3dpWTI5eWNtVmpkRUZ1YzNkbGNpSTZNWDBzZXlKMGVYQmxJam9pYldOeElpd2lkR1Y0ZENJNkl0bUMyS2ZaaENEWXF0aTUyS2ZaaE5tSk9pQW8yWWpaaHRtSTJLM1lweURaaDlpdjJZclpodGluSU5tRjJZWWcyWUxZcU5tRTJZOHBJRnh1MktYWXVkaXgyS2ZZcUNEWmc5bUUyWVhZcVNBbzJZTFlxTm1FS1NEWmdkbUtJTmluMllUWW90bUsyS2tpTENKamFHOXBZMlZ6SWpwYkl0aTQyTEhaZ1NEWXN0bUYyS2ZaaGlEWmhkbUcyTFhaaU5pb0lpd2kyS2ZZczltRklObUYyS3pZc2RtSTJMRWcyWWpZdWRtRTJLZlpoZGlwSU5pczJMSFpoeURZcDltRTJZUFlzOWl4MktraUxDTFl1Tml4MllFZzJMTFpoZGluMllZZzJZWFlxTm1HMllvZzJZSFppaURaaGRpdDJZUWcyS3pZc1NJc0l0aTQyTEhaZ1NEWXN0bUYyS2ZaaGlEWmhkaW8yWWJaaWlEWmdkbUtJTm1GMkszWmhDRFpodGkxMktnaVhTd2lZMjl5Y21WamRFRnVjM2RsY2lJNk1uMHNleUowZVhCbElqb2liV054SWl3aWRHVjRkQ0k2SXRpbjJZVFlwOWl6MllVZzJLZlpoTml3MllvZzJZclpoTmluMkxMWmhTRFlwOW1FMktYWXR0aW4yWUhZcVNEWXBkbUUyWWtnMktmWmhObUIyTG5aaENEWXA5bUUyWVhZcDlpMjJZb2cyWUhaZ3RpMzJJd2cyWWZaaUNJc0ltTm9iMmxqWlhNaU9sc2kySzNaaXRpcklpd2kyS1hZc05pbklpd2kyS1hZc0NJc0l0bUUyWVhZcHlKZExDSmpiM0p5WldOMFFXNXpkMlZ5SWpvemZTeDdJblI1Y0dVaU9pSnRZM0VpTENKMFpYaDBJam9pMktmWmhOaXMyWVhaaE5pcElOaW4yWVRZcXRtS0lOaW4yTFRZcXRtRjJZVFlxaURZdWRtRTJZa2cyS2ZZczltRklObUYyTFhZcjlpeElObUgyWW9pTENKamFHOXBZMlZ6SWpwYkl0bUYyS2NnMktQWXJObUYyWVFnMktyWmc5aXgyWXJaaFNEWXA5bUUyS3pZcDltRjJMbllxU0RZdDltRTJLZllxTm1IMktjaUxDTFlvOWk1Mkt6WXFObUcyWW9nMlliWXRkaXQyWU1nMktmWmhOaTMyWVRZcDlpb0lpd2kyWVBZcXRpbjJLallxU0RZcDltRTJMZllwOW1FMktnZzJZallwOWlzMktqWXA5aXEyWWNnMkxQWXNTRFpodGlzMktmWXJkbUhJbDBzSW1OdmNuSmxZM1JCYm5OM1pYSWlPakY5TEhzaWRIbHdaU0k2SW0xamNTSXNJblJsZUhRaU9pTFlwOW1FMkt6WmhkbUUyS2tnMktmWmhOaXEyWW9nMktmWXROaXEyWVhaaE5pcUlOaTUyWVRaaVNEWmhkaTEySy9Zc1NEWXV0bUsyTEVnMkxuWXA5bUYyWVFnMllmWmlpSXNJbU5vYjJsalpYTWlPbHNpMlliWXA5bUVJTmluMllUWXQ5aW4yWVRZcUNEWXA5bUUyS3pZcDlpbTJMTFlxU0RaaE5pdDJZSFl1Tm1ISU5pbjJZVFpndGl4MktMWmhpSXNJdGlqMkt6WXA5aW8yS29nMktQWmhkbUVJTmlsMkt6WXA5aW8yS2tnMllqWXA5bUIyWXJZcVNEWXA5bUUyS2ZaaGRpcTJLM1lwOW1HSWl3aTJZVFppTm1FMktjZzJZWFlzZGluMkt6WXVkaXEyWU1nMktmWmhObUYyWUxZc2RpeElObUUyWVhZcHlEWW85aXMyS2pZcWlEWXVkbUdJTmluMllUWW85aXoyS2JaaE5pcElsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qRjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWXA5bUUyS0xaaXRpcElOaW4yWVRZcXRtS0lOaW4yTFRZcXRtRjJZVFlxaURZdWRtRTJZa2cyWVBaaE5tRjJLa2dLTm1DMktqWmhDa2cyWVhZcU5tRzJZcllxU0RaaDltS0lpd2lZMmh2YVdObGN5STZXeUxaaU5pejJLallyU0RZcU5pdDJZWFlyeURZc2RpbzJZTWcyWUxZcU5tRUlOaTMyWVRaaU5pNUlOaW4yWVRZdE5tRjJMTWcyWWpaZ3RpbzJZUWcyS2ZaaE5pNjJMSFppTmlvSWl3aTJZallwZG1HSU5pMzJZVFpndGlxMllYWmlObUgyWVlnMllYWmhpRFpndGlvMllRZzJLUFpoaURZcXRtRjJMUFppTm1IMllZaUxDTFpoTm1FMlljZzJLZlpoTmlqMllYWXNTRFpoZG1HSU5tQzJLalpoQ0RaaU5tRjJZWWcyS2pZdWRpdklsMHNJbU52Y25KbFkzUkJibk4zWlhJaU9qSjlMSHNpZEhsd1pTSTZJbTFqY1NJc0luUmxlSFFpT2lMWXM5aXgyTEhZcWlEWXFObUYyTFBZcDlpNTJLL1lxU0RaaGRpdDJZWFlyeURZcDltRTJZUFlzZG1LMllVZzJLZlpoTm1CMllMWXNkaW4yS0V1SUZ4dVhHN1lwOW1FMkxiWXFOaTNJTmluMllUWXRkaXQyWXJZclNEWmhObUQyWVRaaGRpcElDallwOW1FMllQWXNkbUsyWVVwSWl3aVkyaHZhV05sY3lJNld5TFlwOW1FMllQWXM5aXhJTm1CMllMWXR5SXNJdGluMllUWmc5aXoyTEVnMllYWXNkaW4yTG5ZcDlpcElObUUyWVRaZ2RpNDJJd2cyWWpZcDltRTJMSFpnZGk1SU5tRjJMSFlwOWk1MktmWXFTRFpoTm1FMllYWXJkbUVJaXdpMktmWmhObUQyTFBZc1NEWmhkaXgyS2ZZdWRpbjJLa2cyWVRaaE5tQjJMallqQ0RaaU5pbjJZVFpodGkxMktnZzJZWFlzZGluMkxuWXA5aXBJTm1FMllUWmhkaXQyWVFpWFN3aVkyOXljbVZqZEVGdWMzZGxjaUk2TVgwc2V5SjBlWEJsSWpvaWJXTnhJaXdpZEdWNGRDSTZJdGluMllUWXBkaXoyWVRZcDltRklOaXYyWXJaaHRtS0xpQmNibHh1MllyWXJObUkyTElnMkxiWXFOaTNJTm1LMktmWW9TRFlwOW1FMllYWXF0bUQyWVRaaFNEWmdkbUtJTm1EMllUWmhkaXBJQ2pZcjltSzJZYlppaWtnMktqWXA5bUUyTFBaZzltSTJZWWcyWWpZcDltRTJZSFlxdGl0TGlJc0ltTm9iMmxqWlhNaU9sc2kyTFhZclNJc0l0aXUyTGZZb3lKZExDSmpiM0p5WldOMFFXNXpkMlZ5SWpvd2ZWMTk=';
    
    // START: DECRYPTION LOGIC
   
    const SECRET_KEY = 'change-this-to-your-own-secret-phrase-12345';
    
    
    const examData = JSON.parse(decodeURIComponent(escape(atob(atob(encodedExamData)))));

    
    try {
        if (examData.config.botToken) {
            const decryptedBytes = CryptoJS.AES.decrypt(examData.config.botToken, SECRET_KEY);
            examData.config.botToken = decryptedBytes.toString(CryptoJS.enc.Utf8);
        }
        if (examData.config.chatId) {
            const decryptedBytes = CryptoJS.AES.decrypt(examData.config.chatId, SECRET_KEY);
            examData.config.chatId = decryptedBytes.toString(CryptoJS.enc.Utf8);
        }
        if (examData.config.githubToken) {
            const decryptedBytes = CryptoJS.AES.decrypt(examData.config.githubToken, SECRET_KEY);
            examData.config.githubToken = decryptedBytes.toString(CryptoJS.enc.Utf8);
        }
    } catch (e) {
        console.error("Decryption failed! The secret key might be wrong or data is corrupt.", e);
    }
    // END: DECRYPTION LOGIC

    const GITHUB_OWNER = 'alshami2024';
    const GITHUB_REPO = 'alshami';

    let studentName = '', studentAnswers = new Array(examData.questions.length).fill(null), timerInterval, currentQuestionIndex = 0, tabSwitchCount = 0, examFinished = false;
    const startScreen = document.getElementById('startScreen'), examArea = document.getElementById('examArea'), resultContainer = document.getElementById('resultContainer');
    const accessControl = examData.config.accessControl || { enabled: false, students: [] };
    
    window.onload = function() {
        const uniqueExamId = `examStarted_${btoa(unescape(encodeURIComponent(examData.config.title)))}`;
        if (examData.config.singleUseMode && localStorage.getItem(uniqueExamId)) {
            document.body.innerHTML = `<div class="container" style="text-align:center;"><h1>تم قفل الاختبار</h1><p>لقد قمت ببدء هذا الاختبار بالفعل من هذا المتصفح. لا يمكنك إجراؤه مرة أخرى.</p></div>`;
            return;
        }

        const now = new Date();
        const startTime = examData.config.startTime ? new Date(examData.config.startTime) : null;
        const endTime = examData.config.endTime ? new Date(examData.config.endTime) : null;

        if (startTime && now < startTime) {
            document.getElementById('startScreen').innerHTML = `<h1>الاختبار غير متاح بعد</h1><p>سيكون الاختبار متاحًا في: ${startTime.toLocaleString('ar-EG')}</p>`;
            return;
        }

        if (endTime && now > endTime) {
            document.getElementById('startScreen').innerHTML = `<h1>انتهت فترة الاختبار</h1><p>لقد انتهت الفترة المحددة لإجراء هذا الاختبار.</p>`;
            return;
        }

        document.getElementById('examTitleStudent').textContent = examData.config.title;
        document.getElementById('examDescriptionStudent').textContent = examData.config.description;
        document.getElementById('startExamBtn').addEventListener('click', validateStudentAndStart);
    };
    
    function validateStudentAndStart() {
        const nameInput = document.getElementById('studentName').value.trim();
        if (!nameInput) {
            alert('الرجاء إدخال اسمك.');
            return;
        }

        if (accessControl.enabled) {
            const codeInput = document.getElementById('accessCode').value.trim();
            if (!codeInput) {
                alert('الرجاء إدخال رمز الدخول.');
                return;
            }
            const isValidStudent = accessControl.students.some(student => 
                student.name.trim().toLowerCase() === nameInput.toLowerCase() && student.code === codeInput
            );

            if (isValidStudent) {
                studentName = nameInput;
                startTheExam();
            } else {
                alert('الاسم أو رمز الدخول غير صحيح. يرجى المحاولة مرة أخرى.');
            }
        } else {
            studentName = nameInput;
            startTheExam();
        }
    }
    
    function startTheExam() {
        if (examData.config.singleUseMode) {
             const uniqueExamId = `examStarted_${btoa(unescape(encodeURIComponent(examData.config.title)))}`;
             localStorage.setItem(uniqueExamId, 'true');
        }
        sendStartNotificationToTelegram();
        startScreen.style.display = 'none'; examArea.style.display = 'block';
        document.getElementById('welcomeStudent').textContent = `بالتوفيق، ${studentName}!`;
        if (examData.config.time > 0) startTimer(examData.config.time * 60); else document.getElementById('timer').style.display = 'none';
        if (examData.config.shuffle) { examData.questions.sort(() => Math.random() - 0.5); }
        setupSmartFeatures(); renderQuestionsForStudent();
        document.getElementById('finishExamBtn').addEventListener('click', () => { if(confirm("هل أنت متأكد من رغبتك في إنهاء الاختبار؟")) finishTheExam(); });
    }
    
    function renderQuestionsForStudent(){const container=document.getElementById("questionsContainer");container.innerHTML="",examData.config.layout==="one-by-one"?(renderSingleQuestion(currentQuestionIndex),updateNavigationButtons()):examData.questions.forEach((e,t)=>container.appendChild(createQuestionElement(e,t))),updateProgressBar()}function createQuestionElement(e,t){const n=document.createElement("div");n.className="question-card",n.id=`question-${t}`;let o=`<h3>السؤال ${t+1}: ${e.text}</h3>`;if("mcq"===e.type){const i=e.choices.map((e,n)=>`<li onclick="handleChoiceClick(${t}, ${n}, this)"><input type="radio" name="q${t}" id="q${t}c${n}" value="${n}" ${studentAnswers[t]===n?"checked":""}><label for="q${t}c${n}">${e}</label></li>`).join("");o+=`<ul class="choices">${i}</ul>`}else{const s=studentAnswers[t]||"";o+=`<textarea class="essay-answer" oninput="handleEssayInput(${t}, this.value)" placeholder="اكتب إجابتك هنا...">${s}</textarea>`}return n.innerHTML=o,n}function handleChoiceClick(e,t,n){studentAnswers[e]=t,n.querySelector("input").checked=!0,examData.config.layout==="one-by-one"&&examData.config.learningMode&&"mcq"===examData.questions[e].type&&((n.classList.add(t===examData.questions[e].correctAnswer?"correct":"incorrect"),n.parentElement.querySelectorAll("li").forEach(e=>{e.style.pointerEvents="none"}))),updateProgressBar()}function handleEssayInput(e,t){studentAnswers[e]=t.trim(),updateProgressBar()}function renderSingleQuestion(e){document.getElementById("questionsContainer").appendChild(createQuestionElement(examData.questions[e],e))}function updateNavigationButtons(){const e=document.getElementById("navigation-buttons");if("one-by-one"!==examData.config.layout)return void(e.style.display="none");let t="";examData.config.noGoingBack||(t='<button id="prevBtn" class="btn">السابق</button>'),e.innerHTML=`${t}<button id="nextBtn" class="btn">التالي</button>`;const n=document.getElementById("nextBtn");n.disabled=currentQuestionIndex===examData.questions.length-1,n.addEventListener("click",()=>{currentQuestionIndex<examData.questions.length-1&&(currentQuestionIndex++,renderQuestionsForStudent())}),examData.config.noGoingBack||(document.getElementById("prevBtn").disabled=0===currentQuestionIndex,document.getElementById("prevBtn").addEventListener("click",()=>{currentQuestionIndex>0&&(currentQuestionIndex--,renderQuestionsForStudent())}))}function updateProgressBar(){const e=studentAnswers.filter(e=>null!==e&&""!==e).length,t=e/examData.questions.length*100,n=document.getElementById("progressBar");n.style.width=`${t}%`,n.textContent=`${Math.round(t)}%`}
    function setupSmartFeatures(){if(examData.config.disableCheating){["contextmenu","copy","paste"].forEach(evt=>document.body.addEventListener(evt,e=>e.preventDefault()))}if(examData.config.monitorTabs){document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden"&&!examFinished){tabSwitchCount++;if(examData.config.finishOnSwitch){alert("لقد خرجت من نافذة الاختبار، سيتم إنهاء الاختبار وإرسال نتيجتك الحالية.");finishTheExam()}}})}}
    async function finishTheExam(){if(examFinished)return;examFinished=!0;clearInterval(timerInterval);examArea.style.display="none";resultContainer.style.display="block";let e=0,t=0;if(examData.questions.forEach((n,o)=>{("mcq"===n.type&&(t++,studentAnswers[o]===n.correctAnswer&&e++))}),document.getElementById("resultTitle").textContent="تم الانتهاء من الامتحان!",examData.config.showResults){let n=`مرحباً ${studentName}، نتيجتك في أسئلة الاختيار من متعدد هي: <strong>${e} / ${t}</strong>`;examData.questions.some(e=>"essay"===e.type)&&(n+='<br><small>الأسئلة المقالية تتطلب تصحيحًا يدويًا وستظهر نتيجتها لاحقاً.</small>'),examData.config.monitorTabs&&tabSwitchCount>0&&(n+=`<br><small style="color:var(--danger-color);">تم تسجيل خروجك من الصفحة ${tabSwitchCount} مرات.</small>`),document.getElementById("resultSummary").innerHTML=n}else document.getElementById("resultSummary").textContent="شكراً لك، تم تسليم إجاباتك بنجاح.";examData.config.showResults&&examData.config.enableReview&&renderReview(),examData.config.enableCertificate&&t>0&&e/t*100>=examData.config.successPercentage&&renderCertificate(e,t),examData.config.botToken&&examData.config.chatId&&await sendResultsToTelegram(e,t); if(examData.config.githubToken && examData.config.resultsFilename){await saveResultsToGithub(e, t);}}
    function renderReview(){const e=document.getElementById("reviewContainer");e.innerHTML="<h3>مراجعة الإجابات:</h3>",examData.questions.forEach((t,n)=>{let o="";o="mcq"===t.type?`<div class="question-card" style="background:${studentAnswers[n]===t.correctAnswer?"#d4edda":"#f8d7da"};"><p><strong>${t.text}</strong></p><p>إجابتك: ${null!==studentAnswers[n]?t.choices[studentAnswers[n]]:"لم تتم الإجابة"} ${studentAnswers[n]===t.correctAnswer?"✔️":"❌"}</p>${studentAnswers[n]!==t.correctAnswer?`<p style="color:var(--primary-color);">الإجابة الصحيحة: ${t.choices[t.correctAnswer]}</p>`:""}</div>`:`<div class="question-card" style="background: #e9ecef;"><p><strong>(سؤال مقالي) ${t.text}</strong></p><p style="font-weight:bold;">إجابتك:</p><p style="white-space: pre-wrap; background: #fff; padding:10px; border-radius:5px;">${studentAnswers[n]?studentAnswers[n].replace(/</g,"&lt;").replace(/>/g,"&gt;"):"لم تتم الإجابة"}</p></div>`,e.innerHTML+=o})}function renderCertificate(e,t){const n=document.getElementById("certificate");n.style.display="block",document.getElementById("certName").textContent=studentName,document.getElementById("certScore").textContent=`${e} / ${t}`,document.getElementById("certDate").textContent=(new Date).toLocaleDateString("ar-EG")}function startTimer(e){let t=e;const n=document.getElementById("timer");timerInterval=setInterval(()=>{let e=parseInt(t/60,10),o=parseInt(t%60,10);e=e<10?"0"+e:e,o=o<10?"0"+o:o,n.textContent=`${e}:${o}`,--t<0&&(clearInterval(timerInterval),alert("انتهى الوقت!"),finishTheExam())},1e3)}async function sendResultsToTelegram(e,t){const{botToken:n,chatId:o,title:s}=examData.config;if(!n||!o)return;function i(e){return"string"!=typeof e?"":e.replace(/([_*[\]()~>#+\-=|{}.!])/g,"\\$1")}let a=`*📊 نتيجة اختبار جديدة*\n\n*الاختبار:* ${i(s)}\n*الطالب:* ${i(studentName)}\n*نتيجة الاختيار من متعدد:* ${e} من ${t}\n*مرات الخروج:* ${tabSwitchCount}`;let d="\n\n*الإجابات المقالية*",r=!1;examData.questions.forEach((e,t)=>{("essay"===e.type&&(r=!0,d+=`\n\n*❓ السؤال: ${i(e.text)}*\n*📝 إجابة الطالب:*\n${i(studentAnswers[t]||"لم تتم الإجابة")}`))}),r&&(a+=d);const c=`https://api.telegram.org/bot${n}/sendMessage`;try{a.length>4096&&(a=a.substring(0,4e3)+"\n\n... (تم اقتطاع الرسالة لأنها طويلة جداً)");const l=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:o,text:a,parse_mode:"MarkdownV2"})});l.ok||console.error("Telegram API Error:",await l.json())}catch(p){console.error("Fetch error or issue sending to Telegram:",p)}}async function sendStartNotificationToTelegram(){const{botToken:n,chatId:o,title:s}=examData.config;if(!n||!o)return;function i(e){return"string"!=typeof e?"":e.replace(/([_*[\]()~>#+\-=|{}.!])/g,"\\$1")}const a=`*🔔 بدء اختبار جديد*\n\n*الاختبار:* ${i(s)}\n*الطالب:* ${i(studentName)}`,c=`https://api.telegram.org/bot${n}/sendMessage`;try{const l=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:o,text:a,parse_mode:"MarkdownV2"})});l.ok||console.error("Telegram API Error (Start Notification):",await l.json())}catch(p){console.error("Fetch error sending start notification:",p)}}
    
    async function saveResultsToGithub(correctMcq, totalMcq) {
        const token = examData.config.githubToken;
        const filename = examData.config.resultsFilename;
        if (!token || !filename) { return; } 
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filename}`;

        const resultData = {
            studentName: studentName,
            submissionDate: new Date().toISOString(),
            mcqScore: { correct: correctMcq, total: totalMcq },
            tabSwitchCount: tabSwitchCount,
            answers: examData.questions.map((q, index) => {
                const studentAnswerRaw = studentAnswers[index];
                let studentAnswerText = studentAnswerRaw;
                let isCorrect = null;
                let correctAnswerText = null;

                if (q.type === 'mcq') {
                    isCorrect = (studentAnswerRaw === q.correctAnswer);
                    studentAnswerText = (studentAnswerRaw !== null) ? q.choices[studentAnswerRaw] : "لم تتم الإجابة";
                    if (!isCorrect) {
                        correctAnswerText = q.choices[q.correctAnswer];
                    }
                }

                return {
                    question: q.text,
                    answer: studentAnswerText,
                    isCorrect: isCorrect,
                    correctAnswer: correctAnswerText
                };
            })
        };

        try {
            let currentContent = [];
            let sha;
            try {
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                    currentContent = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                } else if (res.status !== 404) {
                    throw new Error(`GitHub API error on fetch: ${res.statusText}`);
                }
            } catch (fetchError) {
                console.warn("Could not fetch existing results file. A new one will be created.", fetchError);
            }
            
            currentContent.push(resultData);
            const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(currentContent, null, 2))));
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `إضافة نتيجة الطالب: ${studentName}`,
                    content: updatedContent,
                    sha: sha
                })
            });

            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(`Failed to save results: ${errorData.message}`);
            }
            console.log('Results saved to GitHub successfully.');
            document.getElementById("resultSummary").innerHTML += '<br><small style="color:green;">تم حفظ نتيجتك بنجاح.</small>';

        } catch (error) {
            console.error("Error saving results to GitHub:", error);
            document.getElementById("resultSummary").innerHTML += '<br><small style="color:red;">حدث خطأ أثناء محاولة حفظ نتيجتك.</small>';
        }
    }
</script>
</body>
</html>
